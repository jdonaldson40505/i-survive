!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).firebase,t.firebase.INTERNAL.modularAPIs)}(this,function(Qd,Wd){"use strict";try{!function(){function t(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var e=t(Qd);function n(n){const r=[];let s=0;for(let e=0;e<n.length;e++){let t=n.charCodeAt(e);t<128?r[s++]=t:(t<2048?r[s++]=t>>6|192:(55296==(64512&t)&&e+1<n.length&&56320==(64512&n.charCodeAt(e+1))?(t=65536+((1023&t)<<10)+(1023&n.charCodeAt(++e)),r[s++]=t>>18|240,r[s++]=t>>12&63|128):r[s++]=t>>12|224,r[s++]=t>>6&63|128),r[s++]=63&t|128)}return r}const r={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,t){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var s=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let n=0;n<r.length;n+=3){var o=r[n],a=n+1<r.length,h=a?r[n+1]:0,u=n+2<r.length,c=u?r[n+2]:0;let t=(15&h)<<2|c>>6,e=63&c;u||(e=64,a||(t=64)),i.push(s[o>>2],s[(3&o)<<4|h>>4],s[t],s[e])}return i.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(n(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,r=0;for(;n<t.length;){var s,i,o=t[n++];o<128?e[r++]=String.fromCharCode(o):191<o&&o<224?(s=t[n++],e[r++]=String.fromCharCode((31&o)<<6|63&s)):239<o&&o<365?(i=((7&o)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))):(s=t[n++],i=t[n++],e[r++]=String.fromCharCode((15&o)<<12|(63&s)<<6|63&i))}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let t=0;t<e.length;){var s=n[e.charAt(t++)],i=t<e.length?n[e.charAt(t)]:0;++t;var o=t<e.length?n[e.charAt(t)]:64;++t;var a=t<e.length?n[e.charAt(t)]:64;if(++t,null==s||null==i||null==o||null==a)throw Error();r.push(s<<2|i>>4),64!==o&&(r.push(i<<4&240|o>>2),64!==a&&r.push(o<<6&192|a))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},o=function(t){return function(t){t=n(t);return r.encodeByteArray(t,!0)}(t).replace(/\./g,"")};function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function s(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function f(t){return t&&t._delegate?t._delegate:t}var l,i=(a.prototype.setInstantiationMode=function(t){return this.instantiationMode=t,this},a.prototype.setMultipleInstances=function(t){return this.multipleInstances=t,this},a.prototype.setServiceProps=function(t){return this.serviceProps=t,this},a.prototype.setInstanceCreatedCallback=function(t){return this.onInstanceCreated=t,this},a);function a(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}(re=l=l||{})[re.DEBUG=0]="DEBUG",re[re.VERBOSE=1]="VERBOSE",re[re.INFO=2]="INFO",re[re.WARN=3]="WARN",re[re.ERROR=4]="ERROR",re[re.SILENT=5]="SILENT";const h={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},u=l.INFO,c={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},g=(t,e,...n)=>{if(!(e<t.logLevel)){var r=(new Date).toISOString(),s=c[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)}};var m,p="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},y={},w=p||self;function v(){}function b(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function T(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var E="closure_uid_"+(1e9*Math.random()>>>0),I=0;function _(t,e,n){return t.call.apply(t.bind,arguments)}function S(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function N(t,e,n){return(N=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?_:S).apply(null,arguments)}function A(e){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function D(t,i){function e(){}e.prototype=i.prototype,t.Z=i.prototype,t.prototype=new e,(t.prototype.constructor=t).Vb=function(t,e,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[e].apply(t,r)}}function C(){this.s=this.s,this.o=this.o}var x={};C.prototype.s=!1,C.prototype.na=function(){var t;!this.s&&(this.s=!0,this.M(),0)&&(t=this,t=Object.prototype.hasOwnProperty.call(t,E)&&t[E]||(t[E]=++I),delete x[t])},C.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const k=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(e,n){if("string"==typeof e)return"string"!=typeof n||1!=n.length?-1:e.indexOf(n,0);for(let t=0;t<e.length;t++)if(t in e&&e[t]===n)return t;return-1},R=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(e,n,r){var s=e.length,i="string"==typeof e?e.split(""):e;for(let t=0;t<s;t++)t in i&&n.call(r,i[t],t,e)};function L(){return Array.prototype.concat.apply([],arguments)}function O(e){var n=e.length;if(0<n){const r=Array(n);for(let t=0;t<n;t++)r[t]=e[t];return r}return[]}function M(t){return/^[\s\xa0]*$/.test(t)}var F,P=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function V(t,e){return-1!=t.indexOf(e)}function U(t,e){return t<e?-1:e<t?1:0}t:{var q=w.navigator;if(q){q=q.userAgent;if(q){F=q;break t}}F=""}function B(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function j(t){const e={};for(const n in t)e[n]=t[n];return e}var K="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function $(e){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t])e[n]=r[n];for(let t=0;t<K.length;t++)n=K[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function G(t){return G[" "](t),t}G[" "]=v;var z,H=V(F,"Opera"),Q=V(F,"Trident")||V(F,"MSIE"),W=V(F,"Edge"),Y=W||Q,J=V(F,"Gecko")&&!(V(F.toLowerCase(),"webkit")&&!V(F,"Edge"))&&!(V(F,"Trident")||V(F,"MSIE"))&&!V(F,"Edge"),X=V(F.toLowerCase(),"webkit")&&!V(F,"Edge");function Z(){var t=w.document;return t?t.documentMode:void 0}t:{var tt="",et=(et=F,J?/rv:([^\);]+)(\)|;)/.exec(et):W?/Edge\/([\d\.]+)/.exec(et):Q?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(et):X?/WebKit\/(\S+)/.exec(et):H?/(?:Version)[ \/]?(\S+)/.exec(et):void 0);if(et&&(tt=et?et[1]:""),Q){et=Z();if(null!=et&&et>parseFloat(tt)){z=String(et);break t}}z=tt}var nt={};function rt(){return t=function(){let e=0;var n=P(String(z)).split("."),r=P("9").split("."),s=Math.max(n.length,r.length);for(let t=0;0==e&&t<s;t++)for(var i=n[t]||"",o=r[t]||"";i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],(0!=i[0].length||0!=o[0].length)&&(e=U(0==i[1].length?0:parseInt(i[1],10),0==o[1].length?0:parseInt(o[1],10))||U(0==i[2].length,0==o[2].length)||U(i[2],o[2]),i=i[3],o=o[3],0==e););return 0<=e},e=nt,Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9);var t,e}var st=w.document&&Q&&(Z()||parseInt(z,10))||void 0,it=function(){if(!w.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{w.addEventListener("test",v,e),w.removeEventListener("test",v,e)}catch(t){}return t}();function ot(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function at(t,e){if(ot.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(J){t:{try{G(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:ht[t.pointerType]||"",this.state=t.state,(this.i=t).defaultPrevented&&at.Z.h.call(this)}}ot.prototype.h=function(){this.defaultPrevented=!0},D(at,ot);var ht={2:"touch",3:"pen",4:"mouse"};at.prototype.h=function(){at.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ut="closure_listenable_"+(1e6*Math.random()|0),ct=0;function lt(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ia=s,this.key=++ct,this.ca=this.fa=!1}function dt(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ft(t){this.src=t,this.g={},this.h=0}function gt(t,e){var n,r,s,i=e.type;i in t.g&&(n=t.g[i],(s=0<=(r=k(n,e)))&&Array.prototype.splice.call(n,r,1),s&&(dt(e),0==t.g[i].length&&(delete t.g[i],t.h--)))}function mt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==r)return s}return-1}ft.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=mt(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new lt(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var pt="closure_lm_"+(1e6*Math.random()|0),yt={};function wt(t,e,n,r,s){if(r&&r.once)return function t(e,n,r,s,i){if(Array.isArray(n)){for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);return null}r=St(r);return e&&e[ut]?e.O(n,r,T(s)?!!s.capture:!!s,i):vt(e,n,r,!0,s,i)}(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)wt(t,e[i],n,r,s);return null}return n=St(n),t&&t[ut]?t.N(e,n,T(r)?!!r.capture:!!r,s):vt(t,e,n,!1,r,s)}function vt(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o,a=T(s)?!!s.capture:!!s,h=It(t);if(h||(t[pt]=h=new ft(t)),(n=h.add(e,n,r,a,i)).proxy)return n;if(o=Et,r=function t(e){return o.call(t.src,t.listener,e)},(n.proxy=r).src=t,r.listener=n,t.addEventListener)void 0===(s=!it?a:s)&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(Tt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function bt(t){var e,n,r;"number"!=typeof t&&t&&!t.ca&&((e=t.src)&&e[ut]?gt(e.i,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Tt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=It(e))?(gt(n,t),0==n.h&&(n.src=null,e[pt]=null)):dt(t)))}function Tt(t){return t in yt?yt[t]:yt[t]="on"+t}function Et(t,e){var n,r;return t=!!t.ca||(e=new at(e,this),n=t.listener,r=t.ia||t.src,t.fa&&bt(t),n.call(r,e))}function It(t){return(t=t[pt])instanceof ft?t:null}var _t="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(e){return"function"==typeof e?e:(e[_t]||(e[_t]=function(t){return e.handleEvent(t)}),e[_t])}function Nt(){C.call(this),this.i=new ft(this),(this.P=this).I=null}function At(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e?e=new ot(e,t):e instanceof ot?e.target=e.target||t:(o=e,$(e=new ot(r,t),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=e.g=n[s],o=Dt(i,r,!0,e)&&o;if(o=Dt(i=e.g=t,r,!0,e)&&o,o=Dt(i,r,!1,e)&&o,n)for(s=0;s<n.length;s++)o=Dt(i=e.g=n[s],r,!1,e)&&o}function Dt(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o,a,h=e[i];h&&!h.ca&&h.capture==n&&(o=h.listener,a=h.ia||h.src,h.fa&&gt(t.i,h),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}D(Nt,C),Nt.prototype[ut]=!0,Nt.prototype.removeEventListener=function(t,e,n,r){!function t(e,n,r,s,i){if(Array.isArray(n))for(var o=0;o<n.length;o++)t(e,n[o],r,s,i);else s=T(s)?!!s.capture:!!s,r=St(r),e&&e[ut]?(e=e.i,(n=String(n).toString())in e.g&&-1<(r=mt(o=e.g[n],r,s,i))&&(dt(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete e.g[n],e.h--))):(e=e&&It(e))&&(n=e.g[n.toString()],(r=(e=-1)<(e=n?mt(n,r,s,i):e)?n[e]:null)&&bt(r))}(this,t,e,n,r)},Nt.prototype.M=function(){if(Nt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)dt(n[r]);delete e.g[t],e.h--}}this.I=null},Nt.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},Nt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var Ct=w.JSON.stringify;var xt,kt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}(()=>new Rt,t=>t.reset());class Rt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Lt(t,e){var n;xt||(n=w.Promise.resolve(void 0),xt=function(){n.then(Ft)}),Ot||(xt(),Ot=!0),Mt.add(t,e)}var Ot=!1,Mt=new class{constructor(){this.h=this.g=null}add(t,e){const n=kt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ft(){for(var t;t=function(){var t=Mt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}();){try{t.h.call(t.g)}catch(t){!function(t){w.setTimeout(()=>{throw t},0)}(t)}var e=kt;e.j(t),e.h<100&&(e.h++,t.next=e.g,e.g=t)}Ot=!1}function Pt(t,e){Nt.call(this),this.h=t||1,this.g=e||w,this.j=N(this.kb,this),this.l=Date.now()}function Vt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Ut(t,e,n){if("function"==typeof t)n&&(t=N(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=N(t.handleEvent,t)}return 2147483647<Number(e)?-1:w.setTimeout(t,e||0)}D(Pt,Nt),(m=Pt.prototype).da=!1,m.S=null,m.kb=function(){var t;this.da&&(0<(t=Date.now()-this.l)&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),At(this,"tick"),this.da&&(Vt(this),this.start())))},m.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},m.M=function(){Pt.Z.M.call(this),Vt(this),delete this.g};class qt extends C{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:function t(e){e.g=Ut(()=>{e.g=null,e.i&&(e.i=!1,t(e))},e.j);var n=e.h;e.h=null,e.m.apply(null,n)}(this)}M(){super.M(),this.g&&(w.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Bt(t){C.call(this),this.h=t,this.g={}}D(Bt,C);var jt=[];function Kt(t,e,n,r){Array.isArray(n)||(n&&(jt[0]=n.toString()),n=jt);for(var s=0;s<n.length;s++){var i=wt(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function $t(t){B(t.g,function(t,e){this.g.hasOwnProperty(e)&&bt(t)},t),t.g={}}function Gt(){this.g=!0}function zt(t,e,n,r){t.info(function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Ct(n)}catch(t){return e}}(t,n)+(r?" "+r:"")})}Bt.prototype.M=function(){Bt.Z.M.call(this),$t(this)},Bt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Gt.prototype.Aa=function(){this.g=!1},Gt.prototype.info=function(){};var Ht={},Qt=null;function Wt(){return Qt=Qt||new Nt}function Yt(t){ot.call(this,Ht.Ma,t)}function Jt(){var t=Wt();At(t,new Yt(t))}function Xt(t,e){ot.call(this,Ht.STAT_EVENT,t),this.stat=e}function Zt(t){var e=Wt();At(e,new Xt(e,t))}function te(t,e){ot.call(this,Ht.Na,t),this.size=e}function ee(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return w.setTimeout(function(){t()},e)}Ht.Ma="serverreachability",D(Yt,ot),Ht.STAT_EVENT="statevent",D(Xt,ot),Ht.Na="timingevent",D(te,ot);var ne={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},re={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function se(){}function ie(t){return t.h||(t.h=t.i())}function oe(){}se.prototype.h=null;p={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ae(){ot.call(this,"d")}function he(){ot.call(this,"c")}function ue(){}function ce(t,e,n,r){this.l=t,this.j=e,this.m=n,this.X=r||1,this.V=new Bt(this),this.P=fe,this.W=new Pt(t=Y?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new le}function le(){this.i=null,this.g="",this.h=!1}D(ae,ot),D(he,ot),D(ue,se),ue.prototype.g=function(){return new XMLHttpRequest},ue.prototype.i=function(){return{}};var de=new ue,fe=45e3,ge={},me={};function pe(t,e,n){t.K=1,t.v=Ve(Re(e)),t.s=n,t.U=!0,ye(t,null)}function ye(t,e){t.F=Date.now(),be(t),t.A=Re(t.v);var o,a,h,u,c,l,n=t.A,r=t.X;Array.isArray(r)||(r=[String(r)]),Je(n.h,"t",r),t.C=0,n=t.l.H,t.h=new le,t.g=Xn(t.l,n?e:null,!t.s),0<t.O&&(t.L=new qt(N(t.Ia,t,t.g),t.O)),Kt(t.V,t.g,"readystatechange",t.gb),e=t.H?j(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Jt(),o=t.j,a=t.u,h=t.A,u=t.m,c=t.X,l=t.s,o.info(function(){if(o.g)if(l)for(var t="",e=l.split("&"),n=0;n<e.length;n++){var r,s,i=e[n].split("=");1<i.length&&(r=i[0],i=i[1],t=2<=(s=r.split("_")).length&&"type"==s[1]?t+(r+"=")+i+"&":t+(r+"=redacted&"))}else t=null;else t=l;return"XMLHTTP REQ ("+u+") [attempt "+c+"]: "+a+"\n"+h+"\n"+t})}function we(t){return t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function ve(t,e,n){let r=!0,s;for(;!t.I&&t.C<n.length;){if(s=(o=n,h=a=void 0,a=(i=t).C,-1==(h=o.indexOf("\n",a))?me:(a=Number(o.substring(a,h)),isNaN(a)?ge:(h+=1)+a>o.length?me:(o=o.substr(h,a),i.C=h+a,o))),s==me){4==e&&(t.o=4,Zt(14),r=!1),zt(t.j,t.m,null,"[Incomplete Response]");break}if(s==ge){t.o=4,Zt(15),zt(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}zt(t.j,t.m,s,null),Se(t,s)}var i,o,a,h;we(t)&&s!=me&&s!=ge&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,Zt(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),$n(e),e.L=!0,Zt(11))):(zt(t.j,t.m,n,"[Invalid Chunked Response]"),_e(t),Ie(t))}function be(t){t.Y=Date.now()+t.P,Te(t,t.P)}function Te(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=ee(N(t.eb,t),e)}function Ee(t){t.B&&(w.clearTimeout(t.B),t.B=null)}function Ie(t){0==t.l.G||t.I||Hn(t.l,t)}function _e(t){Ee(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Vt(t.W),$t(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Se(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||sn(n.i,t)))if(n.I=t.N,!t.J&&sn(n.i,t)&&3==n.G){try{var r=n.Ca.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;zn(n),Mn(n)}Kn(n),Zt(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=ee(N(n.ab,n),6e3));if(rn(n.i)<=1&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Wn(n,11)}else if(!t.J&&n.g!=t||zn(n),!M(e))for(s=n.Ca.g.parse(e),e=0;e<s.length;e++){var i=s[e];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var h,u,c,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=t.g;m&&(!(h=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(u=r.i).g&&(V(h,"spdy")||V(h,"quic")||V(h,"h2"))&&(u.j=u.l,u.g=new Set,u.h&&(on(u,u.h),u.h=null)),!r.D||(c=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=c,Pe(r.F,r.D,c))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=t;(r=n).oa=Jn(r,r.H?r.la:null,r.W),g.J?(an(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(Ee(d),be(d)),r.g=g):jn(r),0<n.l.length&&Vn(n)}else"stop"!=i[0]&&"close"!=i[0]||Wn(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Wn(n,7):On(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}Jt()}catch(t){}}function Ne(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(b(t)||"string"==typeof t)R(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(b(t)||"string"==typeof t)for(var n=[],r=t.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,t)n[r++]=s;for(var s=(r=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(b(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t)).length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}}function Ae(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof Ae)for(n=t.T(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function De(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var r=t.g[e];Ce(t.h,r)&&(t.g[n++]=r),e++}t.g.length=n}if(t.i!=t.g.length){for(var s={},n=e=0;e<t.g.length;)Ce(s,r=t.g[e])||(s[t.g[n++]=r]=1),e++;t.g.length=n}}function Ce(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(m=ce.prototype).setTimeout=function(t){this.P=t},m.gb=function(t){t=t.target;const e=this.L;e&&3==Cn(t)?e.l():this.Ia(t)},m.Ia=function(t){try{if(t==this.g)t:{var e=Cn(this.g),n=this.g.Da();this.g.ba();if(!(e<3)&&(3!=e||Y||this.g&&(this.h.h||this.g.ga()||xn(this.g)))){this.I||4!=e||7==n||Jt(),Ee(this);var r=this.g.ba();this.N=r;e:if(we(this)){var s=xn(this.g);t="";var i=s.length,o=4==Cn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){_e(this),Ie(this);var a="";break e}this.h.i=new w.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,t+=this.h.i.decode(s[n],{stream:o&&n==i-1});s.splice(0,i),this.h.g+=t,this.C=0,a=this.h.g}else a=this.g.ga();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.X,p=e,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.$&&!this.J){e:{if(this.g){var h,u=this.g;if((h=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!M(h)){var c=h;break e}}c=null}if(!(r=c)){this.i=!1,this.o=3,Zt(12),_e(this),Ie(this);break t}zt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Se(this,r)}this.U?(ve(this,e,a),Y&&this.i&&3==e&&(Kt(this.V,this.W,"tick",this.fb),this.W.start())):(zt(this.j,this.m,a,null),Se(this,a)),4==e&&_e(this),this.i&&!this.I&&(4==e?Hn(this.l,this):(this.i=!1,be(this)))}else 400==r&&0<a.indexOf("Unknown SID")?(this.o=3,Zt(12)):(this.o=0,Zt(13)),_e(this),Ie(this)}}}catch(t){}var l,d,f,g,m,p,y},m.fb=function(){var t,e;this.g&&(t=Cn(this.g),e=this.g.ga(),this.C<e.length&&(Ee(this),ve(this,t,e),this.i&&4!=t&&be(this)))},m.cancel=function(){this.I=!0,_e(this)},m.eb=function(){this.B=null;var t,e,n=Date.now();0<=n-this.Y?(t=this.j,e=this.A,t.info(function(){return"TIMEOUT: "+e}),2!=this.K&&(Jt(),Zt(17)),_e(this),this.o=2,Ie(this)):Te(this,this.Y-n)},(m=Ae.prototype).R=function(){De(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},m.T=function(){return De(this),this.g.concat()},m.get=function(t,e){return Ce(this.h,t)?this.h[t]:e},m.set=function(t,e){Ce(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},m.forEach=function(t,e){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);t.call(e,i,s,this)}};var xe=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function ke(t,e){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof ke?(this.g=void 0!==e?e:t.g,Le(this,t.j),this.s=t.s,Oe(this,t.i),Me(this,t.m),this.l=t.l,e=t.h,(n=new He).i=e.i,e.g&&(n.g=new Ae(e.g),n.h=e.h),Fe(this,n),this.o=t.o):t&&(n=String(t).match(xe))?(this.g=!!e,Le(this,n[1]||"",!0),this.s=Ue(n[2]||""),Oe(this,n[3]||"",!0),Me(this,n[4]),this.l=Ue(n[5]||"",!0),Fe(this,n[6]||"",!0),this.o=Ue(n[7]||"")):(this.g=!!e,this.h=new He(null,this.g))}function Re(t){return new ke(t)}function Le(t,e,n){t.j=n?Ue(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Oe(t,e,n){t.i=n?Ue(e,!0):e}function Me(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Fe(t,e,n){var r,s;e instanceof He?(t.h=e,r=t.h,(s=t.g)&&!r.j&&(Qe(r),r.i=null,r.g.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(We(this,e),Je(this,n,t))},r)),r.j=s):(n||(e=qe(e,Ge)),t.h=new He(e,t.g))}function Pe(t,e,n){t.h.set(e,n)}function Ve(t){return Pe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ue(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function qe(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Be),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function Be(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}ke.prototype.toString=function(){var t=[],e=this.j;e&&t.push(qe(e,je,!0),":");var n=this.i;return!n&&"file"!=e||(t.push("//"),(e=this.s)&&t.push(qe(e,je,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(qe(n,"/"==n.charAt(0)?$e:Ke,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",qe(n,ze)),t.join("")};var je=/[#\/\?@]/g,Ke=/[#\?:]/g,$e=/[#\?]/g,Ge=/[#\?@]/g,ze=/#/g;function He(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Qe(n){n.g||(n.g=new Ae,n.h=0,n.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],e(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function We(t,e){Qe(t),e=Xe(t,e),Ce(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Ce((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&De(t)))}function Ye(t,e){return Qe(t),e=Xe(t,e),Ce(t.g.h,e)}function Je(t,e,n){We(t,e),0<n.length&&(t.i=null,t.g.set(Xe(t,e),O(n)),t.h+=n.length)}function Xe(t,e){return e=String(e),e=t.j?e.toLowerCase():e}(m=He.prototype).add=function(t,e){Qe(this),this.i=null,t=Xe(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},m.forEach=function(n,r){Qe(this),this.g.forEach(function(t,e){R(t,function(t){n.call(r,t,e,this)},this)},this)},m.T=function(){Qe(this);for(var t=this.g.R(),e=this.g.T(),n=[],r=0;r<e.length;r++)for(var s=t[r],i=0;i<s.length;i++)n.push(e[r]);return n},m.R=function(t){Qe(this);var e=[];if("string"==typeof t)Ye(this,t)&&(e=L(e,this.g.get(Xe(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=L(e,t[n])}return e},m.set=function(t,e){return Qe(this),this.i=null,Ye(this,t=Xe(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},m.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},m.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++)for(var r=e[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),t.push(o)}return this.i=t.join("&")};var Ze=class{constructor(t,e){this.h=t,this.g=e}};function tn(t){this.l=t||10,t=w.PerformanceNavigationTiming?0<(t=w.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(w.g&&w.g.Ea&&w.g.Ea()&&w.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var en;function nn(t){return t.h||t.g&&t.g.size>=t.j}function rn(t){return t.h?1:t.g?t.g.size:0}function sn(t,e){return t.h?t.h==e:t.g&&t.g.has(e)}function on(t,e){t.g?t.g.add(e):t.h=e}function an(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function hn(e){if(null!=e.h)return e.i.concat(e.h.D);if(null==e.g||0===e.g.size)return O(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}}function un(){}function cn(){this.g=new un}function ln(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function dn(t){this.l=t.$b||null,this.j=t.ib||!1}function fn(t,e){Nt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=gn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}tn.prototype.cancel=function(){if(this.i=hn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},un.prototype.stringify=function(t){return w.JSON.stringify(t,void 0)},un.prototype.parse=function(t){return w.JSON.parse(t,void 0)},D(dn,se),dn.prototype.g=function(){return new fn(this.l,this.j)},dn.prototype.i=(en={},function(){return en}),D(fn,Nt);var gn=0;function mn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function pn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,yn(t)}function yn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(m=fn.prototype).open=function(t,e){if(this.readyState!=gn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,yn(this)},m.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||w).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},m.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,pn(this)),this.readyState=gn},m.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,yn(this)),this.g&&(this.readyState=3,yn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==w.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;mn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},m.Sa=function(t){var e;this.g&&(this.u&&t.value?this.response.push(t.value):this.u||(e=t.value||new Uint8Array(0),(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)),(t.done?pn:yn)(this),3==this.readyState&&mn(this))},m.Ua=function(t){this.g&&(this.response=this.responseText=t,pn(this))},m.Ta=function(t){this.g&&(this.response=t,pn(this))},m.ha=function(){this.g&&pn(this)},m.setRequestHeader=function(t,e){this.v.append(t,e)},m.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},m.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(fn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var wn=w.JSON.parse;function vn(t){Nt.call(this),this.headers=new Ae,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=bn,this.K=this.L=!1}D(vn,Nt);var bn="",Tn=/^https?$/i,En=["POST","PUT"];function In(t){return"content-type"==t.toLowerCase()}function _n(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Sn(t),An(t)}function Sn(t){t.D||(t.D=!0,At(t,"complete"),At(t,"error"))}function Nn(t){if(t.h&&void 0!==y&&(!t.C[1]||4!=Cn(t)||2!=t.ba()))if(t.v&&4==Cn(t))Ut(t.Fa,0,t);else if(At(t,"readystatechange"),4==Cn(t)){t.h=!1;try{var e,n,r,s,i=t.ba();t:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break t;default:o=!1}if((e=o)||((n=0===i)&&(!(s=String(t.H).match(xe)[1]||null)&&w.self&&w.self.location&&(s=(r=w.self.location.protocol).substr(0,r.length-1)),n=!Tn.test(s?s.toLowerCase():"")),e=n),e)At(t,"complete"),At(t,"success");else{t.m=6;try{var a=2<Cn(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",Sn(t)}}finally{An(t)}}}function An(t,e){if(t.g){Dn(t);const n=t.g,r=t.C[0]?v:null;t.g=null,t.C=null,e||At(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function Dn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(w.clearTimeout(t.A),t.A=null)}function Cn(t){return t.g?t.g.readyState:0}function xn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case bn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function kn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=function(t){let n="";return B(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Pe(t,e,n))}function Rn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Ln(t){this.za=0,this.l=[],this.h=new Gt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Rn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Rn("baseRetryDelayMs",5e3,t),this.$a=Rn("retryDelaySeedMs",1e4,t),this.Ya=Rn("forwardChannelMaxRetries",2,t),this.ra=Rn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new tn(t&&t.concurrentRequestLimit),this.Ca=new cn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function On(t){var e,n;Fn(t),3==t.G&&(e=t.V++,Pe(n=Re(t.F),"SID",t.J),Pe(n,"RID",e),Pe(n,"TYPE","terminate"),qn(t,n),(e=new ce(t,t.h,e,void 0)).K=2,e.v=Ve(Re(n)),n=!1,!(n=w.navigator&&w.navigator.sendBeacon?w.navigator.sendBeacon(e.v.toString(),""):n)&&w.Image&&((new Image).src=e.v,n=!0),n||(e.g=Xn(e.l,null),e.g.ea(e.v)),e.F=Date.now(),be(e)),Yn(t)}function Mn(t){t.g&&($n(t),t.g.cancel(),t.g=null)}function Fn(t){Mn(t),t.u&&(w.clearTimeout(t.u),t.u=null),zn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&w.clearTimeout(t.m),t.m=null)}function Pn(t,e){t.l.push(new Ze(t.Za++,e)),3==t.G&&Vn(t)}function Vn(t){nn(t.i)||t.m||(t.m=!0,Lt(t.Ha,t),t.C=0)}function Un(t,e){var n=e?e.m:t.V++,r=Re(t.F);Pe(r,"SID",t.J),Pe(r,"RID",n),Pe(r,"AID",t.U),qn(t,r),t.o&&t.s&&kn(r,t.o,t.s),n=new ce(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=Bn(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),on(t.i,n),pe(n,r,e)}function qn(t,n){t.j&&Ne({},function(t,e){Pe(n,e,t)})}function Bn(t,e,r){r=Math.min(t.l.length,r);var s=t.j?N(t.j.Oa,t.j,t):null;t:{var i=t.l;let n=-1;for(;;){const h=["count="+r];-1==n?0<r?(n=i[0].h,h.push("ofs="+n)):n=0:h.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var o=i[t].h,a=i[t].g;if((o-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{!function(t,r,e){const s=e||"";try{Ne(t,function(t,e){let n=t;T(t)&&(n=Ct(t)),r.push(s+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(s+"type="+encodeURIComponent("_badmap")),t}}(a,h,"req"+o+"_")}catch(t){s&&s(a)}}if(e){s=h.join("&");break t}}}return t=t.l.splice(0,r),e.D=t,s}function jn(t){t.g||t.u||(t.Y=1,Lt(t.Ga,t),t.A=0)}function Kn(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=ee(N(t.Ga,t),Qn(t,t.A)),t.A++,1)}function $n(t){null!=t.B&&(w.clearTimeout(t.B),t.B=null)}function Gn(t){t.g=new ce(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Re(t.oa);Pe(e,"RID","rpc"),Pe(e,"SID",t.J),Pe(e,"CI",t.N?"0":"1"),Pe(e,"AID",t.U),qn(t,e),Pe(e,"TYPE","xmlhttp"),t.o&&t.s&&kn(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ve(Re(e)),n.s=null,n.U=!0,ye(n,t)}function zn(t){null!=t.v&&(w.clearTimeout(t.v),t.v=null)}function Hn(t,e){var n,r,s,i=null;if(t.g==e){zn(t),$n(t),t.g=null;var o=2}else{if(!sn(t.i,e))return;i=e.D,an(t.i,e),o=1}if(t.I=e.N,0!=t.G)if(e.i)1==o?(i=e.s?e.s.length:0,e=Date.now()-e.F,n=t.C,At(o=Wt(),new te(o,i)),Vn(t)):jn(t);else if(3==(n=e.o)||0==n&&0<t.I||(1!=o||(s=e,rn((r=t).i)>=r.i.j-(r.m?1:0)||(r.m?(r.l=s.D.concat(r.l),0):1==r.G||2==r.G||r.C>=(r.Xa?0:r.Ya)||(r.m=ee(N(r.Ha,r,s),Qn(r,r.C)),r.C++,0))))&&(2!=o||!Kn(t)))switch(i&&0<i.length&&(e=t.i,e.i=e.i.concat(i)),n){case 1:Wn(t,5);break;case 4:Wn(t,10);break;case 3:Wn(t,6);break;default:Wn(t,2)}}function Qn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Wn(t,e){var n,r;t.h.info("Error code "+e),2==e?(n=null,t.j&&(n=null),r=N(t.jb,t),n||(n=new ke("//www.google.com/images/cleardot.gif"),w.location&&"http"==w.location.protocol||Le(n,"https"),Ve(n)),function(t,e){var n=new Gt;if(w.Image){const r=new Image;r.onload=A(ln,n,r,"TestLoadImage: loaded",!0,e),r.onerror=A(ln,n,r,"TestLoadImage: error",!1,e),r.onabort=A(ln,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=A(ln,n,r,"TestLoadImage: timeout",!1,e),w.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}(n.toString(),r)):Zt(2),t.G=0,t.j&&t.j.va(e),Yn(t),Fn(t)}function Yn(t){t.G=0,t.I=-1,t.j&&(0==hn(t.i).length&&0==t.l.length||(t.i.i.length=0,O(t.l),t.l.length=0),t.j.ua())}function Jn(t,e,n){let r=(a=n)instanceof ke?Re(a):new ke(a,void 0);var s,i,o,a,h;return""!=r.i?(e&&Oe(r,e+"."+r.i),Me(r,r.m)):(h=w.location,r=(s=h.protocol,i=e?e+"."+h.hostname:h.hostname,o=+h.port,a=n,h=new ke(null,void 0),s&&Le(h,s),i&&Oe(h,i),o&&Me(h,o),a&&(h.l=a),h)),t.aa&&B(t.aa,function(t,e){Pe(r,e,t)}),e=t.D,n=t.sa,e&&n&&Pe(r,e,n),Pe(r,"VER",t.ma),qn(t,r),r}function Xn(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new vn(new dn({ib:!0})):new vn(t.qa)).L=t.H,e}function Zn(){}function tr(){if(Q&&!(10<=Number(st)))throw Error("Environmental error: no available transport.")}function er(t,e){Nt.call(this),this.g=new Ln(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!M(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!M(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new sr(this)}function nr(t){ae.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function rr(){he.call(this),this.status=1}function sr(t){this.g=t}(m=vn.prototype).ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||de).g(),this.C=this.u?ie(this.u):ie(de),this.g.onreadystatechange=N(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void _n(this,t)}t=n||"";const s=new Ae(this.headers);r&&Ne(r,function(t,e){s.set(e,t)}),r=function(e){t:{var n=In,r=e.length,s="string"==typeof e?e.split(""):e;for(let t=0;t<r;t++)if(t in s&&n.call(void 0,s[t],t,e)){n=t;break t}n=-1}return n<0?null:"string"==typeof e?e.charAt(n):e[n]}(s.T()),n=w.FormData&&t instanceof w.FormData,0<=k(En,e)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(t,e){this.g.setRequestHeader(e,t)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Dn(this),0<this.B&&((this.K=(i=this.g,Q&&rt()&&"number"==typeof i.timeout&&void 0!==i.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=N(this.pa,this)):this.A=Ut(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){_n(this,t)}var i},m.pa=function(){void 0!==y&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,At(this,"timeout"),this.abort(8))},m.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,At(this,"complete"),At(this,"abort"),An(this))},m.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),An(this,!0)),vn.Z.M.call(this)},m.Fa=function(){this.s||(this.F||this.v||this.l?Nn(this):this.cb())},m.cb=function(){Nn(this)},m.ba=function(){try{return 2<Cn(this)?this.g.status:-1}catch(t){return-1}},m.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},m.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),wn(e)}},m.Da=function(){return this.m},m.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(m=Ln.prototype).ma=8,m.G=1,m.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},m.Ha=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.V=Math.floor(1e5*Math.random()),e=this.V++;const i=new ce(this,this.h,e,void 0);let t=this.s;if(this.P&&(t?(t=j(t),$(t,this.P)):t=this.P),null===this.o&&(i.H=t),this.ja)t:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break t}if(4096===n||r===this.l.length-1){n=r+1;break t}}n=1e3}else n=1e3;n=Bn(this,i,n),Pe(r=Re(this.F),"RID",e),Pe(r,"CVER",22),this.D&&Pe(r,"X-HTTP-Session-Id",this.D),qn(this,r),this.o&&t&&kn(r,this.o,t),on(this.i,i),this.Ra&&Pe(r,"TYPE","init"),this.ja?(Pe(r,"$req",n),Pe(r,"SID","null"),i.$=!0,pe(i,r,null)):pe(i,r,n),this.G=2}}else 3==this.G&&(e?Un(this,e):0==this.l.length||nn(this.i)||Un(this))},m.Ga=function(){var t;this.u=null,Gn(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(t=2*this.O,this.h.info("BP detection timer enabled: "+t),this.B=ee(N(this.bb,this),t))},m.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,Zt(10),Mn(this),Gn(this))},m.ab=function(){null!=this.v&&(this.v=null,Mn(this),Kn(this),Zt(19))},m.jb=function(t){t?(this.h.info("Successfully pinged google.com"),Zt(2)):(this.h.info("Failed to ping google.com"),Zt(1))},(m=Zn.prototype).xa=function(){},m.wa=function(){},m.va=function(){},m.ua=function(){},m.Oa=function(){},tr.prototype.g=function(t,e){return new er(t,e)},D(er,Nt),er.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Lt(N(t.hb,t,e))),Zt(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=Jn(t,null,t.W),Vn(t)},er.prototype.close=function(){On(this.g)},er.prototype.u=function(t){var e;"string"==typeof t?((e={}).__data__=t,Pn(this.g,e)):this.v?((e={}).__data__=Ct(t),Pn(this.g,e)):Pn(this.g,t)},er.prototype.M=function(){this.g.j=null,delete this.j,On(this.g),delete this.g,er.Z.M.call(this)},D(nr,ae),D(rr,he),D(sr,Zn),sr.prototype.xa=function(){At(this.g,"a")},sr.prototype.wa=function(t){At(this.g,new nr(t))},sr.prototype.va=function(t){At(this.g,new rr)},sr.prototype.ua=function(){At(this.g,"b")},tr.prototype.createWebChannel=tr.prototype.g,er.prototype.send=er.prototype.u,er.prototype.open=er.prototype.m,ne.NO_ERROR=0,ne.TIMEOUT=8,ne.HTTP_ERROR=6,re.COMPLETE="complete",(oe.EventType=p).OPEN="a",p.CLOSE="b",p.ERROR="c",p.MESSAGE="d",Nt.prototype.listen=Nt.prototype.N,vn.prototype.listenOnce=vn.prototype.O,vn.prototype.getLastError=vn.prototype.La,vn.prototype.getLastErrorCode=vn.prototype.Da,vn.prototype.getStatus=vn.prototype.ba,vn.prototype.getResponseJson=vn.prototype.Qa,vn.prototype.getResponseText=vn.prototype.ga,vn.prototype.send=vn.prototype.ea;var ir,or=Wt,ar=ne,hr=re,ur=Ht,cr=10,lr=11,dr=dn,fr=oe,gr=vn;class mr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}mr.UNAUTHENTICATED=new mr(null),mr.GOOGLE_CREDENTIALS=new mr("google-credentials-uid"),mr.FIRST_PARTY=new mr("first-party-uid"),mr.MOCK_USER=new mr("mock-user");let pr="9.1.1";const yr=new class{constructor(t){this.name=t,this._logLevel=u,this._logHandler=g,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in l))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?h[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...t),this._logHandler(this,l.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...t),this._logHandler(this,l.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,l.INFO,...t),this._logHandler(this,l.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,l.WARN,...t),this._logHandler(this,l.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...t),this._logHandler(this,l.ERROR,...t)}}("@firebase/firestore");function wr(){return yr.logLevel}function vr(t,...e){yr.logLevel<=l.DEBUG&&(e=e.map(Er),yr.debug(`Firestore (${pr}): ${t}`,...e))}function br(t,...e){yr.logLevel<=l.ERROR&&(e=e.map(Er),yr.error(`Firestore (${pr}): ${t}`,...e))}function Tr(t,...e){yr.logLevel<=l.WARN&&(e=e.map(Er),yr.warn(`Firestore (${pr}): ${t}`,...e))}function Er(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function Ir(t="Unexpected state"){t=`FIRESTORE (${pr}) INTERNAL ASSERTION FAILED: `+t;throw br(t),new Error(t)}function _r(t){t||Ir()}const Sr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Nr extends Error{constructor(t,e){super(e),this.code=t,this.message=e,this.name="FirebaseError",this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ar{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}class Dr{constructor(t,e){this.user=e,this.type="OAuth",this.authHeaders={},this.authHeaders.Authorization=`Bearer ${t}`}}class Cr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(mr.UNAUTHENTICATED))}shutdown(){}}class xr{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class kr{constructor(t){this.t=t,this.currentUser=mr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,n){let r=this.i;const s=t=>this.i!==r?(r=this.i,n(t)):Promise.resolve();let i=new Ar;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Ar,e.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const t=i;e.enqueueRetryable(async()=>{await t.promise,await s(this.currentUser)})},a=t=>{vr("FirebaseCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(t=>a(t)),setTimeout(()=>{var t;this.auth||((t=this.t.getImmediate({optional:!0}))?a(t):(vr("FirebaseCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Ar))},0),o()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(vr("FirebaseCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(_r("string"==typeof t.accessToken),new Dr(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var t=this.auth&&this.auth.getUid();return _r(null===t||"string"==typeof t),new mr(t)}}class Rr{constructor(t,e,n){this.h=t,this.l=e,this.m=n,this.type="FirstParty",this.user=mr.FIRST_PARTY}get authHeaders(){const t={"X-Goog-AuthUser":this.l},e=this.h.auth.getAuthHeaderValueForFirstParty([]);return e&&(t.Authorization=e),this.m&&(t["X-Goog-Iam-Authorization-Token"]=this.m),t}}class Lr{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Rr(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable(()=>e(mr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Or{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.g(t),this.p=t=>e.writeSequenceNumber(t))}g(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){var t=++this.previousValue;return this.p&&this.p(t),t}}Or.T=-1;class Mr{static I(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/e.length)*e.length;let r="";for(;r.length<20;){var s=function(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}(40);for(let t=0;t<s.length;++t)r.length<20&&s[t]<n&&(r+=e.charAt(s[t]%e.length))}return r}}function Fr(t,e){return t<e?-1:e<t?1:0}function Pr(t,n,r){return t.length===n.length&&t.every((t,e)=>r(t,n[e]))}function Vr(t){return t+"\0"}class Ur{constructor(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new Nr(Sr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Ur.fromMillis(Date.now())}static fromDate(t){return Ur.fromMillis(t.getTime())}static fromMillis(t){var e=Math.floor(t/1e3),t=Math.floor(1e6*(t-1e3*e));return new Ur(e,t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Fr(this.nanoseconds,t.nanoseconds):Fr(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class qr{constructor(t){this.timestamp=t}static fromTimestamp(t){return new qr(t)}static min(){return new qr(new Ur(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function Br(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function jr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Kr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class $r{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ir(),void 0===n?n=t.length-e:n>t.length-e&&Ir(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===$r.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof $r?t.forEach(t=>{e.push(t)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return this.construct(this.segments,this.offset+(t=void 0===t?1:t),this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(n){for(let t=this.offset,e=this.limit();t<e;t++)n(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,n){const r=Math.min(e.length,n.length);for(let t=0;t<r;t++){const r=e.get(t),s=n.get(t);if(r<s)return-1;if(r>s)return 1}return e.length<n.length?-1:e.length>n.length?1:0}}class Gr extends $r{construct(t,e,n){return new Gr(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(0<=n.indexOf("//"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(t=>0<t.length))}return new Gr(e)}static emptyPath(){return new Gr([])}}const zr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class Hr extends $r{construct(t,e,n){return new Hr(t,e,n)}static isValidIdentifier(t){return zr.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),t=!Hr.isValidIdentifier(t)?"`"+t+"`":t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new Hr(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;var s=()=>{if(0===n.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new Nr(Sr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Nr(Sr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?i=!i:"."!==e||i?n+=e:s(),r++}if(s(),i)throw new Nr(Sr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new Hr(e)}static emptyPath(){return new Hr([])}}class Qr{constructor(t){(this.fields=t).sort(Hr.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Pr(this.fields,t.fields,(t,e)=>t.isEqual(e))}}class Wr{constructor(t){this.binaryString=t}static fromBase64String(t){t=atob(t);return new Wr(t)}static fromUint8Array(t){t=function(e){let n="";for(let t=0;t<e.length;++t)n+=String.fromCharCode(e[t]);return n}(t);return new Wr(t)}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(e){const n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Fr(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Wr.EMPTY_BYTE_STRING=new Wr("");const Yr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Jr(e){if(_r(!!e),"string"!=typeof e)return{seconds:Xr(e.seconds),nanos:Xr(e.nanos)};{let t=0;var n=Yr.exec(e);_r(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),t=Number(n));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}}function Xr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Zr(t){return"string"==typeof t?Wr.fromBase64String(t):Wr.fromUint8Array(t)}function ts(t){return"server_timestamp"===(null===(t=((null===(t=null==t?void 0:t.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function es(t){t=Jr(t.mapValue.fields.__local_write_time__.timestampValue);return new Ur(t.seconds,t.nanos)}function ns(t){return null==t}function rs(t){return 0===t&&1/t==-1/0}function ss(t){return"number"==typeof t&&Number.isInteger(t)&&!rs(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class is{constructor(t){this.path=t}static fromPath(t){return new is(Gr.fromString(t))}static fromName(t){return new is(Gr.fromString(t).popFirst(5))}hasCollectionId(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t}isEqual(t){return null!==t&&0===Gr.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Gr.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new is(new Gr(t.slice()))}}function os(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?ts(t)?4:10:Ir()}function as(n,r){var t,e,s=os(n);if(s!==os(r))return!1;switch(s){case 0:return!0;case 1:return n.booleanValue===r.booleanValue;case 4:return es(n).isEqual(es(r));case 3:return function(t){if("string"==typeof n.timestampValue&&"string"==typeof t.timestampValue&&n.timestampValue.length===t.timestampValue.length)return n.timestampValue===t.timestampValue;var e=Jr(n.timestampValue),t=Jr(t.timestampValue);return e.seconds===t.seconds&&e.nanos===t.nanos}(r);case 5:return n.stringValue===r.stringValue;case 6:return e=r,Zr(n.bytesValue).isEqual(Zr(e.bytesValue));case 7:return n.referenceValue===r.referenceValue;case 8:return t=r,Xr((e=n).geoPointValue.latitude)===Xr(t.geoPointValue.latitude)&&Xr(e.geoPointValue.longitude)===Xr(t.geoPointValue.longitude);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Xr(t.integerValue)===Xr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){t=Xr(t.doubleValue),e=Xr(e.doubleValue);return t===e?rs(t)===rs(e):isNaN(t)&&isNaN(e)}return!1}(n,r);case 9:return Pr(n.arrayValue.values||[],r.arrayValue.values||[],as);case 10:return function(t){const e=t.mapValue.fields||{},n=r.mapValue.fields||{};if(Br(e)!==Br(n))return!1;for(const t in e)if(e.hasOwnProperty(t)&&(void 0===n[t]||!as(e[t],n[t])))return!1;return!0}(n);default:return Ir()}}function hs(t,e){return void 0!==(t.values||[]).find(t=>as(t,e))}function us(t,e){var n,r,s,i=os(t),o=os(e);if(i!==o)return Fr(i,o);switch(i){case 0:return 0;case 1:return Fr(t.booleanValue,e.booleanValue);case 2:return r=e,s=Xr(t.integerValue||t.doubleValue),r=Xr(r.integerValue||r.doubleValue),s<r?-1:r<s?1:s===r?0:isNaN(s)?isNaN(r)?0:-1:1;case 3:return cs(t.timestampValue,e.timestampValue);case 4:return cs(es(t),es(e));case 5:return Fr(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Zr(t),r=Zr(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){var n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=Fr(n[t],r[t]);if(0!==e)return e}return Fr(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return n=t.geoPointValue,s=e.geoPointValue,0!==(r=Fr(Xr(n.latitude),Xr(s.latitude)))?r:Fr(Xr(n.longitude),Xr(s.longitude));case 9:return function(t,e){var n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=us(n[t],r[t]);if(e)return e}return Fr(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=Fr(r[t],i[t]);if(0!==e)return e;var o=us(n[r[t]],s[i[t]]);if(0!==o)return o}return Fr(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Ir()}}function cs(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Fr(t,e);var n=Jr(t),t=Jr(e),e=Fr(n.seconds,t.seconds);return 0!==e?e:Fr(n.nanos,t.nanos)}function ls(t){return function i(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Jr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Zr(t.bytesValue).toBase64():"referenceValue"in t?(e=t.referenceValue,is.fromName(e).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=i(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${i(t.fields[s])}`;return n+"}"}(t.mapValue):Ir();var e}(t)}function ds(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function fs(t){return t&&"integerValue"in t}function gs(t){return!!t&&"arrayValue"in t}function ms(t){return t&&"nullValue"in t}function ps(t){return t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function ys(t){return t&&"mapValue"in t}function ws(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const n={mapValue:{fields:{}}};return jr(e.mapValue.fields,(t,e)=>n.mapValue.fields[t]=ws(e)),n}if(e.arrayValue){const r={arrayValue:{values:[]}};for(let t=0;t<(e.arrayValue.values||[]).length;++t)r.arrayValue.values[t]=ws(e.arrayValue.values[t]);return r}return Object.assign({},e)}class vs{constructor(t){this.value=t}static empty(){return new vs({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!ys(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=ws(e)}setAll(t){let n=Hr.emptyPath(),r={},s=[];t.forEach((t,e)=>{if(!n.isImmediateParentOf(e)){const t=this.getFieldsMap(n);this.applyChanges(t,r,s),r={},s=[],n=e.popLast()}t?r[e.lastSegment()]=ws(t):s.push(e.lastSegment())});t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(t){const e=this.field(t.popLast());ys(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return as(this.value,t.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let e=0;e<n.length;++e){let t=r.mapValue.fields[n.get(e)];ys(t)&&t.mapValue.fields||(t={mapValue:{fields:{}}},r.mapValue.fields[n.get(e)]=t),r=t}return r.mapValue.fields}applyChanges(n,t,e){jr(t,(t,e)=>n[t]=e);for(const t of e)delete n[t]}clone(){return new vs(ws(this.value))}}class bs{constructor(t,e,n,r,s){this.key=t,this.documentType=e,this.version=n,this.data=r,this.documentState=s}static newInvalidDocument(t){return new bs(t,0,qr.min(),vs.empty(),0)}static newFoundDocument(t,e,n){return new bs(t,1,e,n,0)}static newNoDocument(t,e){return new bs(t,2,e,vs.empty(),0)}static newUnknownDocument(t,e){return new bs(t,3,e,vs.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=vs.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=vs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof bs&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}clone(){return new bs(this.key,this.documentType,this.version,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ts{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.A=null}}function Es(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Ts(t,e,n,r,s,i,o)}function Is(t){const e=t;if(null===e.A){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(t=>function(t){return t.field.canonicalString()+t.op.toString()+ls(t.value)}(t)).join(","),t+="|ob:",t+=e.orderBy.map(t=>function(t){return t.field.canonicalString()+t.dir}(t)).join(","),ns(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=Fs(e.startAt)),e.endAt&&(t+="|ub:",t+=Fs(e.endAt)),e.A=t}return e.A}function _s(e,n){if(e.limit!==n.limit)return!1;if(e.orderBy.length!==n.orderBy.length)return!1;for(let t=0;t<e.orderBy.length;t++)if(r=e.orderBy[t],s=n.orderBy[t],r.dir!==s.dir||!r.field.isEqual(s.field))return!1;var r,s,i,o;if(e.filters.length!==n.filters.length)return!1;for(let t=0;t<e.filters.length;t++)if(i=e.filters[t],o=n.filters[t],i.op!==o.op||!i.field.isEqual(o.field)||!as(i.value,o.value))return!1;return e.collectionGroup===n.collectionGroup&&!!e.path.isEqual(n.path)&&!!Us(e.startAt,n.startAt)&&Us(e.endAt,n.endAt)}function Ss(t){return is.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class Ns extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.R(t,e,n):new As(t,e,n):"array-contains"===e?new ks(t,n):"in"===e?new Rs(t,n):"not-in"===e?new Ls(t,n):"array-contains-any"===e?new Os(t,n):new Ns(t,e,n)}static R(t,e,n){return new("in"===e?Ds:Cs)(t,n)}matches(t){t=t.data.field(this.field);return"!="===this.op?null!==t&&this.P(us(t,this.value)):null!==t&&os(this.value)===os(t)&&this.P(us(t,this.value))}P(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return 0<t;case">=":return 0<=t;default:return Ir()}}v(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class As extends Ns{constructor(t,e,n){super(t,e,n),this.key=is.fromName(n.referenceValue)}matches(t){t=is.comparator(t.key,this.key);return this.P(t)}}class Ds extends Ns{constructor(t,e){super(t,"in",e),this.keys=xs(0,e)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class Cs extends Ns{constructor(t,e){super(t,"not-in",e),this.keys=xs(0,e)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function xs(t,e){return((null===(e=e.arrayValue)||void 0===e?void 0:e.values)||[]).map(t=>is.fromName(t.referenceValue))}class ks extends Ns{constructor(t,e){super(t,"array-contains",e)}matches(t){t=t.data.field(this.field);return gs(t)&&hs(t.arrayValue,this.value)}}class Rs extends Ns{constructor(t,e){super(t,"in",e)}matches(t){t=t.data.field(this.field);return null!==t&&hs(this.value.arrayValue,t)}}class Ls extends Ns{constructor(t,e){super(t,"not-in",e)}matches(t){if(hs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;t=t.data.field(this.field);return null!==t&&!hs(this.value.arrayValue,t)}}class Os extends Ns{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!gs(e)||!e.arrayValue.values)&&e.arrayValue.values.some(t=>hs(this.value.arrayValue,t))}}class Ms{constructor(t,e){this.position=t,this.before=e}}function Fs(t){return`${t.before?"b":"a"}:${t.position.map(t=>ls(t)).join(",")}`}class Ps{constructor(t,e="asc"){this.field=t,this.dir=e}}function Vs(e,n,r){let s=0;for(let t=0;t<e.position.length;t++){const i=n[t],o=e.position[t];if(s=i.field.isKeyField()?is.comparator(is.fromName(o.referenceValue),r.key):us(o,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return e.before?s<=0:s<0}function Us(e,n){if(null===e)return null===n;if(null===n)return!1;if(e.before!==n.before||e.position.length!==n.position.length)return!1;for(let t=0;t<e.position.length;t++)if(!as(e.position[t],n.position[t]))return!1;return!0}class qs{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.V=null,this.S=null,this.startAt,this.endAt}}function Bs(t,e,n,r,s,i,o,a){return new qs(t,e,n,r,s,i,o,a)}function js(t){return new qs(t)}function Ks(t){return!ns(t.limit)&&"F"===t.limitType}function $s(t){return!ns(t.limit)&&"L"===t.limitType}function Gs(t){return 0<t.explicitOrderBy.length?t.explicitOrderBy[0].field:null}function zs(t){for(const e of t.filters)if(e.v())return e.field;return null}function Hs(t){return null!==t.collectionGroup}function Qs(e){const n=e;if(null===n.V){n.V=[];const e=zs(n),t=Gs(n);if(null!==e&&null===t)e.isKeyField()||n.V.push(new Ps(e)),n.V.push(new Ps(Hr.keyField(),"asc"));else{let t=!1;for(const r of n.explicitOrderBy)n.V.push(r),r.field.isKeyField()&&(t=!0);if(!t){const e=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.V.push(new Ps(Hr.keyField(),e))}}}return n.V}function Ws(t){const e=t;if(!e.S)if("F"===e.limitType)e.S=Es(e.path,e.collectionGroup,Qs(e),e.filters,e.limit,e.startAt,e.endAt);else{const r=[];for(const s of Qs(e)){const e="desc"===s.dir?"asc":"desc";r.push(new Ps(s.field,e))}var n=e.endAt?new Ms(e.endAt.position,!e.endAt.before):null,t=e.startAt?new Ms(e.startAt.position,!e.startAt.before):null;e.S=Es(e.path,e.collectionGroup,r,e.filters,e.limit,n,t)}return e.S}function Ys(t,e,n){return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Js(t,e){return _s(Ws(t),Ws(e))&&t.limitType===e.limitType}function Xs(t){return`${Is(Ws(t))}|lt:${t.limitType}`}function Zs(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),0<t.filters.length&&(e+=`, filters: [${t.filters.map(t=>{return`${(t=t).field.canonicalString()} ${t.op} ${ls(t.value)}`}).join(", ")}]`),ns(t.limit)||(e+=", limit: "+t.limit),0<t.orderBy.length&&(e+=`, orderBy: [${t.orderBy.map(t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t)).join(", ")}]`),t.startAt&&(e+=", startAt: "+Fs(t.startAt)),t.endAt&&(e+=", endAt: "+Fs(t.endAt)),`Target(${e})`}(Ws(t))}; limitType=${t.limitType})`}function ti(n,t){return t.isFoundDocument()&&(e=n,s=(r=t).key.path,null!==e.collectionGroup?r.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(s):is.isDocumentKey(e.path)?e.path.isEqual(s):e.path.isImmediateParentOf(s))&&function(t){for(const e of n.explicitOrderBy)if(!e.field.isKeyField()&&null===t.data.field(e.field))return;return 1}(t)&&function(t){for(const e of n.filters)if(!e.matches(t))return;return 1}(t)&&(s=t,(!(t=n).startAt||Vs(t.startAt,Qs(t),s))&&(!t.endAt||!Vs(t.endAt,Qs(t),s)));var e,r,s}function ei(s){return(t,e)=>{let n=!1;for(const r of Qs(s)){const s=function(t,r,e){var n=t.field.isKeyField()?is.comparator(r.key,e.key):function(t,e){var n=r.data.field(t),t=e.data.field(t);return null!==n&&null!==t?us(n,t):Ir()}(t.field,e);switch(t.dir){case"asc":return n;case"desc":return-1*n;default:return Ir()}}(r,t,e);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function ni(t,e){if(t.D){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:rs(e)?"-0":e}}function ri(t){return{integerValue:""+t}}function si(t,e){return ss(e)?ri(e):ni(t,e)}class ii{constructor(){this._=void 0}}function oi(t,e){return t instanceof di?fs(t=e)||t&&"doubleValue"in t?e:{integerValue:0}:null}class ai extends ii{}class hi extends ii{constructor(t){super(),this.elements=t}}function ui(t,e){const n=gi(e);for(const e of t.elements)n.some(t=>as(t,e))||n.push(e);return{arrayValue:{values:n}}}class ci extends ii{constructor(t){super(),this.elements=t}}function li(t,e){let n=gi(e);for(const e of t.elements)n=n.filter(t=>!as(t,e));return{arrayValue:{values:n}}}class di extends ii{constructor(t,e){super(),this.N=t,this.C=e}}function fi(t){return Xr(t.integerValue||t.doubleValue)}function gi(t){return gs(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class mi{constructor(t,e){this.field=t,this.transform=e}}class pi{constructor(t,e){this.version=t,this.transformResults=e}}class yi{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new yi}static exists(t){return new yi(void 0,t)}static updateTime(t){return new yi(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function wi(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class vi{}function bi(t,e,n){t instanceof _i?function(t,e,n){const r=t.value.clone(),s=Ai(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof Si?function(t,e,n){if(!wi(t.precondition,e))return e.convertToUnknownDocument(n.version);const r=Ai(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(Ni(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):e.convertToNoDocument(n.version).setHasCommittedMutations()}function Ti(t,e,n){t instanceof _i?function(t,e,n){if(wi(t.precondition,e)){const r=t.value.clone(),s=Di(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(Ii(e),r).setHasLocalMutations()}}(t,e,n):t instanceof Si?function(t,e,n){if(wi(t.precondition,e)){const r=Di(t.fieldTransforms,n,e),s=e.data;s.setAll(Ni(t)),s.setAll(r),e.convertToFoundDocument(Ii(e),s).setHasLocalMutations()}}(t,e,n):(e=e,wi(t.precondition,e)&&e.convertToNoDocument(qr.min()))}function Ei(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&(n=t.fieldTransforms,r=e.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Pr(n,r,(t,e)=>function(t,e){return t.field.isEqual(e.field)&&(t=t.transform,e=e.transform,t instanceof hi&&e instanceof hi||t instanceof ci&&e instanceof ci?Pr(t.elements,e.elements,as):t instanceof di&&e instanceof di?as(t.C,e.C):t instanceof ai&&e instanceof ai)}(t,e)))&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask)));var n,r}function Ii(t){return t.isFoundDocument()?t.version:qr.min()}class _i extends vi{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class Si extends vi{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function Ni(n){const r=new Map;return n.fieldMask.fields.forEach(t=>{var e;t.isEmpty()||(e=n.data.field(t),r.set(t,e))}),r}function Ai(e,n,r){const s=new Map;_r(e.length===r.length);for(let t=0;t<r.length;t++){var i=e[t],o=i.transform,a=n.data.field(i.field);s.set(i.field,(i=o,o=a,a=r[t],i instanceof hi?ui(i,o):i instanceof ci?li(i,o):a))}return s}function Di(t,e,n){const r=new Map;for(const u of t){const t=u.transform,c=n.data.field(u.field);r.set(u.field,(s=t,i=c,o=e,h=a=void 0,s instanceof ai?function(){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:o.seconds,nanos:o.nanoseconds}}}};return i&&(t.fields.__previous_value__=i),{mapValue:t}}():s instanceof hi?ui(s,i):s instanceof ci?li(s,i):(h=oi(a=s,i),s=fi(h)+fi(a.C),fs(h)&&fs(a.C)?ri(s):ni(a.N,s))))}var s,i,o,a,h;return r}class Ci extends vi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class xi extends vi{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class ki{constructor(t){this.count=t}}function Ri(t){switch(t){default:return Ir(),0;case Sr.CANCELLED:case Sr.UNKNOWN:case Sr.DEADLINE_EXCEEDED:case Sr.RESOURCE_EXHAUSTED:case Sr.INTERNAL:case Sr.UNAVAILABLE:case Sr.UNAUTHENTICATED:return;case Sr.INVALID_ARGUMENT:case Sr.NOT_FOUND:case Sr.ALREADY_EXISTS:case Sr.PERMISSION_DENIED:case Sr.FAILED_PRECONDITION:case Sr.ABORTED:case Sr.OUT_OF_RANGE:case Sr.UNIMPLEMENTED:case Sr.DATA_LOSS:return 1}}function Li(t){if(void 0===t)return br("GRPC error has no .code"),Sr.UNKNOWN;switch(t){case ir.OK:return Sr.OK;case ir.CANCELLED:return Sr.CANCELLED;case ir.UNKNOWN:return Sr.UNKNOWN;case ir.DEADLINE_EXCEEDED:return Sr.DEADLINE_EXCEEDED;case ir.RESOURCE_EXHAUSTED:return Sr.RESOURCE_EXHAUSTED;case ir.INTERNAL:return Sr.INTERNAL;case ir.UNAVAILABLE:return Sr.UNAVAILABLE;case ir.UNAUTHENTICATED:return Sr.UNAUTHENTICATED;case ir.INVALID_ARGUMENT:return Sr.INVALID_ARGUMENT;case ir.NOT_FOUND:return Sr.NOT_FOUND;case ir.ALREADY_EXISTS:return Sr.ALREADY_EXISTS;case ir.PERMISSION_DENIED:return Sr.PERMISSION_DENIED;case ir.FAILED_PRECONDITION:return Sr.FAILED_PRECONDITION;case ir.ABORTED:return Sr.ABORTED;case ir.OUT_OF_RANGE:return Sr.OUT_OF_RANGE;case ir.UNIMPLEMENTED:return Sr.UNIMPLEMENTED;case ir.DATA_LOSS:return Sr.DATA_LOSS;default:return Ir()}}(re=ir=ir||{})[re.OK=0]="OK",re[re.CANCELLED=1]="CANCELLED",re[re.UNKNOWN=2]="UNKNOWN",re[re.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",re[re.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",re[re.NOT_FOUND=5]="NOT_FOUND",re[re.ALREADY_EXISTS=6]="ALREADY_EXISTS",re[re.PERMISSION_DENIED=7]="PERMISSION_DENIED",re[re.UNAUTHENTICATED=16]="UNAUTHENTICATED",re[re.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",re[re.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",re[re.ABORTED=10]="ABORTED",re[re.OUT_OF_RANGE=11]="OUT_OF_RANGE",re[re.UNIMPLEMENTED=12]="UNIMPLEMENTED",re[re.INTERNAL=13]="INTERNAL",re[re.UNAVAILABLE=14]="UNAVAILABLE",re[re.DATA_LOSS=15]="DATA_LOSS";class Oi{constructor(t,e){this.comparator=t,this.root=e||Fi.EMPTY}insert(t,e){return new Oi(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Fi.BLACK,null,null))}remove(t){return new Oi(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Fi.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(n){this.inorderTraversal((t,e)=>(n(t,e),!1))}toString(){const n=[];return this.inorderTraversal((t,e)=>(n.push(`${t}:${e}`),!1)),`{${n.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Mi(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Mi(this.root,t,this.comparator,!1)}getReverseIterator(){return new Mi(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Mi(this.root,t,this.comparator,!0)}}class Mi{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();var e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Fi{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Fi.RED,this.left=null!=r?r:Fi.EMPTY,this.right=null!=s?s:Fi.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Fi(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;var s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Fi.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Fi.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){var t=this.copy(null,null,Fi.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){var t=this.copy(null,null,Fi.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){var t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ir();if(this.right.isRed())throw Ir();var t=this.left.check();if(t!==this.right.check())throw Ir();return t+(this.isRed()?0:1)}}Fi.EMPTY=null,Fi.RED=!0,Fi.BLACK=!1,Fi.EMPTY=new class{constructor(){this.size=0}get key(){throw Ir()}get value(){throw Ir()}get color(){throw Ir()}get left(){throw Ir()}get right(){throw Ir()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Fi(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Pi{constructor(t){this.comparator=t,this.data=new Oi(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(n){this.data.inorderTraversal((t,e)=>(n(t),!1))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Vi(this.data.getIterator())}getIteratorFrom(t){return new Vi(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof Pi))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(t){const e=new Pi(this.comparator);return e.data=t,e}}class Vi{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}const Ui=new Oi(is.comparator);const qi=new Oi(is.comparator);const Bi=new Oi(is.comparator);const ji=new Pi(is.comparator);function Ki(...t){let e=ji;for(const n of t)e=e.add(n);return e}const $i=new Pi(Fr);class Gi{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,zi.createSynthesizedTargetChangeForCurrentChange(t,e)),new Gi(qr.min(),n,$i,Ui,Ki())}}class zi{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new zi(Wr.EMPTY_BYTE_STRING,e,Ki(),Ki(),Ki())}}class Hi{constructor(t,e,n,r){this.k=t,this.removedTargetIds=e,this.key=n,this.$=r}}class Qi{constructor(t,e){this.targetId=t,this.O=e}}class Wi{constructor(t,e,n=Wr.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class Yi{constructor(){this.F=0,this.M=Zi(),this.L=Wr.EMPTY_BYTE_STRING,this.B=!1,this.U=!0}get current(){return this.B}get resumeToken(){return this.L}get q(){return 0!==this.F}get K(){return this.U}j(t){0<t.approximateByteSize()&&(this.U=!0,this.L=t)}W(){let n=Ki(),r=Ki(),s=Ki();return this.M.forEach((t,e)=>{switch(e){case 0:n=n.add(t);break;case 2:r=r.add(t);break;case 1:s=s.add(t);break;default:Ir()}}),new zi(this.L,this.B,n,r,s)}G(){this.U=!1,this.M=Zi()}H(t,e){this.U=!0,this.M=this.M.insert(t,e)}J(t){this.U=!0,this.M=this.M.remove(t)}Y(){this.F+=1}X(){--this.F}Z(){this.U=!0,this.B=!0}}class Ji{constructor(t){this.tt=t,this.et=new Map,this.nt=Ui,this.st=Xi(),this.it=new Pi(Fr)}rt(t){for(const e of t.k)t.$&&t.$.isFoundDocument()?this.ot(e,t.$):this.at(e,t.key,t.$);for(const n of t.removedTargetIds)this.at(n,t.key,t.$)}ct(n){this.forEachTarget(n,t=>{const e=this.ut(t);switch(n.state){case 0:this.ht(t)&&e.j(n.resumeToken);break;case 1:e.X(),e.q||e.G(),e.j(n.resumeToken);break;case 2:e.X(),e.q||this.removeTarget(t);break;case 3:this.ht(t)&&(e.Z(),e.j(n.resumeToken));break;case 4:this.ht(t)&&(this.lt(t),e.j(n.resumeToken));break;default:Ir()}})}forEachTarget(t,n){0<t.targetIds.length?t.targetIds.forEach(n):this.et.forEach((t,e)=>{this.ht(e)&&n(e)})}ft(t){const e=t.targetId,n=t.O.count,r=this.dt(e);if(r){const t=r.target;if(Ss(t))if(0===n){const n=new is(t.path);this.at(e,n,bs.newNoDocument(n,qr.min()))}else _r(1===n);else this.wt(e)!==n&&(this.lt(e),this.it=this.it.add(e))}}_t(r){const s=new Map;this.et.forEach((t,e)=>{var n=this.dt(e);if(n){if(t.current&&Ss(n.target)){const s=new is(n.target.path);null!==this.nt.get(s)||this.gt(e,s)||this.at(e,s,bs.newNoDocument(s,r))}t.K&&(s.set(e,t.W()),t.G())}});let i=Ki();this.st.forEach((t,e)=>{let n=!0;e.forEachWhile(t=>{t=this.dt(t);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(t))});var t=new Gi(r,s,this.it,this.nt,i);return this.nt=Ui,this.st=Xi(),this.it=new Pi(Fr),t}ot(t,e){var n;this.ht(t)&&(n=this.gt(t,e.key)?2:0,this.ut(t).H(e.key,n),this.nt=this.nt.insert(e.key,e),this.st=this.st.insert(e.key,this.yt(e.key).add(t)))}at(t,e,n){if(this.ht(t)){const r=this.ut(t);this.gt(t,e)?r.H(e,1):r.J(e),this.st=this.st.insert(e,this.yt(e).delete(t)),n&&(this.nt=this.nt.insert(e,n))}}removeTarget(t){this.et.delete(t)}wt(t){var e=this.ut(t).W();return this.tt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Y(t){this.ut(t).Y()}ut(t){let e=this.et.get(t);return e||(e=new Yi,this.et.set(t,e)),e}yt(t){let e=this.st.get(t);return e||(e=new Pi(Fr),this.st=this.st.insert(t,e)),e}ht(t){var e=null!==this.dt(t);return e||vr("WatchChangeAggregator","Detected inactive target",t),e}dt(t){var e=this.et.get(t);return e&&e.q?null:this.tt.Tt(t)}lt(e){this.et.set(e,new Yi),this.tt.getRemoteKeysForTarget(e).forEach(t=>{this.at(e,t,null)})}gt(t,e){return this.tt.getRemoteKeysForTarget(t).has(e)}}function Xi(){return new Oi(is.comparator)}function Zi(){return new Oi(is.comparator)}const to={asc:"ASCENDING",desc:"DESCENDING"},eo={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class no{constructor(t,e){this.databaseId=t,this.D=e}}function ro(t,e){return t.D?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function so(t,e){return t.D?e.toBase64():e.toUint8Array()}function io(t){return _r(!!t),qr.fromTimestamp((t=Jr(t),new Ur(t.seconds,t.nanos)))}function oo(t,e){return t=t,new Gr(["projects",t.projectId,"databases",t.database]).child("documents").child(e).canonicalString()}function ao(t){t=Gr.fromString(t);return _r(Do(t)),t}function ho(t,e){return oo(t.databaseId,e.path)}function uo(t,e){const n=ao(e);if(n.get(1)!==t.databaseId.projectId)throw new Nr(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Nr(Sr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new is(go(n))}function co(t,e){return oo(t.databaseId,e)}function lo(t){t=ao(t);return 4===t.length?Gr.emptyPath():go(t)}function fo(t){return new Gr(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function go(t){return _r(4<t.length&&"documents"===t.get(4)),t.popFirst(5)}function mo(t,e,n){return{name:ho(t,e),fields:n.value.mapValue.fields}}function po(t,e,n){const r=uo(t,e.name),s=io(e.updateTime),i=new vs({mapValue:{fields:e.fields}}),o=bs.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function yo(t,e){let n;if(e instanceof _i)n={update:mo(t,e.key,e.value)};else if(e instanceof Ci)n={delete:ho(t,e.key)};else if(e instanceof Si)n={update:mo(t,e.key,e.data),updateMask:function(t){const e=[];return t.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}(e.fieldMask)};else{if(!(e instanceof xi))return Ir();n={verify:ho(t,e.key)}}return 0<e.fieldTransforms.length&&(n.updateTransforms=e.fieldTransforms.map(t=>function(t){var e=t.transform;if(e instanceof ai)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof hi)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:e.elements}};if(e instanceof ci)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:e.elements}};if(e instanceof di)return{fieldPath:t.field.canonicalString(),increment:e.C};throw Ir()}(t))),e.precondition.isNone||(n.currentDocument=void 0!==(r=e.precondition).updateTime?{updateTime:(e=r.updateTime,ro(t,e.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Ir()),n;var r}function wo(e,n){const t=n.currentDocument?void 0!==(i=n.currentDocument).updateTime?yi.updateTime(io(i.updateTime)):void 0!==i.exists?yi.exists(i.exists):yi.none():yi.none(),r=n.updateTransforms?n.updateTransforms.map(t=>function(t,e){let n=null;if("setToServerValue"in e)_r("REQUEST_TIME"===e.setToServerValue),n=new ai;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new hi(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ci(t)}else"increment"in e?n=new di(t,e.increment):Ir();e=Hr.fromServerFormat(e.fieldPath);return new mi(e,n)}(e,t)):[];if(n.update){n.update.name;var s=uo(e,n.update.name),i=new vs({mapValue:{fields:n.update.fields}});if(n.updateMask){const e=function(){const t=n.updateMask.fieldPaths||[];return new Qr(t.map(t=>Hr.fromServerFormat(t)))}();return new Si(s,i,e,t,r)}return new _i(s,i,t,r)}if(n.delete){const r=uo(e,n.delete);return new Ci(r,t)}if(n.verify){const r=uo(e,n.verify);return new xi(r,t)}return Ir()}function vo(t,e){return{documents:[co(t,e.path)]}}function bo(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=co(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=co(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(t){if(0!==t.length){t=t.map(t=>function(t){if("=="===t.op){if(ps(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NAN"}};if(ms(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(ps(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NOT_NAN"}};if(ms(t.value))return{unaryFilter:{field:_o(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:_o(t.field),op:(e=t.op,eo[e]),value:t.value}};var e}(t));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(e.filters);s&&(n.structuredQuery.where=s);s=function(t){if(0!==t.length)return t.map(t=>function(t){return{field:_o(t.field),direction:(t=t.dir,to[t])}}(t))}(e.orderBy);s&&(n.structuredQuery.orderBy=s);s=e.limit,s=t.D||ns(s)?s:{value:s};return null!==s&&(n.structuredQuery.limit=s),e.startAt&&(n.structuredQuery.startAt=Eo(e.startAt)),e.endAt&&(n.structuredQuery.endAt=Eo(e.endAt)),n}function To(t){let e=lo(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){_r(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function e(t){return t?void 0!==t.unaryFilter?[Ao(t)]:void 0!==t.fieldFilter?[No(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>e(t)).reduce((t,e)=>t.concat(e)):Ir():[]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(t=>function(t){return new Ps(So(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(t)));let a=null;n.limit&&(a=function(t){t="object"==typeof t?t.value:t;return ns(t)?null:t}(n.limit));let h=null;n.startAt&&(h=Io(n.startAt));let u=null;return n.endAt&&(u=Io(n.endAt)),Bs(e,s,o,i,a,"F",h,u)}function Eo(t){return{before:t.before,values:t.position}}function Io(t){var e=!!t.before,t=t.values||[];return new Ms(t,e)}function _o(t){return{fieldPath:t.canonicalString()}}function So(t){return Hr.fromServerFormat(t.fieldPath)}function No(t){return Ns.create(So(t.fieldFilter.field),function(){switch(t.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ir()}}(),t.fieldFilter.value)}function Ao(t){switch(t.unaryFilter.op){case"IS_NAN":var e=So(t.unaryFilter.field);return Ns.create(e,"==",{doubleValue:NaN});case"IS_NULL":e=So(t.unaryFilter.field);return Ns.create(e,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=So(t.unaryFilter.field);return Ns.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=So(t.unaryFilter.field);return Ns.create(n,"!=",{nullValue:"NULL_VALUE"});default:return Ir()}}function Do(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)}function Co(e){let n="";for(let t=0;t<e.length;t++)0<n.length&&(n=xo(n)),n=function(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(t),n);return xo(n)}function xo(t){return t+""}function ko(n){const r=n.length;if(_r(2<=r),2===r)return _r(""===n.charAt(0)&&""===n.charAt(1)),Gr.emptyPath();const s=r-2,i=[];let o="";for(let e=0;e<r;){const r=n.indexOf("",e);switch((r<0||r>s)&&Ir(),n.charAt(r+1)){case"":const s=n.substring(e,r);let t;0===o.length?t=s:(o+=s,t=o,o=""),i.push(t);break;case"":o+=n.substring(e,r),o+="\0";break;case"":o+=n.substring(e,r+1);break;default:Ir()}e=r+2}return new Gr(i)}class Ro{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class Lo{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}Lo.store="owner",Lo.key="owner";class Oo{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}Oo.store="mutationQueues",Oo.keyPath="userId";class Mo{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}Mo.store="mutations",Mo.keyPath="batchId",Mo.userMutationsIndex="userMutationsIndex",Mo.userMutationsKeyPath=["userId","batchId"];class Fo{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Co(e)]}static key(t,e,n){return[t,Co(e),n]}}Fo.store="documentMutations",Fo.PLACEHOLDER=new Fo;class Po{constructor(t,e){this.path=t,this.readTime=e}}class Vo{constructor(t,e){this.path=t,this.version=e}}class Uo{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}Uo.store="remoteDocuments",Uo.readTimeIndex="readTimeIndex",Uo.readTimeIndexPath="readTime",Uo.collectionReadTimeIndex="collectionReadTimeIndex",Uo.collectionReadTimeIndexPath=["parentPath","readTime"];class qo{constructor(t){this.byteSize=t}}qo.store="remoteDocumentGlobal",qo.key="remoteDocumentGlobalKey";class Bo{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}Bo.store="targets",Bo.keyPath="targetId",Bo.queryTargetsIndexName="queryTargetsIndex",Bo.queryTargetsKeyPath=["canonicalId","targetId"];class jo{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}jo.store="targetDocuments",jo.keyPath=["targetId","path"],jo.documentTargetsIndex="documentTargetsIndex",jo.documentTargetsKeyPath=["path","targetId"];class Ko{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}Ko.key="targetGlobalKey",Ko.store="targetGlobal";class $o{constructor(t,e){this.collectionId=t,this.parent=e}}$o.store="collectionParents",$o.keyPath=["collectionId","parent"];class Go{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}Go.store="clientMetadata",Go.keyPath="clientId";class zo{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}zo.store="bundles",zo.keyPath="bundleId";class Ho{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Ho.store="namedQueries",Ho.keyPath="name";const Qo=[Oo.store,Mo.store,Fo.store,Uo.store,Bo.store,Lo.store,Ko.store,jo.store,Go.store,qo.store,$o.store,zo.store,Ho.store],Wo="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Yo{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}class Jo{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(t){return this.next(void 0,t)}next(r,s){return this.callbackAttached&&Ir(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new Jo((e,n)=>{this.nextCallback=t=>{this.wrapSuccess(r,t).next(e,n)},this.catchCallback=t=>{this.wrapFailure(s,t).next(e,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{var e=t();return e instanceof Jo?e:Jo.resolve(e)}catch(t){return Jo.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):Jo.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):Jo.reject(e)}static resolve(n){return new Jo((t,e)=>{t(n)})}static reject(n){return new Jo((t,e)=>{e(n)})}static waitFor(t){return new Jo((e,n)=>{let r=0,s=0,i=!1;t.forEach(t=>{++r,t.next(()=>{++s,i&&s===r&&e()},t=>n(t))}),i=!0,s===r&&e()})}static or(t){let e=Jo.resolve(!1);for(const n of t)e=e.next(t=>t?Jo.resolve(t):n());return e}static forEach(t,n){const r=[];return t.forEach((t,e)=>{r.push(n.call(this,t,e))}),this.waitFor(r)}}class Xo{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.Et=new Ar,this.transaction.oncomplete=()=>{this.Et.resolve()},this.transaction.onabort=()=>{t.error?this.Et.reject(new ea(e,t.error)):this.Et.resolve()},this.transaction.onerror=t=>{t=oa(t.target.error);this.Et.reject(new ea(e,t))}}static open(t,e,n,r){try{return new Xo(e,t.transaction(r,n))}catch(t){throw new ea(e,t)}}get It(){return this.Et.promise}abort(t){t&&this.Et.reject(t),this.aborted||(vr("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}store(t){t=this.transaction.objectStore(t);return new ra(t)}}class Zo{constructor(t,e,n){this.name=t,this.version=e,this.At=n,12.2===Zo.Rt(d())&&br("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return vr("SimpleDb","Removing database:",t),sa(window.indexedDB.deleteDatabase(t)).toPromise()}static bt(){if("object"!=typeof indexedDB)return!1;if(Zo.Pt())return!0;const t=d(),e=Zo.Rt(t),n=0<e&&e<10,r=Zo.vt(t),s=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||s)}static Pt(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.Vt)}static St(t,e){return t.store(e)}static Rt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static vt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async Dt(s){return this.db||(vr("SimpleDb","Opening database:",this.name),this.db=await new Promise((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{t=t.target.result;e(t)},r.onblocked=()=>{n(new ea(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{t=t.target.error;"VersionError"===t.name?n(new Nr(Sr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?n(new Nr(Sr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):n(new ea(s,t))},r.onupgradeneeded=t=>{vr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;this.At.Ct(e,r.transaction,t.oldVersion,this.version).next(()=>{vr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Nt&&(this.db.onversionchange=t=>this.Nt(t)),this.db}xt(e){this.Nt=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(t,e,n,r){var s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.Dt(t);const e=Xo.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).catch(t=>(e.abort(t),Jo.reject(t))).toPromise();return i.catch(()=>{}),await e.It,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(vr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ta{constructor(t){this.kt=t,this.$t=!1,this.Ot=null}get isDone(){return this.$t}get Ft(){return this.Ot}set cursor(t){this.kt=t}done(){this.$t=!0}Mt(t){this.Ot=t}delete(){return sa(this.kt.delete())}}class ea extends Nr{constructor(t,e){super(Sr.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function na(t){return"IndexedDbTransactionError"===t.name}class ra{constructor(t){this.store=t}put(t,e){let n;return n=void 0!==e?(vr("SimpleDb","PUT",this.store.name,t,e),this.store.put(e,t)):(vr("SimpleDb","PUT",this.store.name,"<auto-key>",t),this.store.put(t)),sa(n)}add(t){return vr("SimpleDb","ADD",this.store.name,t,t),sa(this.store.add(t))}get(e){return sa(this.store.get(e)).next(t=>(vr("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t))}delete(t){return vr("SimpleDb","DELETE",this.store.name,t),sa(this.store.delete(t))}count(){return vr("SimpleDb","COUNT",this.store.name),sa(this.store.count())}Lt(t,e){const n=this.cursor(this.options(t,e)),r=[];return this.Bt(n,(t,e)=>{r.push(e)}).next(()=>r)}Ut(t,e){vr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.qt=!1;e=this.cursor(n);return this.Bt(e,(t,e,n)=>n.delete())}Kt(t,e){let n;e?n=t:(n={},e=t);t=this.cursor(n);return this.Bt(t,e)}jt(r){const t=this.cursor({});return new Jo((n,e)=>{t.onerror=t=>{t=oa(t.target.error);e(t)},t.onsuccess=t=>{const e=t.target.result;e?r(e.primaryKey,e.value).next(t=>{t?e.continue():n()}):n()}})}Bt(t,i){const o=[];return new Jo((s,e)=>{t.onerror=t=>{e(t.target.error)},t.onsuccess=t=>{const e=t.target.result;if(e){const n=new ta(e),r=i(e.primaryKey,e.value,n);if(r instanceof Jo){const t=r.catch(t=>(n.done(),Jo.reject(t)));o.push(t)}n.isDone?s():null===n.Ft?e.continue():e.continue(n.Ft)}else s()}}).next(()=>Jo.waitFor(o))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.qt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function sa(t){return new Jo((e,n)=>{t.onsuccess=t=>{t=t.target.result;e(t)},t.onerror=t=>{t=oa(t.target.error);n(t)}})}let ia=!1;function oa(t){const e=Zo.Rt(d());if(12.2<=e&&e<13){const e="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(e)){const t=new Nr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ia||(ia=!0,setTimeout(()=>{throw t},0)),t}}return t}class aa extends Yo{constructor(t,e){super(),this.Qt=t,this.currentSequenceNumber=e}}function ha(t,e){return Zo.St(t.Qt,e)}class ua{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&bi(r,e,n[t])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&Ti(e,t,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(t.key)&&Ti(n,t,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(t=>{const e=r.get(t.key),n=e;this.applyToLocalView(n),e.isValidDocument()||n.convertToNoDocument(qr.min())})}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),Ki())}isEqual(t){return this.batchId===t.batchId&&Pr(this.mutations,t.mutations,(t,e)=>Ei(t,e))&&Pr(this.baseMutations,t.baseMutations,(t,e)=>Ei(t,e))}}class ca{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){_r(t.mutations.length===n.length);let r=Bi;var s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new ca(t,e,n,r)}}class la{constructor(t,e,n,r,s=qr.min(),i=qr.min(),o=Wr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new la(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new la(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new la(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class da{constructor(t){this.Wt=t}}function fa(t,e){if(e.document)return po(t.Wt,e.document,!!e.hasCommittedMutations);if(e.noDocument){const t=is.fromSegments(e.noDocument.path),n=wa(e.noDocument.readTime),r=bs.newNoDocument(t,n);return e.hasCommittedMutations?r.setHasCommittedMutations():r}if(e.unknownDocument){const t=is.fromSegments(e.unknownDocument.path),s=wa(e.unknownDocument.version);return bs.newUnknownDocument(t,s)}return Ir()}function ga(t,e,n){var r=ma(n),s=e.key.path.popLast().toArray();if(e.isFoundDocument()){const i={name:ho(n=t.Wt,(t=e).key),fields:t.data.value.mapValue.fields,updateTime:ro(n,t.version.toTimestamp())},o=e.hasCommittedMutations;return new Uo(null,null,i,o,r,s)}if(e.isNoDocument()){const a=e.key.path.toArray(),i=ya(e.version),h=e.hasCommittedMutations;return new Uo(null,new Po(a,i),null,h,r,s)}if(e.isUnknownDocument()){const a=e.key.path.toArray(),i=ya(e.version);return new Uo(new Vo(a,i),null,null,!0,r,s)}return Ir()}function ma(t){t=t.toTimestamp();return[t.seconds,t.nanoseconds]}function pa(t){t=new Ur(t[0],t[1]);return qr.fromTimestamp(t)}function ya(t){t=t.toTimestamp();return new Ro(t.seconds,t.nanoseconds)}function wa(t){t=new Ur(t.seconds,t.nanoseconds);return qr.fromTimestamp(t)}function va(e,n){const r=(n.baseMutations||[]).map(t=>wo(e.Wt,t));for(let t=0;t<n.mutations.length-1;++t){const r=n.mutations[t];if(t+1<n.mutations.length&&void 0!==n.mutations[t+1].transform){const s=n.mutations[t+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(t+1,1),++t}}const s=n.mutations.map(t=>wo(e.Wt,t)),t=Ur.fromMillis(n.localWriteTimeMs);return new ua(n.batchId,t,r,s)}function ba(t){var e,n=wa(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?wa(t.lastLimboFreeSnapshotVersion):qr.min();let s;return s=void 0!==t.query.documents?(_r(1===(e=t.query).documents.length),Ws(js(lo(e.documents[0])))):Ws(To(t.query)),new la(s,t.targetId,0,t.lastListenSequenceNumber,n,r,Wr.fromBase64String(t.resumeToken))}function Ta(t,e){var n=ya(e.snapshotVersion),r=ya(e.lastLimboFreeSnapshotVersion),s=(Ss(e.target)?vo:bo)(t.Wt,e.target),t=e.resumeToken.toBase64();return new Bo(e.targetId,Is(e.target),n,t,e.sequenceNumber,r,s)}function Ea(t){var e=To({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Ys(e,e.limit,"L"):e}class Ia{getBundleMetadata(t,e){return _a(t).get(e).next(t=>{if(t)return{id:(t=t).bundleId,createTime:wa(t.createTime),version:t.version}})}saveBundleMetadata(t,e){return _a(t).put({bundleId:(e=e).id,createTime:ya(io(e.createTime)),version:e.version})}getNamedQuery(t,e){return Sa(t).get(e).next(t=>{if(t)return{name:(t=t).name,query:Ea(t.bundledQuery),readTime:wa(t.readTime)}})}saveNamedQuery(t,e){return Sa(t).put({name:(e=e).name,readTime:ya(io(e.readTime)),bundledQuery:e.bundledQuery})}}function _a(t){return ha(t,zo.store)}function Sa(t){return ha(t,Ho.store)}class Na{constructor(){this.Gt=new Aa}addToCollectionParentIndex(t,e){return this.Gt.add(e),Jo.resolve()}getCollectionParents(t,e){return Jo.resolve(this.Gt.getEntries(e))}}class Aa{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Pi(Gr.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Pi(Gr.comparator)).toArray()}}class Da{constructor(){this.zt=new Aa}addToCollectionParentIndex(t,e){if(this.zt.has(e))return Jo.resolve();var n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener(()=>{this.zt.add(e)});r={collectionId:n,parent:Co(r)};return Ca(t).put(r)}getCollectionParents(t,n){const r=[],e=IDBKeyRange.bound([n,""],[Vr(n),""],!1,!0);return Ca(t).Lt(e).next(t=>{for(const e of t){if(e.collectionId!==n)break;r.push(ko(e.parent))}return r})}}function Ca(t){return ha(t,$o.store)}const xa={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class ka{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new ka(t,ka.DEFAULT_COLLECTION_PERCENTILE,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ra(t,e,n){const r=t.store(Mo.store),s=t.store(Fo.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const h=r.Kt({range:o},(t,e,n)=>(a++,n.delete()));i.push(h.next(()=>{_r(1===a)}));const u=[];for(const t of n.mutations){const r=Fo.key(e,t.key.path,n.batchId);i.push(s.delete(r)),u.push(t.key)}return Jo.waitFor(i).next(()=>u)}function La(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ir();e=t.noDocument}return JSON.stringify(e).length}ka.DEFAULT_COLLECTION_PERCENTILE=10,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,ka.DEFAULT=new ka(41943040,ka.DEFAULT_COLLECTION_PERCENTILE,ka.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),ka.DISABLED=new ka(-1,0,0);class Oa{constructor(t,e,n,r){this.userId=t,this.N=e,this.Ht=n,this.referenceDelegate=r,this.Jt={}}static Yt(t,e,n,r){_r(""!==t.uid);t=t.isAuthenticated()?t.uid:"";return new Oa(t,e,n,r)}checkEmpty(t){let r=!0;var e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Fa(t).Kt({index:Mo.userMutationsIndex,range:e},(t,e,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(c,l,d,f){const g=Pa(c),m=Fa(c);return m.add({}).next(t=>{_r("number"==typeof t);const e=new ua(t,l,d,f),n=(s=this.N,i=this.userId,o=e,a=o.baseMutations.map(t=>yo(s.Wt,t)),h=o.mutations.map(t=>yo(s.Wt,t)),new Mo(i,o.batchId,o.localWriteTime.toMillis(),a,h)),r=[];var s,i,o,a,h;let u=new Pi((t,e)=>Fr(t.canonicalString(),e.canonicalString()));for(const c of f){const l=Fo.key(this.userId,c.key.path,t);u=u.add(c.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Fo.PLACEHOLDER))}return u.forEach(t=>{r.push(this.Ht.addToCollectionParentIndex(c,t))}),c.addOnCommittedListener(()=>{this.Jt[t]=e.keys()}),Jo.waitFor(r).next(()=>e)})}lookupMutationBatch(t,e){return Fa(t).get(e).next(t=>t?(_r(t.userId===this.userId),va(this.N,t)):null)}Xt(t,e){return this.Jt[e]?Jo.resolve(this.Jt[e]):this.lookupMutationBatch(t,e).next(t=>{if(t){t=t.keys();return this.Jt[e]=t}return null})}getNextMutationBatchAfterBatchId(t,e){const r=e+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return Fa(t).Kt({index:Mo.userMutationsIndex,range:n},(t,e,n)=>{e.userId===this.userId&&(_r(e.batchId>=r),s=va(this.N,e)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return Fa(t).Kt({index:Mo.userMutationsIndex,range:e,reverse:!0},(t,e,n)=>{r=e.batchId,n.done()}).next(()=>r)}getAllMutationBatches(t){var e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Fa(t).Lt(Mo.userMutationsIndex,e).next(t=>t.map(t=>va(this.N,t)))}getAllMutationBatchesAffectingDocumentKey(i,o){const t=Fo.prefixForPath(this.userId,o.path),e=IDBKeyRange.lowerBound(t),a=[];return Pa(i).Kt({range:e},(t,e,n)=>{var[r,s,t]=t,s=ko(s);if(r===this.userId&&o.path.isEqual(s))return Fa(i).get(t).next(t=>{if(!t)throw Ir();_r(t.userId===this.userId),a.push(va(this.N,t))});n.done()}).next(()=>a)}getAllMutationBatchesAffectingDocumentKeys(e,t){let o=new Pi(Fr);const n=[];return t.forEach(i=>{var t=Fo.prefixForPath(this.userId,i.path),t=IDBKeyRange.lowerBound(t),t=Pa(e).Kt({range:t},(t,e,n)=>{var[r,s,t]=t,s=ko(s);r===this.userId&&i.path.isEqual(s)?o=o.add(t):n.done()});n.push(t)}),Jo.waitFor(n).next(()=>this.Zt(e,o))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,o=i.length+1,n=Fo.prefixForPath(this.userId,i),r=IDBKeyRange.lowerBound(n);let a=new Pi(Fr);return Pa(t).Kt({range:r},(t,e,n)=>{var[r,s,t]=t,s=ko(s);r===this.userId&&i.isPrefixOf(s)?s.length===o&&(a=a.add(t)):n.done()}).next(()=>this.Zt(t,a))}Zt(e,t){const n=[],r=[];return t.forEach(t=>{r.push(Fa(e).get(t).next(t=>{if(null===t)throw Ir();_r(t.userId===this.userId),n.push(va(this.N,t))}))}),Jo.waitFor(r).next(()=>n)}removeMutationBatch(e,n){return Ra(e.Qt,this.userId,n).next(t=>(e.addOnCommittedListener(()=>{this.te(n.batchId)}),Jo.forEach(t,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}te(t){delete this.Jt[t]}performConsistencyCheck(n){return this.checkEmpty(n).next(t=>{if(!t)return Jo.resolve();const e=IDBKeyRange.lowerBound(Fo.prefixForUser(this.userId)),r=[];return Pa(n).Kt({range:e},(t,e,n)=>{if(t[0]===this.userId){const e=ko(t[1]);r.push(e)}else n.done()}).next(()=>{_r(0===r.length)})})}containsKey(t,e){return Ma(t,this.userId,e)}ee(t){return Va(t).get(this.userId).next(t=>t||new Oo(this.userId,-1,""))}}function Ma(t,s,e){const n=Fo.prefixForPath(s,e.path),i=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return Pa(t).Kt({range:r,qt:!0},(t,e,n)=>{var[r,t]=t;r===s&&t===i&&(o=!0),n.done()}).next(()=>o)}function Fa(t){return ha(t,Mo.store)}function Pa(t){return ha(t,Fo.store)}function Va(t){return ha(t,Oo.store)}class Ua{constructor(t){this.ne=t}next(){return this.ne+=2,this.ne}static se(){return new Ua(0)}static ie(){return new Ua(-1)}}class qa{constructor(t,e){this.referenceDelegate=t,this.N=e}allocateTargetId(n){return this.re(n).next(t=>{const e=new Ua(t.highestTargetId);return t.highestTargetId=e.next(),this.oe(n,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.re(t).next(t=>qr.fromTimestamp(new Ur(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.re(t).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,n,r){return this.re(e).next(t=>(t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),this.oe(e,t)))}addTargetData(e,n){return this.ae(e,n).next(()=>this.re(e).next(t=>(t.targetCount+=1,this.ce(n,t),this.oe(e,t))))}updateTargetData(t,e){return this.ae(t,e)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Ba(e).delete(t.targetId)).next(()=>this.re(e)).next(t=>(_r(0<t.targetCount),--t.targetCount,this.oe(e,t)))}removeTargets(n,r,s){let i=0;const o=[];return Ba(n).Kt((t,e)=>{e=ba(e);e.sequenceNumber<=r&&null===s.get(e.targetId)&&(i++,o.push(this.removeTargetData(n,e)))}).next(()=>Jo.waitFor(o)).next(()=>i)}forEachTarget(t,n){return Ba(t).Kt((t,e)=>{e=ba(e);n(e)})}re(t){return ja(t).get(Ko.key).next(t=>(_r(null!==t),t))}oe(t,e){return ja(t).put(Ko.key,e)}ae(t,e){return Ba(t).put(Ta(this.N,e))}ce(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.re(t).next(t=>t.targetCount)}getTargetData(t,r){var e=Is(r),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]);let s=null;return Ba(t).Kt({range:e,index:Bo.queryTargetsIndexName},(t,e,n)=>{e=ba(e);_s(r,e.target)&&(s=e,n.done())}).next(()=>s)}addMatchingKeys(n,t,r){const s=[],i=Ka(n);return t.forEach(t=>{var e=Co(t.path);s.push(i.put(new jo(r,e))),s.push(this.referenceDelegate.addReference(n,r,t))}),Jo.waitFor(s)}removeMatchingKeys(n,t,r){const s=Ka(n);return Jo.forEach(t,t=>{var e=Co(t.path);return Jo.waitFor([s.delete([r,e]),this.referenceDelegate.removeReference(n,r,t)])})}removeMatchingKeysForTargetId(t,e){const n=Ka(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=Ka(t);let s=Ki();return r.Kt({range:n,qt:!0},(t,e,n)=>{t=ko(t[1]),t=new is(t);s=s.add(t)}).next(()=>s)}containsKey(t,e){e=Co(e.path),e=IDBKeyRange.bound([e],[Vr(e)],!1,!0);let r=0;return Ka(t).Kt({index:jo.documentTargetsIndex,qt:!0,range:e},([t],e,n)=>{0!==t&&(r++,n.done())}).next(()=>0<r)}Tt(t,e){return Ba(t).get(e).next(t=>t?ba(t):null)}}function Ba(t){return ha(t,Bo.store)}function ja(t){return ha(t,Ko.store)}function Ka(t){return ha(t,jo.store)}async function $a(t){if(t.code!==Sr.FAILED_PRECONDITION||t.message!==Wo)throw t;vr("LocalStore","Unexpectedly lost primary lease")}function Ga([t,e],[n,r]){n=Fr(t,n);return 0===n?Fr(e,r):n}class za{constructor(t){this.ue=t,this.buffer=new Pi(Ga),this.he=0}le(){return++this.he}fe(t){t=[t,this.le()];if(this.buffer.size<this.ue)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Ga(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Ha{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.de=!1,this.we=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this._e(t)}stop(){this.we&&(this.we.cancel(),this.we=null)}get started(){return null!==this.we}_e(t){var e=this.de?3e5:6e4;vr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.we=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.we=null,this.de=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){na(t)?vr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await $a(t)}await this._e(t)})}}class Qa{constructor(t,e){this.me=t,this.params=e}calculateTargetCount(t,e){return this.me.ge(t).next(t=>Math.floor(e/100*t))}nthSequenceNumber(t,e){if(0===e)return Jo.resolve(Or.T);const n=new za(e);return this.me.forEachTarget(t,t=>n.fe(t.sequenceNumber)).next(()=>this.me.ye(t,t=>n.fe(t))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.me.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.me.removeOrphanedDocuments(t,e)}collect(e,n){return-1===this.params.cacheSizeCollectionThreshold?(vr("LruGarbageCollector","Garbage collection skipped; disabled"),Jo.resolve(xa)):this.getCacheSize(e).next(t=>t<this.params.cacheSizeCollectionThreshold?(vr("LruGarbageCollector",`Garbage collection skipped; Cache size ${t} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),xa):this.pe(e,n))}getCacheSize(t){return this.me.getCacheSize(t)}pe(e,n){let r,s,i,o,a,h,u;const c=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(s=t>this.params.maximumSequenceNumbersToCollect?(vr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,o=Date.now(),this.nthSequenceNumber(e,s))).next(t=>(r=t,a=Date.now(),this.removeTargets(e,r,n))).next(t=>(i=t,h=Date.now(),this.removeOrphanedDocuments(e,r))).next(t=>(u=Date.now(),wr()<=l.DEBUG&&vr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-c}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${i} targets in `+(h-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-h)+"ms\n"+`Total Duration: ${u-c}ms`),Jo.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:t})))}}class Wa{constructor(t,e){this.db=t,this.garbageCollector=(t=this,e=e,new Qa(t,e))}ge(t){const n=this.Te(t);return this.db.getTargetCache().getTargetCount(t).next(e=>n.next(t=>e+t))}Te(t){let e=0;return this.ye(t,t=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ye(t,n){return this.Ee(t,(t,e)=>n(e))}addReference(t,e,n){return Ya(t,n)}removeReference(t,e,n){return Ya(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Ya(t,e)}Ie(e,n){let r=!1;return Va(e).jt(t=>Ma(e,t,n).next(t=>(t&&(r=!0),Jo.resolve(!t)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this.Ee(n,(e,t)=>{if(t<=r){const r=this.Ie(n,e).next(t=>{if(!t)return o++,s.getEntry(n,e).next(()=>(s.removeEntry(e),Ka(n).delete([0,Co(e.path)])))});i.push(r)}}).next(()=>Jo.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(t,e){e=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,e)}updateLimboDocument(t,e){return Ya(t,e)}Ee(t,r){const e=Ka(t);let s,i=Or.T;return e.Kt({index:jo.documentTargetsIndex},([t],{path:e,sequenceNumber:n})=>{0===t?(i!==Or.T&&r(new is(ko(s)),i),i=n,s=e):i=Or.T}).next(()=>{i!==Or.T&&r(new is(ko(s)),i)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Ya(t,e){return Ka(t).put((e=e,t=t.currentSequenceNumber,new jo(0,Co(e.path),t)))}class Ja{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(e,n){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return void(r[t]=[e,n]);r.push([e,n])}else this.inner[t]=[[e,n]]}delete(e){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return!1;for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return 1===r.length?delete this.inner[n]:r.splice(t,1),!0;return!1}forEach(r){jr(this.inner,(t,e)=>{for(const[t,n]of e)r(t,n)})}isEmpty(){return Kr(this.inner)}}class Xa{constructor(){this.changes=new Ja(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}getReadTime(t){t=this.changes.get(t);return t?t.readTime:qr.min()}addEntry(t,e){this.assertNotApplied(),this.changes.set(t.key,{document:t,readTime:e})}removeEntry(t,e=null){this.assertNotApplied(),this.changes.set(t,{document:bs.newInvalidDocument(t),readTime:e})}getEntry(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?Jo.resolve(n.document):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Za{constructor(t,e){this.N=t,this.Ht=e}addEntry(t,e,n){return nh(t).put(rh(e),n)}removeEntry(t,e){const n=nh(t),r=rh(e);return n.delete(r)}updateMetadata(e,n){return this.getMetadata(e).next(t=>(t.byteSize+=n,this.Ae(e,t)))}getEntry(t,e){return nh(t).get(rh(e)).next(t=>this.Re(e,t))}be(t,e){return nh(t).get(rh(e)).next(t=>({document:this.Re(e,t),size:La(t)}))}getEntries(t,e){let n=Ui;return this.Pe(t,e,(t,e)=>{e=this.Re(t,e);n=n.insert(t,e)}).next(()=>n)}ve(t,e){let r=Ui,s=new Oi(is.comparator);return this.Pe(t,e,(t,e)=>{var n=this.Re(t,e);r=r.insert(t,n),s=s.insert(t,La(e))}).next(()=>({documents:r,Ve:s}))}Pe(t,e,s){if(e.isEmpty())return Jo.resolve();const n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator();let o=i.getNext();return nh(t).Kt({range:n},(t,e,n)=>{for(var r=is.fromSegments(t);o&&is.comparator(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,e),o=i.hasNext()?i.getNext():null),o?n.Mt(o.path.toArray()):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getDocumentsMatchingQuery(t,r,e){let s=Ui;const i=r.path.length+1,n={};if(e.isEqual(qr.min())){const t=r.path.toArray();n.range=IDBKeyRange.lowerBound(t)}else{const t=r.path.toArray(),s=ma(e);n.range=IDBKeyRange.lowerBound([t,s],!0),n.index=Uo.collectionReadTimeIndex}return nh(t).Kt(n,(t,e,n)=>{t.length===i&&(e=fa(this.N,e),r.path.isPrefixOf(e.key.path)?ti(r,e)&&(s=s.insert(e.key,e)):n.done())}).next(()=>s)}newChangeBuffer(t){return new th(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return eh(t).get(qo.key).next(t=>(_r(!!t),t))}Ae(t,e){return eh(t).put(qo.key,e)}Re(t,e){if(e){const t=fa(this.N,e);if(!t.isNoDocument()||!t.version.isEqual(qr.min()))return t}return bs.newInvalidDocument(t)}}class th extends Xa{constructor(t,e){super(),this.Se=t,this.trackRemovals=e,this.De=new Ja(t=>t.toString(),(t,e)=>t.isEqual(e))}applyChanges(s){const i=[];let o=0,a=new Pi((t,e)=>Fr(t.canonicalString(),e.canonicalString()));return this.changes.forEach((t,e)=>{var n=this.De.get(t);if(e.document.isValidDocument()){var r=ga(this.Se.N,e.document,this.getReadTime(t));a=a.add(t.path.popLast());e=La(r);o+=e-n,i.push(this.Se.addEntry(s,t,r))}else if(o-=n,this.trackRemovals){const o=ga(this.Se.N,bs.newNoDocument(t,qr.min()),this.getReadTime(t));i.push(this.Se.addEntry(s,t,o))}else i.push(this.Se.removeEntry(s,t))}),a.forEach(t=>{i.push(this.Se.Ht.addToCollectionParentIndex(s,t))}),i.push(this.Se.updateMetadata(s,o)),Jo.waitFor(i)}getFromCache(t,e){return this.Se.be(t,e).next(t=>(this.De.set(e,t.size),t.document))}getAllFromCache(t,e){return this.Se.ve(t,e).next(({documents:t,Ve:e})=>(e.forEach((t,e)=>{this.De.set(t,e)}),t))}}function eh(t){return ha(t,qo.store)}function nh(t){return ha(t,Uo.store)}function rh(t){return t.path.toArray()}class sh{constructor(t){this.N=t}Ct(e,n,t,r){_r(t<r&&0<=t&&r<=11);const s=new Xo("createOrUpgrade",n);var i;t<1&&1<=r&&(e.createObjectStore(Lo.store),(i=e).createObjectStore(Oo.store,{keyPath:Oo.keyPath}),i.createObjectStore(Mo.store,{keyPath:Mo.keyPath,autoIncrement:!0}).createIndex(Mo.userMutationsIndex,Mo.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Fo.store),ih(e),e.createObjectStore(Uo.store));let o=Jo.resolve();return t<3&&3<=r&&(0!==t&&((i=e).deleteObjectStore(jo.store),i.deleteObjectStore(Bo.store),i.deleteObjectStore(Ko.store),ih(e)),o=o.next(()=>function(){const t=s.store(Ko.store),e=new Ko(0,0,qr.min().toTimestamp(),0);return t.put(Ko.key,e)}())),t<4&&4<=r&&(0!==t&&(o=o.next(()=>function(r,s){return s.store(Mo.store).Lt().next(t=>{r.deleteObjectStore(Mo.store),r.createObjectStore(Mo.store,{keyPath:Mo.keyPath,autoIncrement:!0}).createIndex(Mo.userMutationsIndex,Mo.userMutationsKeyPath,{unique:!0});const e=s.store(Mo.store),n=t.map(t=>e.put(t));return Jo.waitFor(n)})}(e,s))),o=o.next(()=>{e.createObjectStore(Go.store,{keyPath:Go.keyPath})})),t<5&&5<=r&&(o=o.next(()=>this.Ce(s))),t<6&&6<=r&&(o=o.next(()=>(e.createObjectStore(qo.store),this.Ne(s)))),t<7&&7<=r&&(o=o.next(()=>this.xe(s))),t<8&&8<=r&&(o=o.next(()=>this.ke(e,s))),t<9&&9<=r&&(o=o.next(()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges"),function(){const t=n.objectStore(Uo.store);t.createIndex(Uo.readTimeIndex,Uo.readTimeIndexPath,{unique:!1}),t.createIndex(Uo.collectionReadTimeIndex,Uo.collectionReadTimeIndexPath,{unique:!1})}()})),t<10&&10<=r&&(o=o.next(()=>this.$e(s))),t<11&&11<=r&&(o=o.next(()=>{e.createObjectStore(zo.store,{keyPath:zo.keyPath}),e.createObjectStore(Ho.store,{keyPath:Ho.keyPath})})),o}Ne(e){let n=0;return e.store(Uo.store).Kt((t,e)=>{n+=La(e)}).next(()=>{var t=new qo(n);return e.store(qo.store).put(qo.key,t)})}Ce(n){const t=n.store(Oo.store),r=n.store(Mo.store);return t.Lt().next(t=>Jo.forEach(t,e=>{var t=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return r.Lt(Mo.userMutationsIndex,t).next(t=>Jo.forEach(t,t=>{_r(t.userId===e.userId);t=va(this.N,t);return Ra(n,e.userId,t).next(()=>{})}))}))}xe(t){const o=t.store(jo.store),e=t.store(Uo.store);return t.store(Ko.store).get(Ko.key).next(s=>{const i=[];return e.Kt((t,e)=>{const n=new Gr(t),r=[0,Co(n)];i.push(o.get(r).next(t=>t?Jo.resolve():(t=>o.put(new jo(0,Co(t),s.highestListenSequenceNumber)))(n)))}).next(()=>Jo.waitFor(i))})}ke(t,e){t.createObjectStore($o.store,{keyPath:$o.keyPath});const n=e.store($o.store),r=new Aa,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Co(r)})}};return e.store(Uo.store).Kt({qt:!0},(t,e)=>{const n=new Gr(t);return s(n.popLast())}).next(()=>e.store(Fo.store).Kt({qt:!0},([,t],e)=>{const n=ko(t);return s(n.popLast())}))}$e(t){const n=t.store(Bo.store);return n.Kt((t,e)=>{e=ba(e),e=Ta(this.N,e);return n.put(e)})}}function ih(t){t.createObjectStore(jo.store,{keyPath:jo.keyPath}).createIndex(jo.documentTargetsIndex,jo.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Bo.store,{keyPath:Bo.keyPath}).createIndex(Bo.queryTargetsIndexName,Bo.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Ko.store)}const oh="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class ah{constructor(t,e,n,r,s,i,o,a,h,u){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Oe=s,this.window=i,this.document=o,this.Fe=h,this.Me=u,this.Le=null,this.Be=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Ue=null,this.inForeground=!1,this.qe=null,this.Ke=null,this.je=Number.NEGATIVE_INFINITY,this.Qe=t=>Promise.resolve(),!ah.bt())throw new Nr(Sr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Wa(this,r),this.We=e+"main",this.N=new da(a),this.Ge=new Zo(this.We,11,new sh(this.N)),this.ze=new qa(this.referenceDelegate,this.N),this.Ht=new Da,this.He=(e=this.N,a=this.Ht,new Za(e,a)),this.Je=new Ia,this.window&&this.window.localStorage?this.Ye=this.window.localStorage:(this.Ye=null,!1===u&&br("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Xe().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Nr(Sr.FAILED_PRECONDITION,oh);return this.Ze(),this.tn(),this.en(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.ze.getHighestSequenceNumber(t))}).then(t=>{this.Le=new Or(t,this.Fe)}).then(()=>{this.Be=!0}).catch(t=>(this.Ge&&this.Ge.close(),Promise.reject(t)))}nn(e){return this.Qe=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ge.xt(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Oe.enqueueAndForget(async()=>{this.started&&await this.Xe()}))}Xe(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>uh(e).put(new Go(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.sn(e).next(t=>{t||(this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)))})}).next(()=>this.rn(e)).next(t=>this.isPrimary&&!t?this.on(e).next(()=>!1):!!t&&this.an(e).next(()=>!0))).catch(t=>{if(na(t))return vr("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return vr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.Oe.enqueueRetryable(()=>this.Qe(t)),this.isPrimary=t})}sn(t){return hh(t).get(Lo.key).next(t=>Jo.resolve(this.cn(t)))}un(t){return uh(t).delete(this.clientId)}async hn(){if(this.isPrimary&&!this.ln(this.je,18e5)){this.je=Date.now();var t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{const r=ha(t,Go.store);return r.Lt().next(t=>{const e=this.fn(t,18e5),n=t.filter(t=>-1===e.indexOf(t));return Jo.forEach(n,t=>r.delete(t.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Ye)for(const e of t)this.Ye.removeItem(this.dn(e.clientId))}}en(){this.Ke=this.Oe.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Xe().then(()=>this.hn()).then(()=>this.en()))}cn(t){return!!t&&t.ownerId===this.clientId}rn(e){return this.Me?Jo.resolve(!0):hh(e).get(Lo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)){if(this.cn(t)&&this.networkEnabled)return!0;if(!this.cn(t)){if(!t.allowTabSynchronization)throw new Nr(Sr.FAILED_PRECONDITION,oh);return!1}}return!(!this.networkEnabled||!this.inForeground)||uh(e).Lt().next(t=>void 0===this.fn(t,5e3).find(t=>{if(this.clientId!==t.clientId){var e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,t=this.networkEnabled===t.networkEnabled;if(e||n&&t)return!0}return!1}))}).next(t=>(this.isPrimary!==t&&vr("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async shutdown(){this.Be=!1,this._n(),this.Ke&&(this.Ke.cancel(),this.Ke=null),this.mn(),this.gn(),await this.Ge.runTransaction("shutdown","readwrite",[Lo.store,Go.store],t=>{const e=new aa(t,Or.T);return this.on(e).next(()=>this.un(e))}),this.Ge.close(),this.yn()}fn(t,e){return t.filter(t=>this.ln(t.updateTimeMs,e)&&!this.wn(t.clientId))}pn(){return this.runTransaction("getActiveClients","readonly",t=>uh(t).Lt().next(t=>this.fn(t,18e5).map(t=>t.clientId)))}get started(){return this.Be}getMutationQueue(t){return Oa.Yt(t,this.N,this.Ht,this.referenceDelegate)}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getIndexManager(){return this.Ht}getBundleCache(){return this.Je}runTransaction(e,n,r){vr("IndexedDbPersistence","Starting transaction:",e);let s;return this.Ge.runTransaction(e,"readonly"===n?"readonly":"readwrite",Qo,t=>(s=new aa(t,this.Le?this.Le.next():Or.T),"readwrite-primary"===n?this.sn(s).next(t=>!!t||this.rn(s)).next(t=>{if(!t)throw br(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Oe.enqueueRetryable(()=>this.Qe(!1)),new Nr(Sr.FAILED_PRECONDITION,Wo);return r(s)}).next(t=>this.an(s).next(()=>t)):this.Tn(s).next(()=>r(s)))).then(t=>(s.raiseOnCommittedEvent(),t))}Tn(t){return hh(t).get(Lo.key).next(t=>{if(null!==t&&this.ln(t.leaseTimestampMs,5e3)&&!this.wn(t.ownerId)&&!this.cn(t)&&!(this.Me||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Nr(Sr.FAILED_PRECONDITION,oh)})}an(t){var e=new Lo(this.clientId,this.allowTabSynchronization,Date.now());return hh(t).put(Lo.key,e)}static bt(){return Zo.bt()}on(t){const e=hh(t);return e.get(Lo.key).next(t=>this.cn(t)?(vr("IndexedDbPersistence","Releasing primary lease."),e.delete(Lo.key)):Jo.resolve())}ln(t,e){var n=Date.now();return!(t<n-e||n<t&&(br(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ze(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.qe=()=>{this.Oe.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Xe()))},this.document.addEventListener("visibilitychange",this.qe),this.inForeground="visible"===this.document.visibilityState)}mn(){this.qe&&(this.document.removeEventListener("visibilitychange",this.qe),this.qe=null)}tn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Ue=()=>{this._n(),s()&&navigator.appVersion.match("Version/14")&&this.Oe.enterRestrictedMode(!0),this.Oe.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Ue))}gn(){this.Ue&&(this.window.removeEventListener("pagehide",this.Ue),this.Ue=null)}wn(t){var e;try{var n=null!==(null===(e=this.Ye)||void 0===e?void 0:e.getItem(this.dn(t)));return vr("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return br("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}_n(){if(this.Ye)try{this.Ye.setItem(this.dn(this.clientId),String(Date.now()))}catch(t){br("Failed to set zombie client id.",t)}}yn(){if(this.Ye)try{this.Ye.removeItem(this.dn(this.clientId))}catch(t){}}dn(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function hh(t){return ha(t,Lo.store)}function uh(t){return ha(t,Go.store)}function ch(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class lh{constructor(t,e){this.progress=t,this.En=e}}class dh{constructor(t,e,n){this.He=t,this.In=e,this.Ht=n}An(e,n){return this.In.getAllMutationBatchesAffectingDocumentKey(e,n).next(t=>this.Rn(e,n,t))}Rn(t,e,n){return this.He.getEntry(t,e).next(t=>{for(const e of n)e.applyToLocalView(t);return t})}bn(t,n){t.forEach((t,e)=>{for(const t of n)t.applyToLocalView(e)})}Pn(e,t){return this.He.getEntries(e,t).next(t=>this.vn(e,t).next(()=>t))}vn(t,e){return this.In.getAllMutationBatchesAffectingDocumentKeys(t,e).next(t=>this.bn(e,t))}getDocumentsMatchingQuery(t,e,n){return r=e,is.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Vn(t,e.path):Hs(e)?this.Sn(t,e,n):this.Dn(t,e,n);var r}Vn(t,e){return this.An(t,new is(e)).next(t=>{let e=qi;return t.isFoundDocument()&&(e=e.insert(t.key,t)),e})}Sn(n,r,s){const i=r.collectionGroup;let o=qi;return this.Ht.getCollectionParents(n,i).next(t=>Jo.forEach(t,t=>{var e,e=(e=r,t=t.child(i),new qs(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt));return this.Dn(n,e,s).next(t=>{t.forEach((t,e)=>{o=o.insert(t,e)})})}).next(()=>o))}Dn(e,n,t){let s,i;return this.He.getDocumentsMatchingQuery(e,n,t).next(t=>(s=t,this.In.getAllMutationBatchesAffectingQuery(e,n))).next(t=>(i=t,this.Cn(e,i,s).next(e=>{s=e;for(const e of i)for(const r of e.mutations){var n=r.key;let t=s.get(n);null==t&&(t=bs.newInvalidDocument(n),s=s.insert(n,t)),Ti(r,t,e.localWriteTime),t.isFoundDocument()||(s=s.remove(n))}}))).next(()=>(s.forEach((t,e)=>{ti(n,e)||(s=s.remove(t))}),s))}Cn(t,e,n){let r=Ki();for(const t of e)for(const e of t.mutations)e instanceof Si&&null===n.get(e.key)&&(r=r.add(e.key));let s=n;return this.He.getEntries(t,r).next(t=>(t.forEach((t,e)=>{e.isFoundDocument()&&(s=s.insert(t,e))}),s))}}class fh{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.Nn=n,this.xn=r}static kn(t,e){let n=Ki(),r=Ki();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new fh(t,e.fromCache,n,r)}}class gh{$n(t){this.On=t}getDocumentsMatchingQuery(e,r,s,i){return 0===(t=r).filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())||s.isEqual(qr.min())?this.Fn(e,r):this.On.Pn(e,i).next(t=>{const n=this.Mn(r,t);return(Ks(r)||$s(r))&&this.Ln(r.limitType,n,i,s)?this.Fn(e,r):(wr()<=l.DEBUG&&vr("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Zs(r)),this.On.getDocumentsMatchingQuery(e,r,s).next(e=>(n.forEach(t=>{e=e.insert(t.key,t)}),e)))});var t}Mn(n,t){let r=new Pi(ei(n));return t.forEach((t,e)=>{ti(n,e)&&(r=r.add(e))}),r}Ln(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Fn(t,e){return wr()<=l.DEBUG&&vr("QueryEngine","Using full collection scan to execute query:",Zs(e)),this.On.getDocumentsMatchingQuery(t,e,qr.min())}}class mh{constructor(t,e,n,r){this.persistence=t,this.Bn=e,this.N=r,this.Un=new Oi(Fr),this.qn=new Ja(t=>Is(t),_s),this.Kn=qr.min(),this.In=t.getMutationQueue(n),this.jn=t.getRemoteDocumentCache(),this.ze=t.getTargetCache(),this.Qn=new dh(this.jn,this.In,this.persistence.getIndexManager()),this.Je=t.getBundleCache(),this.Bn.$n(this.Qn)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Un))}}function ph(t,e,n,r){return new mh(t,e,n,r)}async function yh(t,e){const n=t;let r=n.In,o=n.Qn;t=await n.persistence.runTransaction("Handle user change","readonly",s=>{let i;return n.In.getAllMutationBatches(s).next(t=>(i=t,r=n.persistence.getMutationQueue(e),o=new dh(n.jn,r,n.persistence.getIndexManager()),r.getAllMutationBatches(s))).next(t=>{const e=[],n=[];let r=Ki();for(const s of i){e.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}for(const s of t){n.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}return o.Pn(s,r).next(t=>({Wn:t,removedBatchIds:e,addedBatchIds:n}))})});return n.In=r,n.Qn=o,n.Bn.$n(n.Qn),t}function wh(t){const e=t;return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.ze.getLastRemoteSnapshotVersion(t))}function vh(t,n){const c=t,l=n.snapshotVersion;let d=c.Un;return c.persistence.runTransaction("Apply remote event","readwrite-primary",h=>{const t=c.jn.newChangeBuffer({trackRemovals:!0});d=c.Un;const u=[];n.targetChanges.forEach((t,e)=>{const n=d.get(e);if(n){u.push(c.ze.removeMatchingKeys(h,t.removedDocuments,e).next(()=>c.ze.addMatchingKeys(h,t.addedDocuments,e)));const a=t.resumeToken;var r,s,i,o;0<a.approximateByteSize()&&(r=n.withResumeToken(a,l).withSequenceNumber(h.currentSequenceNumber),d=d.insert(e,r),s=n,o=t,_r(0<(i=r).resumeToken.approximateByteSize()),0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)||u.push(c.ze.updateTargetData(h,r)))}});let e=Ui;if(n.documentUpdates.forEach((t,e)=>{n.resolvedLimboDocuments.has(t)&&u.push(c.persistence.referenceDelegate.updateLimboDocument(h,t))}),u.push(bh(h,t,n.documentUpdates,l,void 0).next(t=>{e=t})),!l.isEqual(qr.min())){const n=c.ze.getLastRemoteSnapshotVersion(h).next(t=>c.ze.setTargetsMetadata(h,h.currentSequenceNumber,l));u.push(n)}return Jo.waitFor(u).next(()=>t.apply(h)).next(()=>c.Qn.vn(h,e)).next(()=>e)}).then(t=>(c.Un=d,t))}function bh(t,o,e,a,h){let n=Ki();return e.forEach(t=>n=n.add(t)),o.getEntries(t,n).next(s=>{let i=Ui;return e.forEach((t,e)=>{const n=s.get(t),r=(null==h?void 0:h.get(t))||a;e.isNoDocument()&&e.version.isEqual(qr.min())?(o.removeEntry(t,r),i=i.insert(t,e)):!n.isValidDocument()||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(o.addEntry(e,r),i=i.insert(t,e)):vr("LocalStore","Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version)}),i})}function Th(t,r){const s=t;return s.persistence.runTransaction("Allocate target","readwrite",e=>{let n;return s.ze.getTargetData(e,r).next(t=>t?(n=t,Jo.resolve(n)):s.ze.allocateTargetId(e).next(t=>(n=new la(r,t,0,e.currentSequenceNumber),s.ze.addTargetData(e,n).next(()=>n))))}).then(t=>{var e=s.Un.get(t.targetId);return(null===e||0<t.snapshotVersion.compareTo(e.snapshotVersion))&&(s.Un=s.Un.insert(t.targetId,t),s.qn.set(r,t.targetId)),t})}async function Eh(t,e,n){const r=t,s=r.Un.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,t=>r.persistence.referenceDelegate.removeTarget(t,s))}catch(t){if(!na(t))throw t;vr("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Un=r.Un.remove(e),r.qn.delete(s.target)}function Ih(t,n,r){const s=t;let i=qr.min(),o=Ki();return s.persistence.runTransaction("Execute query","readonly",e=>function(t,e,n){const r=t,s=r.qn.get(n);return void 0!==s?Jo.resolve(r.Un.get(s)):r.ze.getTargetData(e,n)}(s,e,Ws(n)).next(t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,s.ze.getMatchingKeysForTargetId(e,t.targetId).next(t=>{o=t})}).next(()=>s.Bn.getDocumentsMatchingQuery(e,n,r?i:qr.min(),r?o:Ki())).next(t=>({documents:t,Gn:o})))}function _h(t,e){const n=t,r=n.ze,s=n.Un.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",t=>r.Tt(t,e).next(t=>t?t.target:null))}function Sh(t){const n=t;return n.persistence.runTransaction("Get new document changes","readonly",t=>function(t,e,n){const r=t;let s=Ui,i=ma(n);const o=nh(e),a=IDBKeyRange.lowerBound(i,!0);return o.Kt({index:Uo.readTimeIndex,range:a},(t,e)=>{var n=fa(r.N,e);s=s.insert(n.key,n),i=e.readTime}).next(()=>({En:s,readTime:pa(i)}))}(n.jn,t,n.Kn)).then(({En:t,readTime:e})=>(n.Kn=e,t))}class Nh{constructor(t){this.N=t,this.Yn=new Map,this.Xn=new Map}getBundleMetadata(t,e){return Jo.resolve(this.Yn.get(e))}saveBundleMetadata(t,e){return this.Yn.set(e.id,{id:e.id,version:e.version,createTime:io(e.createTime)}),Jo.resolve()}getNamedQuery(t,e){return Jo.resolve(this.Xn.get(e))}saveNamedQuery(t,e){return this.Xn.set(e.name,{name:(e=e).name,query:Ea(e.bundledQuery),readTime:io(e.readTime)}),Jo.resolve()}}class Ah{constructor(){this.Zn=new Pi(Dh.ts),this.es=new Pi(Dh.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){e=new Dh(t,e);this.Zn=this.Zn.add(e),this.es=this.es.add(e)}ss(t,e){t.forEach(t=>this.addReference(t,e))}removeReference(t,e){this.rs(new Dh(t,e))}os(t,e){t.forEach(t=>this.removeReference(t,e))}cs(t){const e=new is(new Gr([])),n=new Dh(e,t),r=new Dh(e,t+1),s=[];return this.es.forEachInRange([n,r],t=>{this.rs(t),s.push(t.key)}),s}us(){this.Zn.forEach(t=>this.rs(t))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){var e=new is(new Gr([])),n=new Dh(e,t),t=new Dh(e,t+1);let r=Ki();return this.es.forEachInRange([n,t],t=>{r=r.add(t.key)}),r}containsKey(t){var e=new Dh(t,0),e=this.Zn.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)}}class Dh{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return is.comparator(t.key,e.key)||Fr(t.ls,e.ls)}static ns(t,e){return Fr(t.ls,e.ls)||is.comparator(t.key,e.key)}}class Ch{constructor(t,e){this.Ht=t,this.referenceDelegate=e,this.In=[],this.fs=1,this.ds=new Pi(Dh.ts)}checkEmpty(t){return Jo.resolve(0===this.In.length)}addMutationBatch(t,e,n,r){var s=this.fs;this.fs++,0<this.In.length&&this.In[this.In.length-1];n=new ua(s,e,n,r);this.In.push(n);for(const e of r)this.ds=this.ds.add(new Dh(e.key,s)),this.Ht.addToCollectionParentIndex(t,e.key.path.popLast());return Jo.resolve(n)}lookupMutationBatch(t,e){return Jo.resolve(this.ws(e))}getNextMutationBatchAfterBatchId(t,e){e=this._s(e+1),e=e<0?0:e;return Jo.resolve(this.In.length>e?this.In[e]:null)}getHighestUnacknowledgedBatchId(){return Jo.resolve(0===this.In.length?-1:this.fs-1)}getAllMutationBatches(t){return Jo.resolve(this.In.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Dh(e,0),r=new Dh(e,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],t=>{t=this.ws(t.ls);s.push(t)}),Jo.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Pi(Fr);return e.forEach(t=>{var e=new Dh(t,0),t=new Dh(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,t],t=>{n=n.add(t.ls)})}),Jo.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;is.isDocumentKey(s)||(s=s.child(""));e=new Dh(new is(s),0);let i=new Pi(Fr);return this.ds.forEachWhile(t=>{var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(i=i.add(t.ls)),!0)},e),Jo.resolve(this.gs(i))}gs(t){const e=[];return t.forEach(t=>{t=this.ws(t);null!==t&&e.push(t)}),e}removeMutationBatch(n,r){_r(0===this.ys(r.batchId,"removed")),this.In.shift();let s=this.ds;return Jo.forEach(r.mutations,t=>{var e=new Dh(t.key,r.batchId);return s=s.delete(e),this.referenceDelegate.markPotentiallyOrphaned(n,t.key)}).next(()=>{this.ds=s})}te(t){}containsKey(t,e){var n=new Dh(e,0),n=this.ds.firstAfterOrEqual(n);return Jo.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.In.length,Jo.resolve()}ys(t,e){return this._s(t)}_s(t){return 0===this.In.length?0:t-this.In[0].batchId}ws(t){t=this._s(t);return t<0||t>=this.In.length?null:this.In[t]}}class xh{constructor(t,e){this.Ht=t,this.ps=e,this.docs=new Oi(is.comparator),this.size=0}addEntry(t,e,n){const r=e.key,s=this.docs.get(r),i=s?s.size:0,o=this.ps(e);return this.docs=this.docs.insert(r,{document:e.clone(),size:o,readTime:n}),this.size+=o-i,this.Ht.addToCollectionParentIndex(t,r.path.popLast())}removeEntry(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Jo.resolve(n?n.document.clone():bs.newInvalidDocument(e))}getEntries(t,e){let n=Ui;return e.forEach(t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.clone():bs.newInvalidDocument(t))}),Jo.resolve(n)}getDocumentsMatchingQuery(t,e,n){let r=Ui;const s=new is(e.path.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s,readTime:o}}=i.getNext();if(!e.path.isPrefixOf(t.path))break;o.compareTo(n)<=0||ti(e,s)&&(r=r.insert(s.key,s.clone()))}return Jo.resolve(r)}Ts(t,e){return Jo.forEach(this.docs,t=>e(t))}newChangeBuffer(t){return new kh(this)}getSize(t){return Jo.resolve(this.size)}}class kh extends Xa{constructor(t){super(),this.Se=t}applyChanges(n){const r=[];return this.changes.forEach((t,e)=>{e.document.isValidDocument()?r.push(this.Se.addEntry(n,e.document,this.getReadTime(t))):this.Se.removeEntry(t)}),Jo.waitFor(r)}getFromCache(t,e){return this.Se.getEntry(t,e)}getAllFromCache(t,e){return this.Se.getEntries(t,e)}}class Rh{constructor(t){this.persistence=t,this.Es=new Ja(t=>Is(t),_s),this.lastRemoteSnapshotVersion=qr.min(),this.highestTargetId=0,this.Is=0,this.As=new Ah,this.targetCount=0,this.Rs=Ua.se()}forEachTarget(t,n){return this.Es.forEach((t,e)=>n(e)),Jo.resolve()}getLastRemoteSnapshotVersion(t){return Jo.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Jo.resolve(this.Is)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),Jo.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Is&&(this.Is=e),Jo.resolve()}ae(t){this.Es.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.Rs=new Ua(e),this.highestTargetId=e),t.sequenceNumber>this.Is&&(this.Is=t.sequenceNumber)}addTargetData(t,e){return this.ae(e),this.targetCount+=1,Jo.resolve()}updateTargetData(t,e){return this.ae(e),Jo.resolve()}removeTargetData(t,e){return this.Es.delete(e.target),this.As.cs(e.targetId),--this.targetCount,Jo.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.Es.forEach((t,e)=>{e.sequenceNumber<=r&&null===s.get(e.targetId)&&(this.Es.delete(t),o.push(this.removeMatchingKeysForTargetId(n,e.targetId)),i++)}),Jo.waitFor(o).next(()=>i)}getTargetCount(t){return Jo.resolve(this.targetCount)}getTargetData(t,e){e=this.Es.get(e)||null;return Jo.resolve(e)}addMatchingKeys(t,e,n){return this.As.ss(e,n),Jo.resolve()}removeMatchingKeys(e,t,n){this.As.os(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),Jo.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.As.cs(e),Jo.resolve()}getMatchingKeysForTargetId(t,e){e=this.As.hs(e);return Jo.resolve(e)}containsKey(t,e){return Jo.resolve(this.As.containsKey(e))}}class Lh{constructor(t,e){var n;this.bs={},this.Le=new Or(0),this.Be=!1,this.Be=!0,this.referenceDelegate=t(this),this.ze=new Rh(this),this.Ht=new Na,this.He=(n=this.Ht,t=t=>this.referenceDelegate.Ps(t),new xh(n,t)),this.N=new da(e),this.Je=new Nh(this.N)}start(){return Promise.resolve()}shutdown(){return this.Be=!1,Promise.resolve()}get started(){return this.Be}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(){return this.Ht}getMutationQueue(t){let e=this.bs[t.toKey()];return e||(e=new Ch(this.Ht,this.referenceDelegate),this.bs[t.toKey()]=e),e}getTargetCache(){return this.ze}getRemoteDocumentCache(){return this.He}getBundleCache(){return this.Je}runTransaction(t,e,n){vr("MemoryPersistence","Starting transaction:",t);const r=new Oh(this.Le.next());return this.referenceDelegate.vs(),n(r).next(t=>this.referenceDelegate.Vs(r).next(()=>t)).toPromise().then(t=>(r.raiseOnCommittedEvent(),t))}Ss(e,n){return Jo.or(Object.values(this.bs).map(t=>()=>t.containsKey(e,n)))}}class Oh extends Yo{constructor(t){super(),this.currentSequenceNumber=t}}class Mh{constructor(t){this.persistence=t,this.Ds=new Ah,this.Cs=null}static Ns(t){return new Mh(t)}get xs(){if(this.Cs)return this.Cs;throw Ir()}addReference(t,e,n){return this.Ds.addReference(n,e),this.xs.delete(n.toString()),Jo.resolve()}removeReference(t,e,n){return this.Ds.removeReference(n,e),this.xs.add(n.toString()),Jo.resolve()}markPotentiallyOrphaned(t,e){return this.xs.add(e.toString()),Jo.resolve()}removeTarget(t,e){this.Ds.cs(e.targetId).forEach(t=>this.xs.add(t.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(t=>{t.forEach(t=>this.xs.add(t.toString()))}).next(()=>n.removeTargetData(t,e))}vs(){this.Cs=new Set}Vs(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Jo.forEach(this.xs,t=>{const e=is.fromPath(t);return this.ks(n,e).next(t=>{t||r.removeEntry(e)})}).next(()=>(this.Cs=null,r.apply(n)))}updateLimboDocument(t,e){return this.ks(t,e).next(t=>{t?this.xs.delete(e.toString()):this.xs.add(e.toString())})}Ps(t){return 0}ks(t,e){return Jo.or([()=>Jo.resolve(this.Ds.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ss(t,e)])}}function Fh(t,e){return`firestore_clients_${t}_${e}`}function Ph(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function Vh(t,e){return`firestore_targets_${t}_${e}`}class Uh{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static $s(t,e,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Nr(r.error.code,r.error.message))),i?new Uh(t,e,r.state,s):(br("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class qh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static $s(t,e){var n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Nr(n.error.code,n.error.message))),s?new qh(t,n.state,r):(br("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Os(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Bh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static $s(t,e){var n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=$i;for(let t=0;r&&t<n.activeTargetIds.length;++t)r=ss(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new Bh(t,s):(br("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class jh{constructor(t,e){this.clientId=t,this.onlineState=e}static $s(t){var e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new jh(e.clientId,e.onlineState):(br("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Kh{constructor(){this.activeTargetIds=$i}Fs(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ms(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Os(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class $h{constructor(t,e,n,r,s){this.window=t,this.Oe=e,this.persistenceKey=n,this.Ls=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Bs=this.Us.bind(this),this.qs=new Oi(Fr),this.started=!1,this.Ks=[];n=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.js=Fh(this.persistenceKey,this.Ls),this.Qs=`firestore_sequence_number_${this.persistenceKey}`,this.qs=this.qs.insert(this.Ls,new Kh),this.Ws=new RegExp(`^firestore_clients_${n}_([^_]*)$`),this.Gs=new RegExp(`^firestore_mutations_${n}_(\\d+)(?:_(.*))?$`),this.zs=new RegExp(`^firestore_targets_${n}_(\\d+)$`),this.Hs=`firestore_online_state_${this.persistenceKey}`,this.Js=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.Bs)}static bt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.pn();for(const n of t)if(n!==this.Ls){const t=this.getItem(Fh(this.persistenceKey,n));var e;!t||(e=Bh.$s(n,t))&&(this.qs=this.qs.insert(e.clientId,e))}this.Ys();const n=this.storage.getItem(this.Hs);if(n){const t=this.Xs(n);t&&this.Zs(t)}for(const t of this.Ks)this.Us(t);this.Ks=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(t){this.setItem(this.Qs,JSON.stringify(t))}getAllActiveQueryTargets(){return this.ti(this.qs)}isActiveQueryTarget(n){let r=!1;return this.qs.forEach((t,e)=>{e.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(t){this.ei(t,"pending")}updateMutationState(t,e,n){this.ei(t,e,n),this.ni(t)}addLocalQueryTarget(t){let e="not-current";var n;return this.isActiveQueryTarget(t)&&(!(n=this.storage.getItem(Vh(this.persistenceKey,t)))||(n=qh.$s(t,n))&&(e=n.state)),this.si.Fs(t),this.Ys(),e}removeLocalQueryTarget(t){this.si.Ms(t),this.Ys()}isLocalQueryTarget(t){return this.si.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(Vh(this.persistenceKey,t))}updateQueryState(t,e,n){this.ii(t,e,n)}handleUserChange(t,e,n){e.forEach(t=>{this.ni(t)}),this.currentUser=t,n.forEach(t=>{this.addPendingMutation(t)})}setOnlineState(t){this.ri(t)}notifyBundleLoaded(){this.oi()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Bs),this.removeItem(this.js),this.started=!1)}getItem(t){var e=this.storage.getItem(t);return vr("SharedClientState","READ",t,e),e}setItem(t,e){vr("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){vr("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Us(t){const r=t;r.storageArea===this.storage&&(vr("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.js?this.Oe.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Ws.test(r.key)){if(null==r.newValue){var t=this.ai(r.key);return this.ci(t,null)}t=this.ui(r.key,r.newValue);if(t)return this.ci(t.clientId,t)}else if(this.Gs.test(r.key)){if(null!==r.newValue){var e=this.hi(r.key,r.newValue);if(e)return this.li(e)}}else if(this.zs.test(r.key)){if(null!==r.newValue){e=this.fi(r.key,r.newValue);if(e)return this.di(e)}}else if(r.key===this.Hs){if(null!==r.newValue){var n=this.Xs(r.newValue);if(n)return this.Zs(n)}}else if(r.key===this.Qs){n=function(t){let e=Or.T;if(null!=t)try{var n=JSON.parse(t);_r("number"==typeof n),e=n}catch(t){br("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(r.newValue);n!==Or.T&&this.sequenceNumberHandler(n)}else if(r.key===this.Js)return this.syncEngine.wi()}else this.Ks.push(r)}):br("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get si(){return this.qs.get(this.Ls)}Ys(){this.setItem(this.js,this.si.Os())}ei(t,e,n){const r=new Uh(this.currentUser,t,e,n),s=Ph(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Os())}ni(t){t=Ph(this.persistenceKey,this.currentUser,t);this.removeItem(t)}ri(t){t={clientId:this.Ls,onlineState:t};this.storage.setItem(this.Hs,JSON.stringify(t))}ii(t,e,n){const r=Vh(this.persistenceKey,t),s=new qh(t,e,n);this.setItem(r,s.Os())}oi(){this.setItem(this.Js,"value-not-used")}ai(t){t=this.Ws.exec(t);return t?t[1]:null}ui(t,e){t=this.ai(t);return Bh.$s(t,e)}hi(t,e){var n=this.Gs.exec(t),t=Number(n[1]),n=void 0!==n[2]?n[2]:null;return Uh.$s(new mr(n),t,e)}fi(t,e){t=this.zs.exec(t),t=Number(t[1]);return qh.$s(t,e)}Xs(t){return jh.$s(t)}async li(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine._i(t.batchId,t.state,t.error);vr("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}di(t){return this.syncEngine.mi(t.targetId,t.state,t.error)}ci(t,e){const n=e?this.qs.insert(t,e):this.qs.remove(t),r=this.ti(this.qs),s=this.ti(n),i=[],o=[];return s.forEach(t=>{r.has(t)||i.push(t)}),r.forEach(t=>{s.has(t)||o.push(t)}),this.syncEngine.gi(i,o).then(()=>{this.qs=n})}Zs(t){this.qs.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}ti(t){let n=$i;return t.forEach((t,e)=>{n=n.unionWith(e.activeTargetIds)}),n}}class Gh{constructor(){this.yi=new Kh,this.pi={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.yi.Fs(t),this.pi[t]||"not-current"}updateQueryState(t,e,n){this.pi[t]=e}removeLocalQueryTarget(t){this.yi.Ms(t)}isLocalQueryTarget(t){return this.yi.activeTargetIds.has(t)}clearQueryState(t){delete this.pi[t]}getAllActiveQueryTargets(){return this.yi.activeTargetIds}isActiveQueryTarget(t){return this.yi.activeTargetIds.has(t)}start(){return this.yi=new Kh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class zh{Ti(t){}shutdown(){}}class Hh{constructor(){this.Ei=()=>this.Ii(),this.Ai=()=>this.Ri(),this.bi=[],this.Pi()}Ti(t){this.bi.push(t)}shutdown(){window.removeEventListener("online",this.Ei),window.removeEventListener("offline",this.Ai)}Pi(){window.addEventListener("online",this.Ei),window.addEventListener("offline",this.Ai)}Ii(){vr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.bi)t(0)}Ri(){vr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.bi)t(1)}static bt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Qh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Wh{constructor(t){this.vi=t.vi,this.Vi=t.Vi}Si(t){this.Di=t}Ci(t){this.Ni=t}onMessage(t){this.xi=t}close(){this.Vi()}send(t){this.vi(t)}ki(){this.Di()}$i(t){this.Ni(t)}Oi(t){this.xi(t)}}class Yh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.Fi=e+"://"+t.host,this.Mi="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Li(e,t,n,r){const s=this.Bi(e,t);vr("RestConnection","Sending: ",s,n);t={};return this.Ui(t,r),this.qi(e,s,t,n).then(t=>(vr("RestConnection","Received: ",t),t),t=>{throw Tr("RestConnection",`${e} failed with error: `,t,"url: ",s,"request:",n),t})}Ki(t,e,n,r){return this.Li(t,e,n,r)}Ui(t,e){if(t["X-Goog-Api-Client"]="gl-js/ fire/"+pr,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e)for(const n in e.authHeaders)e.authHeaders.hasOwnProperty(n)&&(t[n]=e.authHeaders[n])}Bi(t,e){t=Qh[t];return`${this.Fi}/v1/${e}:${t}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}qi(a,e,n,r){return new Promise((s,i)=>{const o=new gr;o.listenOnce(hr.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case ar.NO_ERROR:var t=o.getResponseJson();vr("Connection","XHR received:",JSON.stringify(t)),s(t);break;case ar.TIMEOUT:vr("Connection",'RPC "'+a+'" timed out'),i(new Nr(Sr.DEADLINE_EXCEEDED,"Request time out"));break;case ar.HTTP_ERROR:var e,n=o.getStatus();if(vr("Connection",'RPC "'+a+'" failed with status:',n,"response text:",o.getResponseText()),0<n){const a=o.getResponseJson().error;a&&a.status&&a.message?(r=a.status.toLowerCase().replace(/_/g,"-"),e=0<=Object.values(Sr).indexOf(r)?r:Sr.UNKNOWN,i(new Nr(e,a.message))):i(new Nr(Sr.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Nr(Sr.UNAVAILABLE,"Connection failed."));break;default:Ir()}}finally{vr("Connection",'RPC "'+a+'" completed.')}var r});var t=JSON.stringify(r);o.send(e,"POST",t,n,15)})}ji(t,e){const n=[this.Fi,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=new tr,s=or(),i={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(i.xmlHttpFactory=new dr({})),this.Ui(i.initMessageHeaders,e),"undefined"!=typeof window&&(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(d())||"object"==typeof navigator&&"ReactNative"===navigator.product||0<=d().indexOf("Electron/")||function(){const t=d();return 0<=t.indexOf("MSIE ")||0<=t.indexOf("Trident/")}()||0<=d().indexOf("MSAppHost/")||"object"==typeof(o="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0)&&void 0!==o.id||(i.httpHeadersOverwriteParam="$httpHeaders");var o=n.join("");vr("Connection","Creating WebChannel: "+o,i);const a=r.createWebChannel(o,i);let h=!1,u=!1;const c=new Wh({vi:t=>{u?vr("Connection","Not sending because WebChannel is closed:",t):(h||(vr("Connection","Opening WebChannel transport."),a.open(),h=!0),vr("Connection","WebChannel sending:",t),a.send(t))},Vi:()=>a.close()}),l=(t,e,n)=>{t.listen(e,t=>{try{n(t)}catch(t){setTimeout(()=>{throw t},0)}})};return l(a,fr.EventType.OPEN,()=>{u||vr("Connection","WebChannel transport opened.")}),l(a,fr.EventType.CLOSE,()=>{u||(u=!0,vr("Connection","WebChannel transport closed"),c.$i())}),l(a,fr.EventType.ERROR,t=>{u||(u=!0,Tr("Connection","WebChannel transport errored:",t),c.$i(new Nr(Sr.UNAVAILABLE,"The operation could not be completed")))}),l(a,fr.EventType.MESSAGE,t=>{if(!u){t=t.data[0];_r(!!t);var n=t.error||(null===(n=t[0])||void 0===n?void 0:n.error);if(n){vr("Connection","WebChannel received error:",n);const r=n.status;let t=function(t){t=ir[t];if(void 0!==t)return Li(t)}(r),e=n.message;void 0===t&&(t=Sr.INTERNAL,e="Unknown error status: "+r+" with message "+n.message),u=!0,c.$i(new Nr(t,e)),a.close()}else vr("Connection","WebChannel received:",t),c.Oi(t)}}),l(s,ur.STAT_EVENT,t=>{t.stat===cr?vr("Connection","Detected buffering proxy"):t.stat===lr&&vr("Connection","Detected no buffering proxy")}),setTimeout(()=>{c.ki()},0),c}}function Jh(){return"undefined"!=typeof window?window:null}function Xh(){return"undefined"!=typeof document?document:null}function Zh(t){return new no(t,!0)}class tu{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Oe=t,this.timerId=e,this.Qi=n,this.Wi=r,this.Gi=s,this.zi=0,this.Hi=null,this.Ji=Date.now(),this.reset()}reset(){this.zi=0}Yi(){this.zi=this.Gi}Xi(t){this.cancel();var e=Math.floor(this.zi+this.Zi()),n=Math.max(0,Date.now()-this.Ji),r=Math.max(0,e-n);0<r&&vr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.zi} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Hi=this.Oe.enqueueAfterDelay(this.timerId,r,()=>(this.Ji=Date.now(),t())),this.zi*=this.Wi,this.zi<this.Qi&&(this.zi=this.Qi),this.zi>this.Gi&&(this.zi=this.Gi)}tr(){null!==this.Hi&&(this.Hi.skipDelay(),this.Hi=null)}cancel(){null!==this.Hi&&(this.Hi.cancel(),this.Hi=null)}Zi(){return(Math.random()-.5)*this.zi}}class eu{constructor(t,e,n,r,s,i){this.Oe=t,this.er=n,this.nr=r,this.credentialsProvider=s,this.listener=i,this.state=0,this.sr=0,this.ir=null,this.stream=null,this.rr=new tu(t,e)}ar(){return 1===this.state||2===this.state||4===this.state}cr(){return 2===this.state}start(){3!==this.state?this.auth():this.ur()}async stop(){this.ar()&&await this.close(0)}hr(){this.state=0,this.rr.reset()}lr(){this.cr()&&null===this.ir&&(this.ir=this.Oe.enqueueAfterDelay(this.er,6e4,()=>this.dr()))}wr(t){this._r(),this.stream.send(t)}async dr(){if(this.cr())return this.close(0)}_r(){this.ir&&(this.ir.cancel(),this.ir=null)}async close(t,e){this._r(),this.rr.cancel(),this.sr++,3!==t?this.rr.reset():e&&e.code===Sr.RESOURCE_EXHAUSTED?(br(e.toString()),br("Using maximum backoff delay to prevent overloading the backend."),this.rr.Yi()):e&&e.code===Sr.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.mr(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Ci(e)}mr(){}auth(){this.state=1;const t=this.gr(this.sr),e=this.sr;this.credentialsProvider.getToken().then(t=>{this.sr===e&&this.yr(t)},e=>{t(()=>{var t=new Nr(Sr.UNKNOWN,"Fetching auth token failed: "+e.message);return this.pr(t)})})}yr(t){const e=this.gr(this.sr);this.stream=this.Tr(t),this.stream.Si(()=>{e(()=>(this.state=2,this.listener.Si()))}),this.stream.Ci(t=>{e(()=>this.pr(t))}),this.stream.onMessage(t=>{e(()=>this.onMessage(t))})}ur(){this.state=4,this.rr.Xi(async()=>{this.state=0,this.start()})}pr(t){return vr("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(3,t)}gr(e){return t=>{this.Oe.enqueueAndForget(()=>this.sr===e?t():(vr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class nu extends eu{constructor(t,e,n,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle",e,n,s),this.N=r}Tr(t){return this.nr.ji("Listen",t)}onMessage(t){this.rr.reset();var e=function(t,e){let n;if("targetChange"in e){e.targetChange;var r="NO_CHANGE"===(i=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===i?1:"REMOVE"===i?2:"CURRENT"===i?3:"RESET"===i?4:Ir(),s=e.targetChange.targetIds||[],i=(o=e.targetChange.resumeToken,t.D?(_r(void 0===o||"string"==typeof o),Wr.fromBase64String(o||"")):(_r(void 0===o||o instanceof Uint8Array),Wr.fromUint8Array(o||new Uint8Array))),o=e.targetChange.cause,a=o&&(o=void 0===(a=o).code?Sr.UNKNOWN:Li(a.code),new Nr(o,a.message||""));n=new Wi(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;var h=e.documentChange;h.document,h.document.name,h.document.updateTime;var i=uo(t,h.document.name),u=io(h.document.updateTime),a=new vs({mapValue:{fields:h.document.fields}}),u=bs.newFoundDocument(i,u,a),a=h.targetIds||[],h=h.removedTargetIds||[];n=new Hi(a,h,u.key,u)}else if("documentDelete"in e){e.documentDelete;h=e.documentDelete;h.document;var u=uo(t,h.document),c=h.readTime?io(h.readTime):qr.min(),c=bs.newNoDocument(u,c),h=h.removedTargetIds||[];n=new Hi([],h,c.key,c)}else if("documentRemove"in e){e.documentRemove;c=e.documentRemove;c.document;var l=uo(t,c.document),c=c.removedTargetIds||[];n=new Hi([],c,l,null)}else{if(!("filter"in e))return Ir();{e.filter;const t=e.filter;t.targetId;l=t.count||0,e=new ki(l),l=t.targetId;n=new Qi(l,e)}}var a,i;return n}(this.N,t),t=function(t){if(!("targetChange"in t))return qr.min();t=t.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?io(t.readTime):qr.min()}(t);return this.listener.Er(e,t)}Ir(t){const e={};e.database=fo(this.N),e.addTarget=function(t,e){let n;var r=e.target;return n=Ss(r)?{documents:vo(t,r)}:{query:bo(t,r)},n.targetId=e.targetId,0<e.resumeToken.approximateByteSize()?n.resumeToken=so(t,e.resumeToken):0<e.snapshotVersion.compareTo(qr.min())&&(n.readTime=ro(t,e.snapshotVersion.toTimestamp())),n}(this.N,t);var n,t=(this.N,n=t,null==(t=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ir()}}())?null:{"goog-listen-tags":t});t&&(e.labels=t),this.wr(e)}Ar(t){const e={};e.database=fo(this.N),e.removeTarget=t,this.wr(e)}}class ru extends eu{constructor(t,e,n,r,s){super(t,"write_stream_connection_backoff","write_stream_idle",e,n,s),this.N=r,this.Rr=!1}get br(){return this.Rr}start(){this.Rr=!1,this.lastStreamToken=void 0,super.start()}mr(){this.Rr&&this.Pr([])}Tr(t){return this.nr.ji("Write",t)}onMessage(t){if(_r(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Rr){this.rr.reset();var e=(n=t.writeResults,r=t.commitTime,n&&0<n.length?(_r(void 0!==r),n.map(t=>function(t,e){let n=t.updateTime?io(t.updateTime):io(e);return n.isEqual(qr.min())&&(n=io(e)),new pi(n,t.transformResults||[])}(t,r))):[]),n=io(t.commitTime);return this.listener.vr(n,e)}var n,r;return _r(!t.writeResults||0===t.writeResults.length),this.Rr=!0,this.listener.Vr()}Sr(){const t={};t.database=fo(this.N),this.wr(t)}Pr(t){t={streamToken:this.lastStreamToken,writes:t.map(t=>yo(this.N,t))};this.wr(t)}}class su extends class{}{constructor(t,e,n){super(),this.credentials=t,this.nr=e,this.N=n,this.Dr=!1}Cr(){if(this.Dr)throw new Nr(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}Li(e,n,r){return this.Cr(),this.credentials.getToken().then(t=>this.nr.Li(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Sr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Nr(Sr.UNKNOWN,t.toString())})}Ki(e,n,r){return this.Cr(),this.credentials.getToken().then(t=>this.nr.Ki(e,n,r,t)).catch(t=>{throw"FirebaseError"===t.name?(t.code===Sr.UNAUTHENTICATED&&this.credentials.invalidateToken(),t):new Nr(Sr.UNKNOWN,t.toString())})}terminate(){this.Dr=!0}}class iu{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.Nr=0,this.kr=null,this.$r=!0}Or(){0===this.Nr&&(this.Fr("Unknown"),this.kr=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.kr=null,this.Mr("Backend didn't respond within 10 seconds."),this.Fr("Offline"),Promise.resolve())))}Lr(t){"Online"===this.state?this.Fr("Unknown"):(this.Nr++,1<=this.Nr&&(this.Br(),this.Mr(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.Fr("Offline")))}set(t){this.Br(),this.Nr=0,"Online"===t&&(this.$r=!1),this.Fr(t)}Fr(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Mr(t){t=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.$r?(br(t),this.$r=!1):vr("OnlineStateTracker",t)}Br(){null!==this.kr&&(this.kr.cancel(),this.kr=null)}}class ou{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Ur=[],this.qr=new Map,this.Kr=new Set,this.jr=[],this.Qr=s,this.Qr.Ti(t=>{n.enqueueAndForget(async()=>{mu(this)&&(vr("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=t;e.Kr.add(4),await hu(e),e.Wr.set("Unknown"),e.Kr.delete(4),await au(e)}(this))})}),this.Wr=new iu(n,r)}}async function au(t){if(mu(t))for(const e of t.jr)await e(!0)}async function hu(t){for(const e of t.jr)await e(!1)}function uu(t,e){const n=t;n.qr.has(e.targetId)||(n.qr.set(e.targetId,e),gu(n)?fu(n):Iu(n).cr()&&lu(n,e))}function cu(t,e){const n=t,r=Iu(n);n.qr.delete(e),r.cr()&&du(n,e),0===n.qr.size&&(r.cr()?r.lr():mu(n)&&n.Wr.set("Unknown"))}function lu(t,e){t.Gr.Y(e.targetId),Iu(t).Ir(e)}function du(t,e){t.Gr.Y(e),Iu(t).Ar(e)}function fu(e){e.Gr=new Ji({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Tt:t=>e.qr.get(t)||null}),Iu(e).start(),e.Wr.Or()}function gu(t){return mu(t)&&!Iu(t).ar()&&0<t.qr.size}function mu(t){return 0===t.Kr.size}function pu(t){t.Gr=void 0}async function yu(t,e,n){if(!na(e))throw e;t.Kr.add(1),await hu(t),t.Wr.set("Offline"),n=n||(()=>wh(t.localStore)),t.asyncQueue.enqueueRetryable(async()=>{vr("RemoteStore","Retrying IndexedDB access"),await n(),t.Kr.delete(1),await au(t)})}function wu(e,n){return n().catch(t=>yu(e,t,n))}async function vu(t){const e=t,n=_u(e);let r=0<e.Ur.length?e.Ur[e.Ur.length-1].batchId:-1;for(;mu(s=e)&&s.Ur.length<10;)try{const t=await function(t,e){const n=t;return n.persistence.runTransaction("Get next mutation batch","readonly",t=>(void 0===e&&(e=-1),n.In.getNextMutationBatchAfterBatchId(t,e)))}(e.localStore,r);if(null===t){0===e.Ur.length&&n.lr();break}r=t.batchId,function(t,e){t.Ur.push(e);const n=_u(t);n.cr()&&n.br&&n.Pr(e.mutations)}(e,t)}catch(t){await yu(e,t)}var s;bu(e)&&Tu(e)}function bu(t){return mu(t)&&!_u(t).ar()&&0<t.Ur.length}function Tu(t){_u(t).start()}async function Eu(t,e){const n=t;e?(n.Kr.delete(2),await au(n)):(n.Kr.add(2),await hu(n),n.Wr.set("Unknown"))}function Iu(e){return e.zr||(e.zr=function(t,e,n){const r=t;return r.Cr(),new nu(e,r.nr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:async function(n){n.qr.forEach((t,e)=>{lu(n,t)})}.bind(null,e),Ci:async function(t,e){pu(t),gu(t)?(t.Wr.Lr(e),fu(t)):t.Wr.set("Unknown")}.bind(null,e),Er:async function(t,r,e){if(t.Wr.set("Online"),r instanceof Wi&&2===r.state&&r.cause)try{await async function(t){var e=r.cause;for(const n of r.targetIds)t.qr.has(n)&&(await t.remoteSyncer.rejectListen(n,e),t.qr.delete(n),t.Gr.removeTarget(n))}(t)}catch(e){vr("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),e),await yu(t,e)}else if(r instanceof Hi?t.Gr.rt(r):r instanceof Qi?t.Gr.ft(r):t.Gr.ct(r),!e.isEqual(qr.min()))try{const r=await wh(t.localStore);0<=e.compareTo(r)&&await function(r,s){const t=r.Gr._t(s);return t.targetChanges.forEach((t,e)=>{if(0<t.resumeToken.approximateByteSize()){const n=r.qr.get(e);n&&r.qr.set(e,n.withResumeToken(t.resumeToken,s))}}),t.targetMismatches.forEach(t=>{const e=r.qr.get(t);e&&(r.qr.set(t,e.withResumeToken(Wr.EMPTY_BYTE_STRING,e.snapshotVersion)),du(r,t),t=new la(e.target,t,1,e.sequenceNumber),lu(r,t))}),r.remoteSyncer.applyRemoteEvent(t)}(t,e)}catch(r){vr("RemoteStore","Failed to raise snapshot:",r),await yu(t,r)}}.bind(null,e)}),e.jr.push(async t=>{t?(e.zr.hr(),gu(e)?fu(e):e.Wr.set("Unknown")):(await e.zr.stop(),pu(e))})),e.zr}function _u(e){return e.Hr||(e.Hr=function(t,e,n){const r=t;return r.Cr(),new ru(e,r.nr,r.credentials,r.N,n)}(e.datastore,e.asyncQueue,{Si:async function(t){_u(t).Sr()}.bind(null,e),Ci:async function(t,e){e&&_u(t).br&&await async function(t,e){if(Ri(n=e.code)&&n!==Sr.ABORTED){const n=t.Ur.shift();_u(t).hr(),await wu(t,()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e)),await vu(t)}var n}(t,e),bu(t)&&Tu(t)}.bind(null,e),Vr:async function(t){const e=_u(t);for(const n of t.Ur)e.Pr(n.mutations)}.bind(null,e),vr:async function(t,e,n){const r=t.Ur.shift(),s=ca.from(r,e,n);await wu(t,()=>t.remoteSyncer.applySuccessfulWrite(s)),await vu(t)}.bind(null,e)}),e.jr.push(async t=>{t?(e.Hr.hr(),await vu(e)):(await e.Hr.stop(),0<e.Ur.length&&(vr("RemoteStore",`Stopping write stream with ${e.Ur.length} pending writes`),e.Ur=[]))})),e.Hr}class Su{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Ar,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(t=>{})}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new Su(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Nr(Sr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Nu(t,e){if(br("AsyncQueue",`${e}: ${t}`),na(t))return new Nr(Sr.UNAVAILABLE,`${e}: ${t}`);throw t}class Au{constructor(n){this.comparator=n?(t,e)=>n(t,e)||is.comparator(t.key,e.key):(t,e)=>is.comparator(t.key,e.key),this.keyedMap=qi,this.sortedSet=new Oi(this.comparator)}static emptySet(t){return new Au(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){t=this.keyedMap.get(t);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((t,e)=>(n(t),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Au))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(t,e){const n=new Au;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Du{constructor(){this.Jr=new Oi(is.comparator)}track(t){var e=t.doc.key,n=this.Jr.get(e);!n||0!==t.type&&3===n.type?this.Jr=this.Jr.insert(e,t):3===t.type&&1!==n.type?this.Jr=this.Jr.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Jr=this.Jr.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Jr=this.Jr.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Jr=this.Jr.remove(e):1===t.type&&2===n.type?this.Jr=this.Jr.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Jr=this.Jr.insert(e,{type:2,doc:t.doc}):Ir()}Yr(){const n=[];return this.Jr.inorderTraversal((t,e)=>{n.push(e)}),n}}class Cu{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach(t=>{s.push({type:0,doc:t})}),new Cu(t,e,Au.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Js(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class xu{constructor(){this.Xr=void 0,this.listeners=[]}}class ku{constructor(){this.queries=new Ja(t=>Xs(t),Js),this.onlineState="Unknown",this.Zr=new Set}}async function Ru(t,e){const n=t,r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new xu),s)try{i.Xr=await n.onListen(r)}catch(t){const n=Nu(t,`Initialization of query '${Zs(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.eo(n.onlineState),!i.Xr||e.no(i.Xr)&&Ou(n)}async function Lu(t,e){const n=t,r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);0<=t&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Ou(t){t.Zr.forEach(t=>{t.next()})}class Mu{constructor(t,e,n){this.query=t,this.so=e,this.io=!1,this.ro=null,this.onlineState="Unknown",this.options=n||{}}no(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Cu(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.io?this.oo(t)&&(this.so.next(t),e=!0):this.ao(t,this.onlineState)&&(this.co(t),e=!0),this.ro=t,e}onError(t){this.so.error(t)}eo(t){this.onlineState=t;let e=!1;return this.ro&&!this.io&&this.ao(this.ro,t)&&(this.co(this.ro),e=!0),e}ao(t,e){return!t.fromCache||!(this.options.uo&&"Offline"!==e||t.docs.isEmpty()&&"Offline"!==e)}oo(t){if(0<t.docChanges.length)return!0;var e=this.ro&&this.ro.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}co(t){t=Cu.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.io=!0,this.so.next(t)}}class Fu{constructor(t,e){this.payload=t,this.byteLength=e}ho(){return"metadata"in this.payload}}class Pu{constructor(t){this.N=t}zn(t){return uo(this.N,t)}Hn(t){return t.metadata.exists?po(this.N,t.document,!1):bs.newNoDocument(this.zn(t.metadata.name),this.Jn(t.metadata.readTime))}Jn(t){return io(t)}}class Vu{constructor(t,e,n){this.lo=t,this.localStore=e,this.N=n,this.queries=[],this.documents=[],this.progress=Uu(t)}fo(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}wo(t){const e=new Map,n=new Pu(this.N);for(const s of t)if(s.metadata.queries){const t=n.zn(s.metadata.name);for(const n of s.metadata.queries){var r=(e.get(n)||Ki()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=t;let i=Ki(),o=Ui,a=Bi;for(const t of n){const n=e.zn(t.metadata.name);t.document&&(i=i.add(n)),o=o.insert(n,e.Hn(t)),a=a.insert(n,e.Jn(t.metadata.readTime))}const h=s.jn.newChangeBuffer({trackRemovals:!0}),u=await Th(s,(r=r,Ws(js(Gr.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>bh(e,h,o,qr.min(),a).next(t=>(h.apply(e),t)).next(t=>s.ze.removeMatchingKeysForTargetId(e,u.targetId).next(()=>s.ze.addMatchingKeys(e,i,u.targetId)).next(()=>s.Qn.vn(e,t)).next(()=>t)))}(this.localStore,new Pu(this.N),this.documents,this.lo.id),e=this.wo(this.documents);for(const t of this.queries)await async function(t,n,r=Ki()){const s=await Th(t,Ws(Ea(n.bundledQuery))),i=t;return i.persistence.runTransaction("Save named query","readwrite",t=>{var e=io(n.readTime);if(0<=s.snapshotVersion.compareTo(e))return i.Je.saveNamedQuery(t,n);e=s.withResumeToken(Wr.EMPTY_BYTE_STRING,e);return i.Un=i.Un.insert(e.targetId,e),i.ze.updateTargetData(t,e).next(()=>i.ze.removeMatchingKeysForTargetId(t,s.targetId)).next(()=>i.ze.addMatchingKeys(t,r,s.targetId)).next(()=>i.Je.saveNamedQuery(t,n))})}(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new lh(Object.assign({},this.progress),t)}}function Uu(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class qu{constructor(t){this.key=t}}class Bu{constructor(t){this.key=t}}class ju{constructor(t,e){this.query=t,this._o=e,this.mo=null,this.current=!1,this.yo=Ki(),this.mutatedKeys=Ki(),this.po=ei(t),this.To=new Au(this.po)}get Eo(){return this._o}Io(t,e){const a=e?e.Ao:new Du,h=(e||this).To;let u=(e||this).mutatedKeys,c=h,l=!1;const d=Ks(this.query)&&h.size===this.query.limit?h.last():null,f=$s(this.query)&&h.size===this.query.limit?h.first():null;if(t.inorderTraversal((t,e)=>{const n=h.get(t),r=ti(this.query,e)?e:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.Ro(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.po(r,d)||f&&this.po(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(u=r?(c=c.add(r),i?u.add(t):u.delete(t)):(c=c.delete(t),u.delete(t)))}),Ks(this.query)||$s(this.query))for(;c.size>this.query.limit;){const t=Ks(this.query)?c.last():c.first();c=c.delete(t.key),u=u.delete(t.key),a.track({type:1,doc:t})}return{To:c,Ao:a,Ln:l,mutatedKeys:u}}Ro(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){var r=this.To;this.To=t.To,this.mutatedKeys=t.mutatedKeys;const s=t.Ao.Yr();s.sort((t,e)=>function(t,e){var n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ir()}};return n(t)-n(e)}(t.type,e.type)||this.po(t.doc,e.doc)),this.bo(n);var i=e?this.Po():[],n=0===this.yo.size&&this.current?1:0,e=n!==this.mo;return this.mo=n,0!==s.length||e?{snapshot:new Cu(this.query,t.To,r,s,t.mutatedKeys,0==n,e,!1),vo:i}:{vo:i}}eo(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({To:this.To,Ao:new Du,mutatedKeys:this.mutatedKeys,Ln:!1},!1)):{vo:[]}}Vo(t){return!this._o.has(t)&&!!this.To.has(t)&&!this.To.get(t).hasLocalMutations}bo(t){t&&(t.addedDocuments.forEach(t=>this._o=this._o.add(t)),t.modifiedDocuments.forEach(t=>{}),t.removedDocuments.forEach(t=>this._o=this._o.delete(t)),this.current=t.current)}Po(){if(!this.current)return[];const e=this.yo;this.yo=Ki(),this.To.forEach(t=>{this.Vo(t.key)&&(this.yo=this.yo.add(t.key))});const n=[];return e.forEach(t=>{this.yo.has(t)||n.push(new Bu(t))}),this.yo.forEach(t=>{e.has(t)||n.push(new qu(t))}),n}So(t){this._o=t.Gn,this.yo=Ki();t=this.Io(t.documents);return this.applyChanges(t,!0)}Do(){return Cu.fromInitialDocuments(this.query,this.To,this.mutatedKeys,0===this.mo)}}class Ku{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class $u{constructor(t){this.key=t,this.Co=!1}}class Gu{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.No={},this.xo=new Ja(t=>Xs(t),Js),this.ko=new Map,this.$o=new Set,this.Oo=new Oi(is.comparator),this.Fo=new Map,this.Mo=new Ah,this.Lo={},this.Bo=new Map,this.Uo=Ua.ie(),this.onlineState="Unknown",this.qo=void 0}get isPrimaryClient(){return!0===this.qo}}async function zu(n,t,e,r){n.Ko=(t,s,e)=>async function(t,e,n){let r=e.view.Io(s);r.Ln&&(r=await Ih(t.localStore,e.query,!1).then(({documents:t})=>e.view.Io(t,r)));n=n&&n.targetChanges.get(e.targetId),n=e.view.applyChanges(r,t.isPrimaryClient,n);return ec(t,e.targetId,n.vo),n.snapshot}(n,t,e);const s=await Ih(n.localStore,t,!0),i=new ju(t,s.Gn),o=i.Io(s.documents),a=zi.createSynthesizedTargetChangeForCurrentChange(e,r&&"Offline"!==n.onlineState),h=i.applyChanges(o,n.isPrimaryClient,a);ec(n,e,h.vo);r=new Ku(t,e,i);return n.xo.set(t,r),n.ko.has(e)?n.ko.get(e).push(t):n.ko.set(e,[t]),h.snapshot}async function Hu(t,e,n){const r=hc(t);try{const t=await function(t,r){const s=t,i=Ur.now(),e=r.reduce((t,e)=>t.add(e.key),Ki());let o;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Qn.Pn(n,e).next(t=>{o=t;const e=[];for(const n of r){const r=function(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=oi(r.transform,t||null);null!=s&&(null==n&&(n=vs.empty()),n.set(r.field,s))}return n||null}(n,o.get(n.key));null!=r&&e.push(new Si(n.key,r,function r(t){const s=[];return jr(t.fields,(t,e)=>{const n=new Hr([t]);if(ys(e)){const t=r(e.mapValue).fields;if(0===t.length)s.push(n);else for(const e of t)s.push(n.child(e))}else s.push(n)}),new Qr(s)}(r.value.mapValue),yi.exists(!0)))}return s.In.addMutationBatch(n,i,e,r)})).then(t=>(t.applyToLocalDocumentSet(o),{batchId:t.batchId,changes:o}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Lo[t.currentUser.toKey()];r=r||new Oi(Fr),r=r.insert(e,n),t.Lo[t.currentUser.toKey()]=r}(r,t.batchId,n),await rc(r,t.changes),await vu(r.remoteStore)}catch(t){const e=Nu(t,"Failed to persist write");n.reject(e)}}async function Qu(t,e){const r=t;try{const t=await vh(r.localStore,e);e.targetChanges.forEach((t,e)=>{const n=r.Fo.get(e);n&&(_r(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),0<t.addedDocuments.size?n.Co=!0:0<t.modifiedDocuments.size?_r(n.Co):0<t.removedDocuments.size&&(_r(n.Co),n.Co=!1))}),await rc(r,t,e)}catch(t){await $a(t)}}function Wu(n,r,t){const e=n;if(e.isPrimaryClient&&0===t||!e.isPrimaryClient&&1===t){const n=[];e.xo.forEach((t,e)=>{e=e.view.eo(r);e.snapshot&&n.push(e.snapshot)}),function(t,n){const e=t;e.onlineState=n;let r=!1;e.queries.forEach((t,e)=>{for(const t of e.listeners)t.eo(n)&&(r=!0)}),r&&Ou(e)}(e.eventManager,r),n.length&&e.No.Er(n),e.onlineState=r,e.isPrimaryClient&&e.sharedClientState.setOnlineState(r)}}async function Yu(t,e){const n=t,r=e.batch.batchId;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",t=>{const e=r.batch.keys(),n=s.jn.newChangeBuffer({trackRemovals:!0});return function(t,e,r,s){const i=r.batch,n=i.keys();let o=Jo.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(e,n)).next(t=>{var e=r.docVersions.get(n);_r(null!==e),t.version.compareTo(e)<0&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&s.addEntry(t,r.commitVersion))})}),o.next(()=>t.In.removeMutationBatch(e,i))}(s,t,r,n).next(()=>n.apply(t)).next(()=>s.In.performConsistencyCheck(t)).next(()=>s.Qn.Pn(t,e))})}(n.localStore,e);Xu(n,r,null),Ju(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await rc(n,t)}catch(t){await $a(t)}}function Ju(t,e){(t.Bo.get(e)||[]).forEach(t=>{t.resolve()}),t.Bo.delete(e)}function Xu(t,e,n){const r=t;let s=r.Lo[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Lo[r.currentUser.toKey()]=s}}function Zu(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.ko.get(t))e.xo.delete(r),n&&e.No.jo(r,n);e.ko.delete(t),e.isPrimaryClient&&e.Mo.cs(t).forEach(t=>{e.Mo.containsKey(t)||tc(e,t)})}function tc(t,e){t.$o.delete(e.path.canonicalString());var n=t.Oo.get(e);null!==n&&(cu(t.remoteStore,n),t.Oo=t.Oo.remove(e),t.Fo.delete(n),nc(t))}function ec(t,e,n){for(const r of n)r instanceof qu?(t.Mo.addReference(r.key,e),function(t,e){const n=e.key,r=n.path.canonicalString();t.Oo.get(n)||t.$o.has(r)||(vr("SyncEngine","New document in limbo: "+n),t.$o.add(r),nc(t))}(t,r)):r instanceof Bu?(vr("SyncEngine","Document no longer in limbo: "+r.key),t.Mo.removeReference(r.key,e),t.Mo.containsKey(r.key)||tc(t,r.key)):Ir()}function nc(t){for(;0<t.$o.size&&t.Oo.size<t.maxConcurrentLimboResolutions;){var e=t.$o.values().next().value;t.$o.delete(e);var n=new is(Gr.fromString(e)),e=t.Uo.next();t.Fo.set(e,new $u(n)),t.Oo=t.Oo.insert(n,e),uu(t.remoteStore,new la(Ws(js(n.path)),e,2,Or.T))}}async function rc(t,n,r){const s=t,i=[],o=[],a=[];s.xo.isEmpty()||(s.xo.forEach((t,e)=>{a.push(s.Ko(e,n,r).then(t=>{t&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(e.targetId,t.fromCache?"not-current":"current"),i.push(t),t=fh.kn(e.targetId,t),o.push(t))}))}),await Promise.all(a),s.No.Er(i),await async function(t,e){const r=t;try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>Jo.forEach(e,e=>Jo.forEach(e.Nn,t=>r.persistence.referenceDelegate.addReference(n,e.targetId,t)).next(()=>Jo.forEach(e.xn,t=>r.persistence.referenceDelegate.removeReference(n,e.targetId,t)))))}catch(t){if(!na(t))throw t;vr("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=r.Un.get(e),n=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(n);r.Un=r.Un.insert(e,s)}}}(s.localStore,o))}async function sc(r,t){const s=r;if(ac(s),hc(s),!0===t&&!0!==s.qo){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await ic(s,r.toArray());s.qo=!0,await Eu(s.remoteStore,!0);for(const r of t)uu(s.remoteStore,r)}else if(!1===t&&!1!==s.qo){const r=[];let n=Promise.resolve();s.ko.forEach((t,e)=>{s.sharedClientState.isLocalQueryTarget(e)?r.push(e):n=n.then(()=>(Zu(s,e),Eh(s.localStore,e,!0))),cu(s.remoteStore,e)}),await n,await ic(s,r),function(){const n=s;n.Fo.forEach((t,e)=>{cu(n.remoteStore,e)}),n.Mo.us(),n.Fo=new Map,n.Oo=new Oi(is.comparator)}(),s.qo=!1,await Eu(s.remoteStore,!1)}}async function ic(e,n){const r=e,s=[],i=[];for(const e of n){let t;const u=r.ko.get(e);if(u&&0!==u.length){t=await Th(r.localStore,Ws(u[0]));for(const e of u){const n=r.xo.get(e),u=(o=r,a=n,h=void 0,o=await Ih((h=o).localStore,a.query,!0),o=a.view.So(o),h.isPrimaryClient&&ec(h,a.targetId,o.vo),await o);u.snapshot&&i.push(u.snapshot)}}else{const u=await _h(r.localStore,e);t=await Th(r.localStore,u),await zu(r,oc(u),e,!1)}s.push(t)}var o,a,h;return r.No.Er(i),s}function oc(t){return Bs(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function ac(t){const e=t;return e.remoteStore.remoteSyncer.applyRemoteEvent=Qu.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(t,e){const n=t,r=n.Fo.get(e);if(r&&r.Co)return Ki().add(r.key);{let t=Ki();const r=n.ko.get(e);if(!r)return t;for(const e of r){const r=n.xo.get(e);t=t.unionWith(r.view.Eo)}return t}}.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=async function(t,e,n){const r=t;r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Fo.get(e),i=s&&s.key;if(i){let t=new Oi(is.comparator);t=t.insert(i,bs.newNoDocument(i,qr.min()));const n=Ki().add(i),s=new Gi(qr.min(),new Map,new Pi(Fr),t,n);await Qu(r,s),r.Oo=r.Oo.remove(i),r.Fo.delete(e),nc(r)}else await Eh(r.localStore,e,!1).then(()=>Zu(r,e,n)).catch($a)}.bind(null,e),e.No.Er=function(t,e){const n=t;let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.no(t)&&(r=!0);s.Xr=t}}r&&Ou(n)}.bind(null,e.eventManager),e.No.jo=function(t,e,n){const r=t,s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}.bind(null,e.eventManager),e}function hc(t){const e=t;return e.remoteStore.remoteSyncer.applySuccessfulWrite=Yu.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=async function(t,e,n){const r=t;try{const t=await function(t,r){const s=t;return s.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return s.In.lookupMutationBatch(e,r).next(t=>(_r(null!==t),n=t.keys(),s.In.removeMutationBatch(e,t))).next(()=>s.In.performConsistencyCheck(e)).next(()=>s.Qn.Pn(e,n))})}(r.localStore,e);Xu(r,e,n),Ju(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await rc(r,t)}catch(n){await $a(n)}}.bind(null,e),e}class uc{constructor(){this.synchronizeTabs=!1}async initialize(t){this.N=Zh(t.databaseInfo.databaseId),this.sharedClientState=this.Wo(t),this.persistence=this.Go(t),await this.persistence.start(),this.gcScheduler=this.zo(t),this.localStore=this.Ho(t)}zo(t){return null}Ho(t){return ph(this.persistence,new gh,t.initialUser,this.N)}Go(t){return new Lh(Mh.Ns,this.N)}Wo(t){return new Gh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class cc extends uc{constructor(t,e,n){super(),this.Jo=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await async function(t){const e=t;return e.persistence.runTransaction("Synchronize last document change read time","readonly",e=>function(){const t=nh(e);let r=qr.min();return t.Kt({index:Uo.readTimeIndex,reverse:!0},(t,e,n)=>{e.readTime&&(r=pa(e.readTime)),n.done()}).next(()=>r)}()).then(t=>{e.Kn=t})}(this.localStore),await this.Jo.initialize(this,t),await hc(this.Jo.syncEngine),await vu(this.Jo.remoteStore),await this.persistence.nn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Ho(t){return ph(this.persistence,new gh,t.initialUser,this.N)}zo(t){var e=this.persistence.referenceDelegate.garbageCollector;return new Ha(e,t.asyncQueue)}Go(t){var e=ch(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?ka.withCacheSize(this.cacheSizeBytes):ka.DEFAULT;return new ah(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Jh(),Xh(),this.N,this.sharedClientState,!!this.forceOwnership)}Wo(t){return new Gh}}class lc extends cc{constructor(t,e){super(t,e,!1),this.Jo=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);t=this.Jo.syncEngine;this.sharedClientState instanceof $h&&(this.sharedClientState.syncEngine={_i:async function(t,e,n,r){var s=t;null!==(t=await function(t,n){const r=t,s=r.In;return r.persistence.runTransaction("Lookup mutation documents","readonly",e=>s.Xt(e,n).next(t=>t?r.Qn.Pn(e,t):Jo.resolve(null)))}(s.localStore,e))?("pending"===n?await vu(s.remoteStore):"acknowledged"===n||"rejected"===n?(Xu(s,e,r||null),Ju(s,e),s.localStore.In.te(e)):Ir(),await rc(s,t)):vr("SyncEngine","Cannot apply mutation batch with id: "+e)}.bind(null,t),mi:async function(t,e,n,r){const s=t;if(s.qo)vr("SyncEngine","Ignoring unexpected query state notification.");else if(s.ko.has(e))switch(n){case"current":case"not-current":{const t=await Sh(s.localStore),r=Gi.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await rc(s,t,r);break}case"rejected":await Eh(s.localStore,e,!0),Zu(s,e,r);break;default:Ir()}}.bind(null,t),gi:async function(t,e,n){const r=ac(t);if(r.qo){for(const t of e)if(r.ko.has(t))vr("SyncEngine","Adding an already active target "+t);else{const e=await _h(r.localStore,t),n=await Th(r.localStore,e);await zu(r,oc(e),n.targetId,!1),uu(r.remoteStore,n)}for(const t of n)r.ko.has(t)&&await Eh(r.localStore,t,!1).then(()=>{cu(r.remoteStore,t),Zu(r,t)}).catch($a)}}.bind(null,t),pn:function(t){return t.localStore.persistence.pn()}.bind(null,t),wi:async function(t){const e=t;return Sh(e.localStore).then(t=>rc(e,t))}.bind(null,t)},await this.sharedClientState.start()),await this.persistence.nn(async t=>{await sc(this.Jo.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())})}Wo(t){var e=Jh();if(!$h.bt(e))throw new Nr(Sr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=ch(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new $h(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class dc{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Wu(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(t,e){const n=t;if(!n.currentUser.isEqual(e)){vr("SyncEngine","User change. New user:",e.toKey());const r=await yh(n.localStore,e);n.currentUser=e,(t=n).Bo.forEach(t=>{t.forEach(t=>{t.reject(new Nr(Sr.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),t.Bo.clear(),n.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),await rc(n,r.Wn)}}.bind(null,this.syncEngine),await Eu(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new ku}createDatastore(t){var e,n=Zh(t.databaseInfo.databaseId),e=(e=t.databaseInfo,new Yh(e));return t=t.credentials,e=e,n=n,new su(t,e,n)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Wu(this.syncEngine,t,0),t=new(Hh.bt()?Hh:zh),new ou(e,n,r,s,t);var e,n,r,s}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Gu(t,e,n,r,s,i);return o&&(a.qo=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=t;vr("RemoteStore","RemoteStore shutting down."),e.Kr.add(5),await hu(e),e.Qr.shutdown(),e.Wr.set("Unknown")}(this.remoteStore)}}function fc(e,n=10240){let r=0;return{async read(){if(r<e.byteLength){var t={value:e.slice(r,r+n),done:!1};return r+=n,t}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class gc{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Yo(this.observer.next,t)}error(t){this.observer.error?this.Yo(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Xo(){this.muted=!0}Yo(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}class mc{constructor(t,e){this.Zo=t,this.N=e,this.metadata=new Ar,this.buffer=new Uint8Array,this.ta=new TextDecoder("utf-8"),this.ea().then(t=>{t&&t.ho()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))},t=>this.metadata.reject(t))}close(){return this.Zo.cancel()}async getMetadata(){return this.metadata.promise}async Qo(){return await this.getMetadata(),this.ea()}async ea(){var t=await this.na();if(null===t)return null;var e=this.ta.decode(t),n=Number(e);isNaN(n)&&this.sa(`length string (${e}) is not valid number`);e=await this.ia(n);return new Fu(JSON.parse(e),t.length+n)}ra(){return this.buffer.findIndex(t=>t==="{".charCodeAt(0))}async na(){for(;this.ra()<0&&!await this.oa(););if(0===this.buffer.length)return null;var t=this.ra();t<0&&this.sa("Reached the end of bundle when a length string is expected.");var e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async ia(t){for(;this.buffer.length<t;)await this.oa()&&this.sa("Reached the end of bundle when more is expected.");var e=this.ta.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}sa(t){throw this.Zo.cancel(),new Error(`Invalid bundle format: ${t}`)}async oa(){var t=await this.Zo.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class pc{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Nr(Sr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const r=t,n=fo(r.N)+"/documents",s={documents:e.map(t=>ho(r.N,t))},i=await r.Ki("BatchGetDocuments",n,s),o=new Map;i.forEach(t=>{const e=(n=r.N,"found"in(t=t)?function(t,e){_r(!!e.found),e.found.name,e.found.updateTime;var n=uo(t,e.found.name),t=io(e.found.updateTime),e=new vs({mapValue:{fields:e.found.fields}});return bs.newFoundDocument(n,t,e)}(n,t):"missing"in t?function(t,e){_r(!!e.missing),_r(!!e.readTime);t=uo(t,e.missing),e=io(e.readTime);return bs.newNoDocument(t,e)}(n,t):Ir());var n;o.set(e.key.toString(),e)});const a=[];return e.forEach(t=>{t=o.get(t.toString());_r(!!t),a.push(t)}),a}(this.datastore,t);return e.forEach(t=>this.recordVersion(t)),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Ci(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,e)=>{e=is.fromPath(e);this.mutations.push(new xi(e,this.precondition(e)))}),await async function(t,e){const n=t,r=fo(n.N)+"/documents",s={writes:e.map(t=>yo(n.N,t))};await n.Li("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ir();e=qr.min()}var n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Nr(Sr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){var e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?yi.updateTime(e):yi.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(this.writtenDocs.has(t.toString())||!e)return yi.exists(!0);if(e.isEqual(qr.min()))throw new Nr(Sr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return yi.updateTime(e)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class yc{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.aa=5,this.rr=new tu(this.asyncQueue,"transaction_retry")}run(){--this.aa,this.ca()}ca(){this.rr.Xi(async()=>{const e=new pc(this.datastore),t=this.ua(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(t=>{this.ha(t)}))}).catch(t=>{this.ha(t)})})}ua(t){try{var e=this.updateFunction(t);return!ns(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}ha(t){0<this.aa&&this.la(t)?(--this.aa,this.asyncQueue.enqueueAndForget(()=>(this.ca(),Promise.resolve()))):this.deferred.reject(t)}la(t){if("FirebaseError"!==t.name)return!1;t=t.code;return"aborted"===t||"failed-precondition"===t||!Ri(t)}}class wc{constructor(t,e,n){this.credentials=t,this.asyncQueue=e,this.databaseInfo=n,this.user=mr.UNAUTHENTICATED,this.clientId=Mr.I(),this.credentialListener=()=>Promise.resolve(),this.credentials.start(e,async t=>{vr("FirestoreClient","Received user=",t.uid),await this.credentialListener(t),this.user=t})}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,credentials:this.credentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.credentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Nr(Sr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Ar;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.credentials.shutdown(),n.resolve()}catch(t){var e=Nu(t,"Failed to shutdown persistence");n.reject(e)}}),n.promise}}async function vc(t,e){t.asyncQueue.verifyOperationInProgress(),vr("FirestoreClient","Initializing OfflineComponentProvider");var n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener(async t=>{r.isEqual(t)||(await yh(e.localStore,t),r=t)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t.offlineComponents=e}async function bc(t,e){t.asyncQueue.verifyOperationInProgress();var n=await Tc(t);vr("FirestoreClient","Initializing OnlineComponentProvider");var r=await t.getConfiguration();await e.initialize(n,r),t.setCredentialChangeListener(t=>async function(t,e){const n=t;n.asyncQueue.verifyOperationInProgress(),vr("RemoteStore","RemoteStore received new credentials");t=mu(n);n.Kr.add(3),await hu(n),t&&n.Wr.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Kr.delete(3),await au(n)}(e.remoteStore,t)),t.onlineComponents=e}async function Tc(t){return t.offlineComponents||(vr("FirestoreClient","Using default OfflineComponentProvider"),await vc(t,new uc)),t.offlineComponents}async function Ec(t){return t.onlineComponents||(vr("FirestoreClient","Using default OnlineComponentProvider"),await bc(t,new dc)),t.onlineComponents}function Ic(t){return Tc(t).then(t=>t.persistence)}function _c(t){return Tc(t).then(t=>t.localStore)}function Sc(t){return Ec(t).then(t=>t.remoteStore)}function Nc(t){return Ec(t).then(t=>t.syncEngine)}async function Ac(t){const e=await Ec(t),n=e.eventManager;return n.onListen=async function(t,e){const n=ac(t);let r,s;const i=n.xo.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Do();else{const t=await Th(n.localStore,Ws(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await zu(n,e,r,"current"===i),n.isPrimaryClient&&uu(n.remoteStore,t)}return s}.bind(null,e.syncEngine),n.onUnlisten=async function(t,e){const n=t,r=n.xo.get(e),s=n.ko.get(r.targetId);if(1<s.length)return n.ko.set(r.targetId,s.filter(t=>!Js(t,e))),void n.xo.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Eh(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),cu(n.remoteStore,r.targetId),Zu(n,r.targetId)}).catch($a)):(Zu(n,r.targetId),await Eh(n.localStore,r.targetId,!0))}.bind(null,e.syncEngine),n}function Dc(t,e,n={}){const r=new Ar;return t.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,o){const t=new gc({next:t=>{r.enqueueAndForget(()=>Lu(n,a));var e=t.docs.has(s);!e&&t.fromCache?o.reject(new Nr(Sr.UNAVAILABLE,"Failed to get document because the client is offline.")):e&&t.fromCache&&i&&"server"===i.source?o.reject(new Nr(Sr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(t)},error:t=>o.reject(t)}),a=new Mu(js(s.path),t,{includeMetadataChanges:!0,uo:!0});return Ru(n,a)}(await Ac(t),t.asyncQueue,e,n,r)),r.promise}function Cc(t,e,n={}){const r=new Ar;return t.asyncQueue.enqueueAndForget(async()=>function(e,n,t,r,s){const i=new gc({next:t=>{n.enqueueAndForget(()=>Lu(e,o)),t.fromCache&&"server"===r.source?s.reject(new Nr(Sr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(t)},error:t=>s.reject(t)}),o=new Mu(t,i,{includeMetadataChanges:!0,uo:!0});return Ru(e,o)}(await Ac(t),t.asyncQueue,e,n,r)),r.promise}function xc(t,e,n,r){const s=function(t,e){t="string"==typeof t?(new TextEncoder).encode(t):t;return t=function(t){if(t instanceof Uint8Array)return fc(t,void 0);if(t instanceof ArrayBuffer)return fc(new Uint8Array(t),void 0);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(t),e=e,new mc(t,e)}(n,Zh(e));t.asyncQueue.enqueueAndForget(async()=>{!function(t,e,n){const r=t;!async function(e,n,r){try{var s=await n.getMetadata();if(await function(t,e){const n=t,r=io(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",t=>n.Je.getBundleMetadata(t,e.id)).then(t=>!!t&&0<=t.createTime.compareTo(r))}(e.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(Uu(s));const o=new Vu(s,e.localStore,n.N);let t=await n.Qo();for(;t;){const e=await o.fo(t);e&&r._updateProgress(e),t=await n.Qo()}var i=await o.complete();await rc(e,i.En,void 0),await function(t,e){const n=t;return n.persistence.runTransaction("Save bundle","readwrite",t=>n.Je.saveBundleMetadata(t,e))}(e.localStore,s),r._completeWith(i.progress)}catch(e){Tr("SyncEngine",`Loading bundle failed with ${e}`),r._failWith(e)}}(r,e,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}(await Nc(t),s,r)})}class kc{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Rc{constructor(t,e){this.projectId=t,this.database=e||"(default)"}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Rc&&t.projectId===this.projectId&&t.database===this.database}}const Lc=new Map;function Oc(t,e,n){if(!n)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Mc(t,e,n,r){if(!0===e&&!0===r)throw new Nr(Sr.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Fc(t){if(!is.isDocumentKey(t))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Pc(t){if(is.isDocumentKey(t))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Vc(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":Ir();if(t instanceof Array)return"an array";t=(t=t).constructor?t.constructor.name:null;return t?`a custom ${t} object`:"an object"}function Uc(t,e){if((t="_delegate"in t?t._delegate:t)instanceof e)return t;if(e.name===t.constructor.name)throw new Nr(Sr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");t=Vc(t);throw new Nr(Sr.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}function qc(t,e){if(e<=0)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Bc{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Nr(Sr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Nr(Sr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Mc("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class jc{constructor(t,e){this._credentials=e,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bc({}),this._settingsFrozen=!1,t instanceof Rc?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Nr(Sr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Rc(t.options.projectId)}(t))}get app(){if(!this._app)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bc(t),void 0!==t.credentials&&(this._credentials=function(t){if(!t)return new Cr;switch(t.type){case"gapi":var e=t.client;return _r(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Lr(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Nr(Sr.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Lc.get(t);e&&(vr("ComponentProvider","Removing Datastore"),Lc.delete(t),e.terminate())}(this),Promise.resolve()}}function Kc(n,t,r,s={}){const i=(n=Uc(n,jc))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&Tr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${r}`,ssl:!1})),s.mockUserToken){let t,e;if("string"==typeof s.mockUserToken)t=s.mockUserToken,e=mr.MOCK_USER;else{t=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=e||"demo-project",r=t.iat||0;if(!(e=t.sub||t.user_id))throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return t=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:e,user_id:e,firebase:{sign_in_provider:"custom",identities:{}}},t),[o(JSON.stringify({alg:"none",type:"JWT"})),o(JSON.stringify(t)),""].join(".")}(s.mockUserToken,null===(r=n._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Nr(Sr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");e=new mr(i)}n._credentials=new xr(new Dr(t,e))}}class $c{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new zc(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new $c(this.firestore,t,this._key)}}class Gc{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Gc(this.firestore,t,this._query)}}class zc extends Gc{constructor(t,e,n){super(t,e,js(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new $c(this.firestore,null,new is(t))}withConverter(t){return new zc(this.firestore,t,this._path)}}function Hc(t,e,...n){if(t=f(t),Oc("collection","path",e),t instanceof jc){var r=Gr.fromString(e,...n);return Pc(r),new zc(t,null,r)}if(!(t instanceof $c||t instanceof zc))throw new Nr(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");n=t._path.child(Gr.fromString(e,...n));return Pc(n),new zc(t.firestore,null,n)}function Qc(t,e,...n){if(t=f(t),Oc("doc","path",e=1===arguments.length?Mr.I():e),t instanceof jc){var r=Gr.fromString(e,...n);return Fc(r),new $c(t,null,new is(r))}if(!(t instanceof $c||t instanceof zc))throw new Nr(Sr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");n=t._path.child(Gr.fromString(e,...n));return Fc(n),new $c(t.firestore,t instanceof zc?t.converter:null,new is(n))}function Wc(t,e){return t=f(t),e=f(e),(t instanceof $c||t instanceof zc)&&(e instanceof $c||e instanceof zc)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Yc(t,e){return t=f(t),e=f(e),t instanceof Gc&&e instanceof Gc&&t.firestore===e.firestore&&Js(t._query,e._query)&&t.converter===e.converter}class Jc{constructor(){this.fa=Promise.resolve(),this.da=[],this.wa=!1,this._a=[],this.ma=null,this.ga=!1,this.ya=!1,this.pa=[],this.rr=new tu(this,"async_queue_retry"),this.Ta=()=>{var t=Xh();t&&vr("AsyncQueue","Visibility state changed to "+t.visibilityState),this.rr.tr()};const t=Xh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Ta)}get isShuttingDown(){return this.wa}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Ea(),this.Ia(t)}enterRestrictedMode(t){if(!this.wa){this.wa=!0,this.ya=t||!1;const e=Xh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Ta)}}enqueue(t){if(this.Ea(),this.wa)return new Promise(()=>{});const e=new Ar;return this.Ia(()=>this.wa&&this.ya?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.da.push(t),this.Aa()))}async Aa(){if(0!==this.da.length){try{await this.da[0](),this.da.shift(),this.rr.reset()}catch(t){if(!na(t))throw t;vr("AsyncQueue","Operation failed with retryable error: "+t)}0<this.da.length&&this.rr.Xi(()=>this.Aa())}}Ia(t){var e=this.fa.then(()=>(this.ga=!0,t().catch(t=>{throw this.ma=t,this.ga=!1,br("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t}).then(t=>(this.ga=!1,t))));return this.fa=e}enqueueAfterDelay(t,e,n){this.Ea(),-1<this.pa.indexOf(t)&&(e=0);n=Su.createAndSchedule(this,t,e,n,t=>this.Ra(t));return this._a.push(n),n}Ea(){this.ma&&Ir()}verifyOperationInProgress(){}async ba(){for(var t;await(t=this.fa),t!==this.fa;);}Pa(t){for(const e of this._a)if(e.timerId===t)return!0;return!1}va(e){return this.ba().then(()=>{this._a.sort((t,e)=>t.targetTimeMs-e.targetTimeMs);for(const t of this._a)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.ba()})}Va(t){this.pa.push(t)}Ra(t){t=this._a.indexOf(t);this._a.splice(t,1)}}function Xc(t){return function(t){if("object"==typeof t&&null!==t){var e=t;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return 1}}(t)}class Zc{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ar,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}var tl,el;class nl extends jc{constructor(t,e){super(t,e),this.type="firestore",this._queue=new Jc,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||sl(this),this._firestoreClient.terminate()}}function rl(t){return t._firestoreClient||sl(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function sl(t){var e,n,r,s=t._freezeSettings(),s=(e=t._databaseId,n=(null===(r=t._app)||void 0===r?void 0:r.options.appId)||"",r=t._persistenceKey,s=s,new kc(e,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams));t._firestoreClient=new wc(t._credentials,t._queue,s)}function il(t,n,r){const s=new Ar;return t.asyncQueue.enqueue(async()=>{try{await vc(t,r),await bc(t,n),s.resolve()}catch(t){if(!("FirebaseError"===(e=t).name?e.code===Sr.FAILED_PRECONDITION||e.code===Sr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}var e}).then(()=>s.promise)}function ol(t){return function(t){const e=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e){const n=t;mu(n.remoteStore)||vr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(){const e=n.localStore;return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.In.getHighestUnacknowledgedBatchId(t))}();if(-1===t)return void e.resolve();const r=n.Bo.get(t)||[];r.push(e),n.Bo.set(t,r)}catch(t){const n=Nu(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Nc(t),e)),e.promise}(rl(t=Uc(t,nl)))}function al(t){return(n=rl(t=Uc(t,nl))).asyncQueue.enqueue(async()=>{const t=await Ic(n),e=await Sc(n);return t.setNetworkEnabled(!0),function(){const t=e;return t.Kr.delete(0),au(t)}()});var n}function hl(t){return(n=rl(t=Uc(t,nl))).asyncQueue.enqueue(async()=>{const t=await Ic(n),e=await Sc(n);return t.setNetworkEnabled(!1),async function(){const t=e;t.Kr.add(0),await hu(t),t.Wr.set("Offline")}()});var n}function ul(e,t){return n=rl(e=Uc(e,nl)),r=t,n.asyncQueue.enqueue(async()=>function(t,e){const n=t;return n.persistence.runTransaction("Get named query","readonly",t=>n.Je.getNamedQuery(t,e))}(await _c(n),r)).then(t=>t?new Gc(e,null,t.query):null);var n,r}function cl(t){if(t._initialized||t._terminated)throw new Nr(Sr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class ll{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Hr(e)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}class dl{constructor(t){this._byteString=t}static fromBase64String(t){try{return new dl(Wr.fromBase64String(t))}catch(t){throw new Nr(Sr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new dl(Wr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class fl{constructor(t){this._methodName=t}}class gl{constructor(t,e){if(!isFinite(t)||t<-90||90<t)throw new Nr(Sr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new Nr(Sr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Fr(this._lat,t._lat)||Fr(this._long,t._long)}}const ml=/^__.*__$/;class pl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Si(t,this.data,this.fieldMask,e,this.fieldTransforms):new _i(t,this.data,e,this.fieldTransforms)}}class yl{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Si(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function wl(t){switch(t){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Ir()}}class vl{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.N=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Sa(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Da(){return this.settings.Da}Ca(t){return new vl(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.N,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Na(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Ca({path:n,xa:!1});return r.ka(t),r}$a(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Ca({path:n,xa:!1});return r.Sa(),r}Oa(t){return this.Ca({path:void 0,xa:!0})}Fa(t){return Ul(t,this.settings.methodName,this.settings.Ma||!1,this.path,this.settings.La)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Sa(){if(this.path)for(let t=0;t<this.path.length;t++)this.ka(this.path.get(t))}ka(t){if(0===t.length)throw this.Fa("Document fields must not be empty");if(wl(this.Da)&&ml.test(t))throw this.Fa('Document fields cannot begin and end with "__"')}}class bl{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.N=n||Zh(t)}Ba(t,e,n,r=!1){return new vl({Da:t,methodName:e,La:n,path:Hr.emptyPath(),xa:!1,Ma:r},this.databaseId,this.N,this.ignoreUndefinedProperties)}}function Tl(t){var e=t._freezeSettings(),n=Zh(t._databaseId);return new bl(t._databaseId,!!e.ignoreUndefinedProperties,n)}function El(t,e,n,r,s,i={}){const o=t.Ba(i.merge||i.mergeFields?2:0,e,n,s);Ml("Data must be an object, but it was:",o,r);r=Ll(r,o);let a,h;if(i.merge)a=new Qr(o.fieldMask),h=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const u of i.mergeFields){const s=Fl(e,u,n);if(!o.contains(s))throw new Nr(Sr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);ql(t,s)||t.push(s)}a=new Qr(t),h=o.fieldTransforms.filter(t=>a.covers(t.field))}else a=null,h=o.fieldTransforms;return new pl(new vs(r),a,h)}class Il extends fl{_toFieldTransform(t){if(2!==t.Da)throw 1===t.Da?t.Fa(`${this._methodName}() can only appear at the top level of your update data`):t.Fa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Il}}function _l(t,e,n){return new vl({Da:3,La:e.settings.La,methodName:t._methodName,xa:n},e.databaseId,e.N,e.ignoreUndefinedProperties)}class Sl extends fl{_toFieldTransform(t){return new mi(t.path,new ai)}isEqual(t){return t instanceof Sl}}class Nl extends fl{constructor(t,e){super(t),this.Ua=e}_toFieldTransform(t){const e=_l(this,t,!0),n=this.Ua.map(t=>Rl(t,e)),r=new hi(n);return new mi(t.path,r)}isEqual(t){return this===t}}class Al extends fl{constructor(t,e){super(t),this.Ua=e}_toFieldTransform(t){const e=_l(this,t,!0),n=this.Ua.map(t=>Rl(t,e)),r=new ci(n);return new mi(t.path,r)}isEqual(t){return this===t}}class Dl extends fl{constructor(t,e){super(t),this.qa=e}_toFieldTransform(t){var e=new di(t.N,si(t.N,this.qa));return new mi(t.path,e)}isEqual(t){return this===t}}function Cl(t,s,i,e){const o=t.Ba(1,s,i);Ml("Data must be an object, but it was:",o,e);const a=[],h=vs.empty();jr(e,(t,e)=>{var n=Vl(s,t,i);e=f(e);t=o.$a(n);if(e instanceof Il)a.push(n);else{const r=Rl(e,t);null!=r&&(a.push(n),h.set(n,r))}});e=new Qr(a);return new yl(h,e,o.fieldTransforms)}function xl(e,n,t,r,s,i){const o=e.Ba(1,n,t),a=[Fl(n,r,t)],h=[s];if(i.length%2!=0)throw new Nr(Sr.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(Fl(n,i[t])),h.push(i[t+1]);const u=[],c=vs.empty();for(let t=a.length-1;0<=t;--t)if(!ql(u,a[t])){const n=a[t];var l=f(l=h[t]);const r=o.$a(n);if(l instanceof Il)u.push(n);else{const e=Rl(l,r);null!=e&&(u.push(n),c.set(n,e))}}s=new Qr(u);return new yl(c,s,o.fieldTransforms)}function kl(t,e,n,r=!1){return Rl(n,t.Ba(r?4:3,e))}function Rl(i,t){if(Ol(i=f(i)))return Ml("Unsupported field value:",t,i),Ll(i,t);if(i instanceof fl)return function(t,e){if(!wl(e.Da))throw e.Fa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Fa(`${t._methodName}() is not currently supported inside arrays`);t=t._toFieldTransform(e);t&&e.fieldTransforms.push(t)}(i,t),null;if(void 0===i&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),i instanceof Array){if(t.settings.xa&&4!==t.Da)throw t.Fa("Nested arrays are not supported");return function(e){const n=[];let r=0;for(const s of i){let t=Rl(s,e.Oa(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t)}return function(t,e){if(null===(t=f(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return si(e.N,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var n=Ur.fromDate(t);return{timestampValue:ro(e.N,n)}}if(t instanceof Ur){n=new Ur(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:ro(e.N,n)}}if(t instanceof gl)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof dl)return{bytesValue:so(e.N,t._byteString)};if(t instanceof $c){const r=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(r))throw e.Fa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:oo(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Fa(`Unsupported field value: ${Vc(t)}`)}(0,t)}function Ll(t,n){const r={};return Kr(t)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):jr(t,(t,e)=>{e=Rl(e,n.Na(t));null!=e&&(r[t]=e)}),{mapValue:{fields:r}}}function Ol(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ur||t instanceof gl||t instanceof dl||t instanceof $c||t instanceof fl)}function Ml(t,e,n){if(!Ol(n)||("object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))){n=Vc(n);throw"an object"===n?e.Fa(t+" a custom object"):e.Fa(t+" "+n)}var r}function Fl(t,e,n){if((e=f(e))instanceof ll)return e._internalPath;if("string"==typeof e)return Vl(t,e);throw Ul("Field path arguments must be of type string or FieldPath.",t,!1,void 0,n)}const Pl=new RegExp("[~\\*/\\[\\]]");function Vl(e,n,r){if(0<=n.search(Pl))throw Ul(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new ll(...n.split("."))._internalPath}catch(t){throw Ul(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function Ul(t,e,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let h="";return(i||o)&&(h+=" (found",i&&(h+=` in field ${r}`),o&&(h+=` in document ${s}`),h+=")"),new Nr(Sr.INVALID_ARGUMENT,a+t+h)}function ql(t,e){return t.some(t=>t.isEqual(e))}class Bl{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new $c(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var t=new jl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){t=this._document.data.field(Kl("DocumentSnapshot.get",t));if(null!==t)return this._userDataWriter.convertValue(t)}}}class jl extends Bl{data(){return super.data()}}function Kl(t,e){return"string"==typeof e?Vl(t,e):(e instanceof ll?e:e._delegate)._internalPath}class $l{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Gl extends Bl{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){var e=new zl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){t=this._document.data.field(Kl("DocumentSnapshot.get",t));if(null!==t)return this._userDataWriter.convertValue(t,e.serverTimestamps)}}}class zl extends Gl{data(t={}){return super.data(t)}}class Hl{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new $l(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,n){this._snapshot.docs.forEach(t=>{e.call(n,new zl(this._firestore,this._userDataWriter,t.key,t,new $l(this._snapshot.mutatedKeys.has(t.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){t=!!t.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Nr(Sr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,e){if(i._snapshot.oldDocs.isEmpty()){let e=0;return i._snapshot.docChanges.map(t=>({type:"added",doc:new zl(i._firestore,i._userDataWriter,t.doc.key,t.doc,new $l(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:e++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(t=>e||3!==t.type).map(t=>{var e=new zl(i._firestore,i._userDataWriter,t.doc.key,t.doc,new $l(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==t.type&&(n=s.indexOf(t.doc.key),s=s.delete(t.doc.key)),1!==t.type&&(s=s.add(t.doc),r=s.indexOf(t.doc.key)),{type:function(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ir()}}(t.type),doc:e,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Ql(t,e){return t instanceof Gl&&e instanceof Gl?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Hl&&e instanceof Hl&&t._firestore===e._firestore&&Yc(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Wl(t){if($s(t)&&0===t.explicitOrderBy.length)throw new Nr(Sr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Yl{}function Jl(t,...e){for(const n of e)t=n._apply(t);return t}class Xl extends Yl{constructor(t,e,n){super(),this.Ka=t,this.ja=e,this.Qa=n,this.type="where"}_apply(t){var e=Tl(t.firestore),e=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on FieldPath.documentId().`);if("in"===i||"not-in"===i){id(o,i);const e=[];for(const n of o)e.push(sd(r,t,n));a={arrayValue:{values:e}}}else a=sd(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||id(o,i),a=kl(n,e,o,"in"===i||"not-in"===i);i=Ns.create(s,i,a);return function(t,e){if(e.v()){const r=zs(t);if(null!==r&&!r.isEqual(e.field))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${e.field.toString()}'`);var n=Gs(t);null!==n&&od(0,e.field,n)}const r=function(t,e){for(const n of t.filters)if(0<=e.indexOf(n.op))return n.op;return null}(t,function(){switch(e.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===e.op?new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${r.toString()}' filters.`)}(t,i),i}(t._query,"where",e,t.firestore._databaseId,this.Ka,this.ja,this.Qa);return new Gc(t.firestore,t.converter,(t=t._query,e=t.filters.concat([e]),new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),e,t.limit,t.limitType,t.startAt,t.endAt)))}}class Zl extends Yl{constructor(t,e){super(),this.Ka=t,this.Wa=e,this.type="orderBy"}_apply(t){var e=function(t,e,n){if(null!==t.startAt)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r=new Ps(e,n);return e=r,null!==Gs(n=t)||null!==(t=zs(n))&&od(0,t,e.field),r}(t._query,this.Ka,this.Wa);return new Gc(t.firestore,t.converter,(t=t._query,e=t.explicitOrderBy.concat([e]),new qs(t.path,t.collectionGroup,e,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)))}}class td extends Yl{constructor(t,e,n){super(),this.type=t,this.Ga=e,this.za=n}_apply(t){return new Gc(t.firestore,t.converter,Ys(t._query,this.Ga,this.za))}}class ed extends Yl{constructor(t,e,n){super(),this.type=t,this.Ha=e,this.Ja=n}_apply(t){var e=rd(t,this.type,this.Ha,this.Ja);return new Gc(t.firestore,t.converter,(t=t._query,e=e,new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class nd extends Yl{constructor(t,e,n){super(),this.type=t,this.Ha=e,this.Ja=n}_apply(t){var e=rd(t,this.type,this.Ha,this.Ja);return new Gc(t.firestore,t.converter,(t=t._query,e=e,new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function rd(t,e,n,r){if(n[0]=f(n[0]),n[0]instanceof Bl)return function(t,e,n,r,s){if(!r)throw new Nr(Sr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Qs(t))if(n.field.isKeyField())i.push(ds(e,r.key));else{const t=r.data.field(n.field);if(ts(t))throw new Nr(Sr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Ms(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);var s=Tl(t.firestore);return function(e,n,r,s,i,t){const o=e.explicitOrderBy;if(i.length>o.length)throw new Nr(Sr.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let t=0;t<i.length;t++){const h=i[t];if(o[t].field.isKeyField()){if("string"!=typeof h)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof h}`);if(!Hs(e)&&-1!==h.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to ${s}() must be a plain document ID, but '${h}' contains a slash.`);const r=e.path.child(Gr.fromString(h));if(!is.isDocumentKey(r))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to ${s}() must result in a valid document path, but '${r}' is not because it contains an odd number of segments.`);const i=new is(r);a.push(ds(n,i))}else{const e=kl(r,s,h);a.push(e)}}return new Ms(a,t)}(t._query,t.firestore._databaseId,s,e,n,r)}function sd(t,e,n){if("string"==typeof(n=f(n))){if(""===n)throw new Nr(Sr.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!Hs(e)&&-1!==n.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);e=e.path.child(Gr.fromString(n));if(!is.isDocumentKey(e))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '${e}' is not because it has an odd number of segments (${e.length}).`);return ds(t,new is(e))}if(n instanceof $c)return ds(t,n._key);throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: ${Vc(n)}.`)}function id(t,e){if(!Array.isArray(t)||0===t.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(10<t.length)throw new Nr(Sr.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function od(t,e,n){if(!n.isEqual(e))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class ad{convertValue(t,e="none"){switch(os(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Xr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Zr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ir()}}convertObject(t,n){const r={};return jr(t.fields,(t,e)=>{r[t]=this.convertValue(e,n)}),r}convertGeoPoint(t){return new gl(Xr(t.latitude),Xr(t.longitude))}convertArray(t,e){return(t.values||[]).map(t=>this.convertValue(t,e))}convertServerTimestamp(t,e){switch(e){case"previous":var n=function t(e){e=e.mapValue.fields.__previous_value__;return ts(e)?t(e):e}(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(es(t));default:return null}}convertTimestamp(t){t=Jr(t);return new Ur(t.seconds,t.nanos)}convertDocumentKey(t,e){const n=Gr.fromString(t);_r(Do(n));const r=new Rc(n.get(1),n.get(3)),s=new is(n.popFirst(5));return r.isEqual(e)||br(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function hd(t,e,n){return t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}class ud extends ad{constructor(t){super(),this.firestore=t}convertBytes(t){return new dl(t)}convertReference(t){t=this.convertDocumentKey(t,this.firestore._databaseId);return new $c(this.firestore,null,t)}}class cd{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Tl(t)}set(t,e,n){this._verifyNotCommitted();const r=ld(t,this._firestore),s=hd(r.converter,e,n),i=El(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,yi.none())),this}update(t,e,n,...r){this._verifyNotCommitted();t=ld(t,this._firestore);let s;return s="string"==typeof(e=f(e))||e instanceof ll?xl(this._dataReader,"WriteBatch.update",t._key,e,n,r):Cl(this._dataReader,"WriteBatch.update",t._key,e),this._mutations.push(s.toMutation(t._key,yi.exists(!0))),this}delete(t){this._verifyNotCommitted();t=ld(t,this._firestore);return this._mutations=this._mutations.concat(new Ci(t._key,yi.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Nr(Sr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function ld(t,e){if((t=f(t)).firestore!==e)throw new Nr(Sr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class dd extends ad{constructor(t){super(),this.firestore=t}convertBytes(t){return new dl(t)}convertReference(t){t=this.convertDocumentKey(t,this.firestore._databaseId);return new $c(this.firestore,null,t)}}function fd(e){e=Uc(e,$c);const n=Uc(e.firestore,nl),t=rl(n),r=new dd(n);return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const r=await function(e){const n=t;return n.persistence.runTransaction("read document","readonly",t=>n.Qn.An(t,e))}(e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new Nr(Sr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){e=Nu(t,`Failed to get document '${e} from cache`);n.reject(e)}}(await _c(t),e,n)),n.promise}(t,e._key).then(t=>new Gl(n,r,e._key,t,new $l(null!==t&&t.hasLocalMutations,!0),e.converter))}function gd(e){e=Uc(e,Gc);const n=Uc(e.firestore,nl),t=rl(n),r=new dd(n);return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const r=await Ih(t,e,!0),s=new ju(e,r.Gn),i=s.Io(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){e=Nu(t,`Failed to execute query '${e} against cache`);n.reject(e)}}(await _c(t),e,n)),n.promise}(t,e._query).then(t=>new Hl(n,r,e,t))}function md(t,e,n){t=Uc(t,$c);var r=Uc(t.firestore,nl),e=hd(t.converter,e,n);return vd(r,[El(Tl(r),"setDoc",t._key,e,null!==t.converter,n).toMutation(t._key,yi.none())])}function pd(t,e,n,...r){t=Uc(t,$c);var s=Uc(t.firestore,nl),i=Tl(s);let o;return o="string"==typeof(e=f(e))||e instanceof ll?xl(i,"updateDoc",t._key,e,n,r):Cl(i,"updateDoc",t._key,e),vd(s,[o.toMutation(t._key,yi.exists(!0))])}function yd(e,...n){var t;e=f(e);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||Xc(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(Xc(n[s])){const e=n[s];n[s]=null===(t=e.next)||void 0===t?void 0:t.bind(e),n[s+1]=null===(t=e.error)||void 0===t?void 0:t.bind(e),n[s+2]=null===(t=e.complete)||void 0===t?void 0:t.bind(e)}let o,a,h;if(e instanceof $c)a=Uc(e.firestore,nl),h=js(e._key.path),o={next:t=>{n[s]&&n[s](bd(a,e,t))},error:n[s+1],complete:n[s+2]};else{const u=Uc(e,Gc);a=Uc(u.firestore,nl),h=u._query;const c=new dd(a);o={next:t=>{n[s]&&n[s](new Hl(a,c,u,t))},error:n[s+1],complete:n[s+2]},Wl(e._query)}return function(t,e,n,r){const s=new gc(r),i=new Mu(e,s,n);return t.asyncQueue.enqueueAndForget(async()=>Ru(await Ac(t),i)),()=>{s.Xo(),t.asyncQueue.enqueueAndForget(async()=>Lu(await Ac(t),i))}}(rl(a),h,i,o)}function wd(t,e){return function(t,e){const n=new gc(e);return t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.Zr.add(e),e.next()}(await Ac(t),n)),()=>{n.Xo(),t.asyncQueue.enqueueAndForget(async()=>function(t,e){t.Zr.delete(e)}(await Ac(t),n))}}(rl(t=Uc(t,nl)),Xc(e)?e:{next:e})}function vd(t,e){return function(t,e){const n=new Ar;return t.asyncQueue.enqueueAndForget(async()=>Hu(await Nc(t),e,n)),n.promise}(rl(t),e)}function bd(t,e,n){var r=n.docs.get(e._key),s=new dd(t);return new Gl(t,s,e._key,r,new $l(n.hasPendingWrites,n.fromCache),e.converter)}class Td extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Tl(t)}get(t){const n=ld(t,this._firestore),r=new ud(this._firestore);return this._transaction.lookup([n._key]).then(t=>{if(!t||1!==t.length)return Ir();const e=t[0];if(e.isFoundDocument())return new Bl(this._firestore,r,e.key,e,n.converter);if(e.isNoDocument())return new Bl(this._firestore,r,n._key,null,n.converter);throw Ir()})}set(t,e,n){t=ld(t,this._firestore),e=hd(t.converter,e,n),n=El(this._dataReader,"Transaction.set",t._key,e,null!==t.converter,n);return this._transaction.set(t._key,n),this}update(t,e,n,...r){t=ld(t,this._firestore),e="string"==typeof(e=f(e))||e instanceof ll?xl(this._dataReader,"Transaction.update",t._key,e,n,r):Cl(this._dataReader,"Transaction.update",t._key,e);return this._transaction.update(t._key,e),this}delete(t){t=ld(t,this._firestore);return this._transaction.delete(t._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=ld(t,this._firestore),n=new dd(this._firestore);return super.get(t).then(t=>new Gl(this._firestore,n,e._key,t._document,new $l(!1,!1),e.converter))}}function Ed(e,n){return function(e,n){const r=new Ar;return e.asyncQueue.enqueueAndForget(async()=>{var t=await Ec(e).then(t=>t.datastore);new yc(e.asyncQueue,t,n,r).run()}),r.promise}(rl(e),t=>n(new Td(e,t)))}re=Wd.SDK_VERSION,pr=re,Wd._registerComponent(new i("firestore",(t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new nl(n,new kr(t.getProvider("auth-internal")));return e=Object.assign({useFetchStreams:!0},e),r._setSettings(e),r},"PUBLIC")),Wd.registerVersion("@firebase/firestore","3.1.0",void 0);function Id(t,e){if(void 0===e)return{merge:!1};if(void 0!==e.mergeFields&&void 0!==e.merge)throw new Nr("invalid-argument",`Invalid options passed to function ${t}(): You cannot `+'specify both "merge" and "mergeFields".');return e}function _d(){if("undefined"==typeof Uint8Array)throw new Nr("unimplemented","Uint8Arrays are not available in this environment.")}function Sd(){if("undefined"==typeof atob)throw new Nr("unimplemented","Blobs are unavailable in Firestore in this environment.")}class Nd{constructor(t){this._delegate=t}static fromBase64String(t){return Sd(),new Nd(dl.fromBase64String(t))}static fromUint8Array(t){return _d(),new Nd(dl.fromUint8Array(t))}toBase64(){return Sd(),this._delegate.toBase64()}toUint8Array(){return _d(),this._delegate.toUint8Array()}isEqual(t){return this._delegate.isEqual(t._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function Ad(t){return function(t,e){if("object"!=typeof t||null===t)return;var n=t;for(const r of e)if(r in n&&"function"==typeof n[r])return 1;return}(t,["next","error","complete"])}class Dd{enableIndexedDbPersistence(t,e){return function(t,e){cl(t=Uc(t,nl));var n=rl(t),r=t._freezeSettings(),t=new dc;return il(n,t,new cc(t,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}(t._delegate,{forceOwnership:e})}enableMultiTabIndexedDbPersistence(t){return function(t){cl(t=Uc(t,nl));var e=rl(t),n=t._freezeSettings(),t=new dc;return il(e,t,new lc(t,n.cacheSizeBytes))}(t._delegate)}clearIndexedDbPersistence(t){return function(t){if(t._initialized&&!t._terminated)throw new Nr(Sr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ar;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(t){if(!Zo.bt())return Promise.resolve();t+="main";await Zo.delete(t)}(ch(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}}),e.promise}(t._delegate)}}class Cd{constructor(t,e,n){this._delegate=e,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},t instanceof Rc||(this._appCompat=t)}get _databaseId(){return this._delegate._databaseId}settings(t){var e=this._delegate._getSettings();t.merge||e.host===t.host||Tr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),t.merge&&delete(t=Object.assign(Object.assign({},e),t)).merge,this._delegate._setSettings(t)}useEmulator(t,e,n={}){Kc(this._delegate,t,e,n)}enableNetwork(){return al(this._delegate)}disableNetwork(){return hl(this._delegate)}enablePersistence(t){let e=!1,n=!1;return t&&(e=!!t.synchronizeTabs,n=!!t.experimentalForceOwningTab,Mc("synchronizeTabs",e,"experimentalForceOwningTab",n)),e?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return ol(this._delegate)}onSnapshotsInSync(t){return wd(this._delegate,t)}get app(){if(!this._appCompat)throw new Nr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(t){try{return new Kd(this,Hc(this._delegate,t))}catch(t){throw Md(t,"collection()","Firestore.collection()")}}doc(t){try{return new Od(this,Qc(this._delegate,t))}catch(t){throw Md(t,"doc()","Firestore.doc()")}}collectionGroup(t){try{return new qd(this,function(t,e){if(t=Uc(t,jc),Oc("collectionGroup","collection id",e),0<=e.indexOf("/"))throw new Nr(Sr.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Gc(t,null,(e=e,new qs(Gr.emptyPath(),e)))}(this._delegate,t))}catch(t){throw Md(t,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return Ed(this._delegate,t=>e(new kd(this,t)))}batch(){return rl(this._delegate),new Rd(new cd(this._delegate,t=>vd(this._delegate,t)))}loadBundle(t){return e=this._delegate,n=t,r=rl(e=Uc(e,nl)),t=new Zc,xc(r,e._databaseId,n,t),t;var e,n,r}namedQuery(t){return ul(this._delegate,t).then(t=>t?new qd(this,t):null)}}class xd extends ad{constructor(t){super(),this.firestore=t}convertBytes(t){return new Nd(new dl(t))}convertReference(t){t=this.convertDocumentKey(t,this.firestore._databaseId);return Od.forKey(t,this.firestore,null)}}class kd{constructor(t,e){this._firestore=t,this._delegate=e,this._userDataWriter=new xd(t)}get(t){const e=$d(t);return this._delegate.get(e).then(t=>new Vd(this._firestore,new Gl(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,e.converter)))}set(t,e,n){t=$d(t);return n?(Id("Transaction.set",n),this._delegate.set(t,e,n)):this._delegate.set(t,e),this}update(t,e,n,...r){t=$d(t);return 2===arguments.length?this._delegate.update(t,e):this._delegate.update(t,e,n,...r),this}delete(t){t=$d(t);return this._delegate.delete(t),this}}class Rd{constructor(t){this._delegate=t}set(t,e,n){t=$d(t);return n?(Id("WriteBatch.set",n),this._delegate.set(t,e,n)):this._delegate.set(t,e),this}update(t,e,n,...r){t=$d(t);return 2===arguments.length?this._delegate.update(t,e):this._delegate.update(t,e,n,...r),this}delete(t){t=$d(t);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class Ld{constructor(t,e,n){this._firestore=t,this._userDataWriter=e,this._delegate=n}fromFirestore(t,e){t=new zl(this._firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,null);return this._delegate.fromFirestore(new Ud(this._firestore,t),null!=e?e:{})}toFirestore(t,e){return e?this._delegate.toFirestore(t,e):this._delegate.toFirestore(t)}static getInstance(t,e){const n=Ld.INSTANCES;let r=n.get(t);r||(r=new WeakMap,n.set(t,r));let s=r.get(e);return s||(s=new Ld(t,new xd(t),e),r.set(e,s)),s}}Ld.INSTANCES=new WeakMap;class Od{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new xd(t)}static forPath(t,e,n){if(t.length%2!=0)throw new Nr("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+`${t.canonicalString()} has ${t.length}`);return new Od(e,new $c(e._delegate,n,new is(t)))}static forKey(t,e,n){return new Od(e,new $c(e._delegate,n,t))}get id(){return this._delegate.id}get parent(){return new Kd(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(t){try{return new Kd(this.firestore,Hc(this._delegate,t))}catch(t){throw Md(t,"collection()","DocumentReference.collection()")}}isEqual(t){return(t=f(t))instanceof $c&&Wc(this._delegate,t)}set(t,e){e=Id("DocumentReference.set",e);try{return e?md(this._delegate,t,e):md(this._delegate,t)}catch(t){throw Md(t,"setDoc()","DocumentReference.set()")}}update(t,e,...n){try{return 1===arguments.length?pd(this._delegate,t):pd(this._delegate,t,e,...n)}catch(t){throw Md(t,"updateDoc()","DocumentReference.update()")}}delete(){return vd(Uc((t=this._delegate).firestore,nl),[new Ci(t._key,yi.none())]);var t}onSnapshot(...t){var e=Fd(t),t=Pd(t,t=>new Vd(this.firestore,new Gl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)));return yd(this._delegate,e,t)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?fd:"server"===(null==t?void 0:t.source)?function(e){e=Uc(e,$c);const n=Uc(e.firestore,nl);return Dc(rl(n),e._key,{source:"server"}).then(t=>bd(n,e,t))}:function(e){e=Uc(e,$c);const n=Uc(e.firestore,nl);return Dc(rl(n),e._key).then(t=>bd(n,e,t))})(this._delegate),e.then(t=>new Vd(this.firestore,new Gl(this.firestore._delegate,this._userDataWriter,t._key,t._document,t.metadata,this._delegate.converter)))}withConverter(t){return new Od(this.firestore,t?this._delegate.withConverter(Ld.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function Md(t,e,n){return t.message=t.message.replace(e,n),t}function Fd(t){for(const e of t)if("object"==typeof e&&!Ad(e))return e;return{}}function Pd(t,e){let n;return n=Ad(t[0])?t[0]:Ad(t[1])?t[1]:"function"==typeof t[0]?{next:t[0],error:t[1],complete:t[2]}:{next:t[1],error:t[2],complete:t[3]},{next:t=>{n.next&&n.next(e(t))},error:null===(t=n.error)||void 0===t?void 0:t.bind(n),complete:null===(t=n.complete)||void 0===t?void 0:t.bind(n)}}class Vd{constructor(t,e){this._firestore=t,this._delegate=e}get ref(){return new Od(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(t){return this._delegate.data(t)}get(t,e){return this._delegate.get(t,e)}isEqual(t){return Ql(this._delegate,t._delegate)}}class Ud extends Vd{data(t){t=this._delegate.data(t);return void 0!==t||Ir(),t}}class qd{constructor(t,e){this.firestore=t,this._delegate=e,this._userDataWriter=new xd(t)}where(t,e,n){try{return new qd(this.firestore,Jl(this._delegate,(s=e,i=n,r=Kl("where",r=t),new Xl(r,s,i))))}catch(t){throw Md(t,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(t,e){try{return new qd(this.firestore,Jl(this._delegate,([n,r="asc"]=[t,e],n=Kl("orderBy",n),new Zl(n,r))))}catch(t){throw Md(t,/(orderBy|where)\(\)/,"Query.$1()")}var n,r}limit(t){try{return new qd(this.firestore,Jl(this._delegate,(qc("limit",e=t),new td("limit",e,"F"))))}catch(t){throw Md(t,"limit()","Query.limit()")}var e}limitToLast(t){try{return new qd(this.firestore,Jl(this._delegate,(qc("limitToLast",e=t),new td("limitToLast",e,"L"))))}catch(t){throw Md(t,"limitToLast()","Query.limitToLast()")}var e}startAt(...t){try{return new qd(this.firestore,Jl(this._delegate,function(...t){return new ed("startAt",t,!0)}(...t)))}catch(t){throw Md(t,"startAt()","Query.startAt()")}}startAfter(...t){try{return new qd(this.firestore,Jl(this._delegate,function(...t){return new ed("startAfter",t,!1)}(...t)))}catch(t){throw Md(t,"startAfter()","Query.startAfter()")}}endBefore(...t){try{return new qd(this.firestore,Jl(this._delegate,function(...t){return new nd("endBefore",t,!0)}(...t)))}catch(t){throw Md(t,"endBefore()","Query.endBefore()")}}endAt(...t){try{return new qd(this.firestore,Jl(this._delegate,function(...t){return new nd("endAt",t,!1)}(...t)))}catch(t){throw Md(t,"endAt()","Query.endAt()")}}isEqual(t){return Yc(this._delegate,t._delegate)}get(t){let e;return e=("cache"===(null==t?void 0:t.source)?gd:"server"===(null==t?void 0:t.source)?function(e){e=Uc(e,Gc);const n=Uc(e.firestore,nl),t=rl(n),r=new dd(n);return Cc(t,e._query,{source:"server"}).then(t=>new Hl(n,r,e,t))}:function(e){e=Uc(e,Gc);const n=Uc(e.firestore,nl),t=rl(n),r=new dd(n);return Wl(e._query),Cc(t,e._query).then(t=>new Hl(n,r,e,t))})(this._delegate),e.then(t=>new jd(this.firestore,new Hl(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)))}onSnapshot(...t){var e=Fd(t),t=Pd(t,t=>new jd(this.firestore,new Hl(this.firestore._delegate,this._userDataWriter,this._delegate,t._snapshot)));return yd(this._delegate,e,t)}withConverter(t){return new qd(this.firestore,t?this._delegate.withConverter(Ld.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}class Bd{constructor(t,e){this._firestore=t,this._delegate=e}get type(){return this._delegate.type}get doc(){return new Ud(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class jd{constructor(t,e){this._firestore=t,this._delegate=e}get query(){return new qd(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(t=>new Ud(this._firestore,t))}docChanges(t){return this._delegate.docChanges(t).map(t=>new Bd(this._firestore,t))}forEach(e,n){this._delegate.forEach(t=>{e.call(n,new Ud(this._firestore,t))})}isEqual(t){return Ql(this._delegate,t._delegate)}}class Kd extends qd{constructor(t,e){super(t,e),this.firestore=t,this._delegate=e}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var t=this._delegate.parent;return t?new Od(this.firestore,t):null}doc(t){try{return void 0===t?new Od(this.firestore,Qc(this._delegate)):new Od(this.firestore,Qc(this._delegate,t))}catch(t){throw Md(t,"doc()","CollectionReference.doc()")}}add(t){return function(t,e){const n=Uc(t.firestore,nl),r=Qc(t),s=hd(t.converter,e);return vd(n,[El(Tl(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,yi.exists(!1))]).then(()=>r)}(this._delegate,t).then(t=>new Od(this.firestore,t))}isEqual(t){return Wc(this._delegate,t._delegate)}withConverter(t){return new Kd(this.firestore,t?this._delegate.withConverter(Ld.getInstance(this.firestore,t)):this._delegate.withConverter(null))}}function $d(t){return Uc(t,$c)}const Gd={Firestore:Cd,GeoPoint:gl,Timestamp:Ur,Blob:Nd,Transaction:kd,WriteBatch:Rd,DocumentReference:Od,DocumentSnapshot:Vd,Query:qd,QueryDocumentSnapshot:Ud,QuerySnapshot:jd,CollectionReference:Kd,FieldPath:class zd{constructor(...t){this._delegate=new ll(...t)}static documentId(){return new zd(Hr.keyField().canonicalString())}isEqual(t){return(t=f(t))instanceof ll&&this._delegate._internalPath.isEqual(t._internalPath)}},FieldValue:class Hd{constructor(t){this._delegate=t}static serverTimestamp(){const t=new Sl("serverTimestamp");return t._methodName="FieldValue.serverTimestamp",new Hd(t)}static delete(){const t=new Il("deleteField");return t._methodName="FieldValue.delete",new Hd(t)}static arrayUnion(...t){const e=function(...t){return new Nl("arrayUnion",t)}(...t);return e._methodName="FieldValue.arrayUnion",new Hd(e)}static arrayRemove(...t){const e=function(...t){return new Al("arrayRemove",t)}(...t);return e._methodName="FieldValue.arrayRemove",new Hd(e)}static increment(t){const e=new Dl("increment",t);return e._methodName="FieldValue.increment",new Hd(e)}isEqual(t){return this._delegate.isEqual(t._delegate)}},setLogLevel:function(t){t=t,yr.setLogLevel(t)},CACHE_SIZE_UNLIMITED:-1};tl=e.default,el=(t,e)=>new Cd(t,e,new Dd),tl.INTERNAL.registerComponent(new i("firestore-compat",t=>{var e=t.getProvider("app-compat").getImmediate(),t=t.getProvider("firestore").getImmediate();return el(e,t)},"PUBLIC").setServiceProps(Object.assign({},Gd))),tl.registerVersion("@firebase/firestore-compat","0.1.3")}.apply(this,arguments)}catch(t){throw console.error(t),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});
//# sourceMappingURL=firebase-firestore-compat.js.map
